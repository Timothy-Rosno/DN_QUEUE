# Database Backup and Restore Guide

This document explains how database backups work and how to restore from a backup in case of data loss or corruption.

## Overview

The application uses **SQLite on Render's persistent disk** for zero-cost database storage. Backups are automatically created weekly and stored in GitHub.

### Backup Strategy

1. **Production Database**: SQLite file stored at `/opt/render/project/data/db.sqlite3` on Render
2. **Automated Backups**: GitHub Actions exports full database weekly (Sundays at midnight UTC)
3. **Manual Backups**: Admins can export database anytime via the Database Management page
4. **Storage**: Backups stored in `database-backups` branch, keeping last 8 weeks (2 months)

## Architecture

### Database Location

- **Local Development**: `db.sqlite3` in project root
- **Render Production**: `/opt/render/project/data/db.sqlite3` (persistent disk)

### Backup Contents

Full database backups include:
- **Users** (auth.User)
- **User Profiles** (userRegistration.UserProfile)
- **Machines** (calendarEditor.Machine)
- **Queue Presets** (calendarEditor.QueuePreset)
- **Queue Entries** (calendarEditor.QueueEntry)
- **Archived Measurements** (calendarEditor.ArchivedMeasurement)
- **Notification Preferences** (calendarEditor.NotificationPreference)
- **Notifications** (calendarEditor.Notification)

## Automated Backups (GitHub Actions)

### Configuration

- **Workflow File**: `.github/workflows/backup-database.yml`
- **Schedule**: Every Sunday at 00:00 UTC
- **API Endpoint**: `https://qhog.onrender.com/schedule/api/backup/database/`
- **Authentication**: Uses `BACKUP_API_KEY` secret in GitHub repository settings
- **Storage Branch**: `database-backups`
- **Retention**: Last 8 weekly backups (auto-cleanup)

### Setup Instructions

1. **Get Backup API Key from Render**:
   - Log into Render dashboard
   - Go to `qhog` web service â†’ Environment
   - Copy the `BACKUP_API_KEY` value (auto-generated by Render)

2. **Add Secret to GitHub**:
   - Go to GitHub repository â†’ Settings â†’ Secrets and variables â†’ Actions
   - Click "New repository secret"
   - Name: `BACKUP_API_KEY`
   - Value: (paste key from Render)
   - Click "Add secret"

3. **Verify Workflow**:
   - Go to Actions tab in GitHub
   - Find "Backup Database" workflow
   - Click "Run workflow" to test manually
   - Check `database-backups` branch for backup file

## Manual Backups

### Via Web Interface (Recommended)

1. Log in as admin/staff user
2. Go to Admin Dashboard â†’ "Manage Storage"
3. Click "Export Complete Database" button
4. Save the downloaded JSON file safely

### Via API (For Automation)

```bash
curl -H "Authorization: Bearer YOUR_BACKUP_API_KEY" \
  https://qhog.onrender.com/schedule/api/backup/database/ \
  -o database_backup_$(date +%Y-%m-%d).json
```

## Restoring from Backup

### Prerequisites

- Admin access to Render dashboard or Django admin
- Backup JSON file (from GitHub or manual export)
- **WARNING**: Restore will replace ALL existing data

### Method 1: Using Django Management Command (Recommended)

1. **Access Render Shell**:
   ```bash
   # Via Render dashboard: Service â†’ Shell tab
   # Or use Render CLI:
   render shell qhog
   ```

2. **Upload backup file**:
   ```bash
   # Create temporary directory
   mkdir -p /tmp/restore

   # Copy your backup file to /tmp/restore/backup.json
   # (Use Render dashboard file upload or scp)
   ```

3. **Run Django loaddata**:
   ```bash
   cd /opt/render/project/src

   # IMPORTANT: Flush existing data first (DESTRUCTIVE!)
   python manage.py flush --no-input

   # Load backup (example for each model)
   python manage.py loaddata /tmp/restore/backup.json
   ```

   **Note**: The backup format from our export is not directly compatible with `loaddata`. See Method 2 for full restore.

### Method 2: Manual Restore via Python Script

1. **Download backup file from GitHub**:
   ```bash
   git clone --branch database-backups https://github.com/YOUR_USERNAME/YOUR_REPO.git backups
   cd backups
   ls backups/  # Find your backup file
   ```

2. **Create restore script**:
   Create `restore_database.py`:
   ```python
   import json
   import os
   import django

   # Setup Django
   os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mysite.settings')
   django.setup()

   from django.contrib.auth.models import User
   from userRegistration.models import UserProfile
   from calendarEditor.models import (
       Machine, QueuePreset, QueueEntry, ArchivedMeasurement,
       NotificationPreference, Notification
   )

   # Load backup file
   with open('backups/database_backup_YYYY-MM-DD_HH-MM-SS.json', 'r') as f:
       backup = json.load(f)

   print(f"Backup from: {backup['export_date']}")
   print(f"Django version: {backup['django_version']}")

   # Restore each model (order matters due to foreign keys)
   model_map = {
       'auth.User': User,
       'userRegistration.UserProfile': UserProfile,
       'calendarEditor.Machine': Machine,
       'calendarEditor.QueuePreset': QueuePreset,
       'calendarEditor.QueueEntry': QueueEntry,
       'calendarEditor.ArchivedMeasurement': ArchivedMeasurement,
       'calendarEditor.NotificationPreference': NotificationPreference,
       'calendarEditor.Notification': Notification,
   }

   # WARNING: This will delete all existing data!
   confirm = input("This will DELETE all existing data. Type 'YES' to continue: ")
   if confirm != 'YES':
       print("Restore cancelled.")
       exit()

   for model_name, model_class in model_map.items():
       print(f"\nRestoring {model_name}...")
       model_class.objects.all().delete()

       records = backup['models'].get(model_name, [])
       if isinstance(records, dict) and 'error' in records:
           print(f"  âš ï¸  Skipped due to error: {records['error']}")
           continue

       count = 0
       for record in records:
           try:
               # Extract fields from Django serialization format
               fields = record['fields']
               pk = record['pk']

               # Create object with primary key
               obj = model_class(pk=pk, **fields)
               obj.save()
               count += 1
           except Exception as e:
               print(f"  âš ï¸  Error restoring {model_name} pk={pk}: {e}")

       print(f"  âœ… Restored {count} {model_name} records")

   print("\nðŸŽ‰ Database restore complete!")
   ```

3. **Run restore script**:
   ```bash
   python restore_database.py
   ```

### Method 3: Replace SQLite File (Quickest, requires database export)

**Note**: This method requires an actual SQLite `.db` file, not JSON export. Use if you have a direct database file backup.

1. **Access Render shell**:
   ```bash
   render shell qhog
   ```

2. **Stop web service** (via Render dashboard: Service â†’ Manual Deploy â†’ Suspend)

3. **Backup current database**:
   ```bash
   cp /opt/render/project/data/db.sqlite3 /opt/render/project/data/db.sqlite3.backup
   ```

4. **Replace with backup** (upload your backup file first):
   ```bash
   cp /tmp/your_backup.sqlite3 /opt/render/project/data/db.sqlite3
   ```

5. **Resume web service** (via Render dashboard)

## Disaster Recovery Scenarios

### Scenario 1: Accidental Data Deletion

**Solution**: Restore from most recent backup (GitHub `database-backups` branch)

**Steps**:
1. Get latest backup from `database-backups` branch
2. Use Method 2 (Python restore script)
3. Verify data integrity after restore

### Scenario 2: Server Crash / Data Corruption

**Solution**: Redeploy service and restore from backup

**Steps**:
1. Trigger new Render deployment (to get fresh persistent disk)
2. After migrations complete, restore from backup
3. Verify all services working

### Scenario 3: Migration Gone Wrong

**Solution**: Rollback to pre-migration backup

**Steps**:
1. Identify backup from before migration
2. Roll back code to pre-migration commit
3. Restore database from backup
4. Fix migration issue before retrying

## Backup Verification

### Weekly Verification Checklist

1. Check GitHub Actions success: âœ… "Backup Database" workflow
2. Verify backup file exists in `database-backups` branch
3. Check backup file size (should be >1KB)
4. Spot-check backup JSON structure:
   ```bash
   git checkout database-backups
   cat backups/database_backup_latest.json | jq '.models | keys'
   ```

### Monthly Restore Test

**Recommended**: Test restore process monthly on local development

```bash
# Download latest backup
git checkout database-backups
cp backups/database_backup_*.json ~/test_restore.json

# Test restore locally
python restore_database.py
# Verify application works
python manage.py runserver

# Check critical data:
# - Can you log in?
# - Are machines listed?
# - Are queue entries present?
```

## Troubleshooting

### Backup API Returns 401/403

**Cause**: Invalid or missing BACKUP_API_KEY

**Solution**:
1. Check Render env var `BACKUP_API_KEY` is set
2. Verify GitHub secret matches Render value
3. Regenerate if necessary: Render â†’ Environment â†’ BACKUP_API_KEY â†’ Generate new

### Backup File is Empty or Tiny (<1KB)

**Cause**: API endpoint error or serialization failure

**Solution**:
1. Check Render logs for errors
2. Test endpoint manually: `curl -H "Authorization: Bearer KEY" https://qhog.onrender.com/schedule/api/backup/database/`
3. Verify models are importable in Django shell

### Restore Fails with Foreign Key Errors

**Cause**: Records restored out of dependency order

**Solution**: Ensure models are restored in this order:
1. User
2. UserProfile
3. Machine
4. QueuePreset
5. QueueEntry
6. ArchivedMeasurement
7. NotificationPreference
8. Notification

### Database Locked Error During Restore

**Cause**: Web service still accessing database

**Solution**:
1. Suspend Render service
2. Perform restore
3. Resume service

## Contact

For issues with backups or restores:
- Check Render service logs
- Review GitHub Actions workflow runs
- Contact system administrator

## Related Documentation

- [Render Persistent Disks](https://render.com/docs/disks)
- [Django Database Backups](https://docs.djangoproject.com/en/4.2/ref/django-admin/#dumpdata)
- [GitHub Actions Workflows](https://docs.github.com/en/actions)
