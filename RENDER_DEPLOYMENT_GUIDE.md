# Render.com Deployment Guide

## üéâ Refactoring Complete!

Your Django app has been successfully refactored to work on **Render.com's free tier** without Celery!

---

## What Changed?

### ‚úÖ Removed
- **Celery** - No more separate worker processes needed
- **Background task scheduling** - No more Celery beat
- **celery==5.3.4** from requirements.txt
- `mysite/celery.py` and `calendarEditor/tasks.py`

### ‚úÖ Added
- **Middleware-based reminder system** - Checks for pending reminders on every request
- **Frontend temperature polling** - Updates temperatures every 15 seconds while user is on page
- **Production dependencies** - dj-database-url, whitenoise, psycopg2-binary, gunicorn
- **Environment variable support** - For SECRET_KEY, DEBUG, DATABASE_URL, REDIS_URL, etc.
- **Render deployment config** - `render.yaml` for easy deployment

### ‚úÖ Modified
- **QueueEntry model** - Added `reminder_due_at` and `reminder_sent` fields
- **Check-in logic** - Sets reminder time in database instead of scheduling Celery task
- **settings.py** - Production-ready with environment variables
- **Procfile** - Updated to use Daphne for WebSocket support

---

## How It Works Now

### Reminder System (Replaces Celery)
**Old way (Celery):**
```
User checks in ‚Üí Celery task scheduled for 2 hours later ‚Üí Reminder sent exactly at 2 hours
```

**New way (Middleware):**
```
User checks in ‚Üí reminder_due_at = now + 2 hours (saved to database)
‚Üì
Next request to app ‚Üí Middleware checks: Is reminder_due_at <= now? ‚Üí Send reminder if yes
```

**Benefits:**
- ‚úÖ No separate worker process needed
- ‚úÖ Works perfectly on free tier
- ‚úÖ Automatic cancellation if user checks out early (status check)
- ‚ö†Ô∏è Timing is approximate (sent on next request after due time, not exact)

### Temperature Monitoring
**Old way:** Background command running continuously

**New way:** Frontend JavaScript polls API every 15 seconds while user is on page
- Fetches fresh temperatures from machine APIs
- Auto-stops when user leaves page
- No server resources used when no one is viewing

‚ö†Ô∏è **IMPORTANT**: Live temperature monitoring will **NOT work** in cloud deployment because machines have local network IPs. See `NETWORK_LIMITATIONS.md` for details and workarounds.

---

## Deployment to Render.com

### Step 1: Prepare Your Code
```bash
# Install new dependencies locally
pip install -r requirements.txt

# Verify everything works
python manage.py check
python manage.py migrate
python test_reminders.py
```

### Step 2: Push to GitHub
```bash
git add .
git commit -m "Refactor for Render deployment - remove Celery, add middleware reminders"
git push origin main
```

### Step 3: Deploy to Render
1. Go to https://render.com and sign up/login
2. Click **"New +"** ‚Üí **"Blueprint"**
3. Connect your GitHub repository
4. Render will detect `render.yaml` and set up:
   - Web service (Django app)
   - PostgreSQL database (free tier)
   - Redis instance (free tier)

### Step 4: Set Environment Variables
In the Render dashboard, add these environment variables:

```
SECRET_KEY=<auto-generated-by-render>
DEBUG=False
ALLOWED_HOSTS=your-app-name.onrender.com
SLACK_BOT_TOKEN=<your-slack-bot-token>
BASE_URL=https://your-app-name.onrender.com

# Superuser credentials (automatically created during deployment)
DJANGO_SUPERUSER_USERNAME=admin
DJANGO_SUPERUSER_EMAIL=admin@example.com
DJANGO_SUPERUSER_PASSWORD=ChangeThisPassword123
```

### Step 5: Automatic Setup
The build process automatically:
- ‚úÖ Runs migrations
- ‚úÖ Loads initial data (machines, users, etc.) from `initial_data.json`
- ‚úÖ Creates superuser from environment variables above

**No manual shell commands needed!** (Shell is a paid feature on Render)

### Step 6: Access Your Site
Your app will be live at: `https://your-app-name.onrender.com`

---

## Free Tier Limitations

### What You Get (FREE):
‚úÖ Web service (750 hours/month - enough for 24/7)
‚úÖ PostgreSQL database (90 days free, then $7/month or switch to free-tier compatible DB)
‚úÖ Redis (persistent, free tier available)
‚úÖ HTTPS/SSL included
‚úÖ Custom domain support
‚úÖ Automatic deployments from GitHub

### Trade-offs:
‚ö†Ô∏è **Spin-down after 15 minutes of inactivity**
- First visitor after inactivity: 30-60 second cold start
- Subsequent visitors: Instant load
- All features work normally after wake-up

‚ö†Ô∏è **Reminder timing is approximate**
- Reminders sent on next request after due time
- NOT exactly on the hour
- Acceptable for most use cases

‚ö†Ô∏è **Temperature monitoring won't work in cloud deployment**
- Lab machines have local network IPs (192.168.x.x) that Render cannot reach
- Temperature readings will show as "Unknown" or stale
- All scheduling features still work normally
- See `NETWORK_LIMITATIONS.md` for workarounds if you need live temps

---

## Local Development

### Using SQLite (Default)
No configuration needed! Just run:
```bash
python manage.py runserver
```

### Using PostgreSQL Locally
Create `.env` file (copy from `.env.example`):
```bash
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
REDIS_URL=redis://127.0.0.1:6379
```

---

## Testing the Reminder System

### Quick Test
```bash
python test_reminders.py
```

### Manual Test
1. Check in to a machine
2. In Django admin or shell, set `reminder_due_at` to a past time:
   ```python
   from calendarEditor.models import QueueEntry
   from django.utils import timezone

   entry = QueueEntry.objects.filter(status='running').first()
   entry.reminder_due_at = timezone.now() - timedelta(minutes=5)
   entry.save()
   ```
3. Refresh any page in the app
4. Check notifications - reminder should appear!

---

## Troubleshooting

### Reminders not sending?
- Check `reminder_due_at` is set on entry: `entry.reminder_due_at`
- Check `reminder_sent` is False: `entry.reminder_sent`
- Check status is 'running': `entry.status`
- Try refreshing the page to trigger middleware

### Temperatures not updating?
- Open fridge list page: `/fridge-specs/`
- Check browser console for errors
- Verify API endpoint works: `/api/machine-status/`

### Deployment issues?
- Check Render logs for errors
- Verify all environment variables are set
- Run `python manage.py check` locally first

---

## Cost Breakdown

**Totally Free (with limitations):**
- Web service: Free tier (spin-down after 15 min)
- Redis: Free tier
- PostgreSQL: 90 days free trial, then $7/month

**Recommended for Production ($7/month):**
- Web service: $7/month (no spin-down, always fast)
- Redis: Free tier (sufficient)
- PostgreSQL: Free or $7/month

**Full Production ($14/month):**
- Web service: $7/month
- Redis: Free tier
- PostgreSQL: $7/month

---

## Next Steps

1. **Test locally** - Make sure everything works
2. **Deploy to Render** - Follow steps above
3. **Test on Render** - Check all features work
4. **Monitor** - Watch for any issues
5. **Upgrade if needed** - Pay $7/month to remove spin-down

---

## Support

- **Render Docs**: https://render.com/docs
- **Django Deployment**: https://docs.djangoproject.com/en/4.2/howto/deployment/
- **This project**: Check `test_reminders.py` for reminder testing

---

**You're ready to deploy!** üöÄ
