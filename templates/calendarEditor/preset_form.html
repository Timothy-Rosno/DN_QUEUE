{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Lab Equipment Queue{% endblock %}

{% block content %}
<div class="card">
    <h1 style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ page_title }}</h1>
    {% if mode == 'create' %}
    <p style="margin: 1rem 0;">Create a new preset with your experiment parameters. You can use this preset to quickly fill forms in the future.</p>
    {% elif mode == 'view' %}
    <p style="margin: 1rem 0;">Viewing preset parameters (read-only).</p>
    {% else %}
    <p style="margin: 1rem 0;">Edit your preset parameters below.</p>
    {% endif %}

    <form method="post" id="presetForm">
        {% csrf_token %}
        <!-- Top Submit Buttons
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            {% if mode == 'create' %}
            <button type="submit" class="btn">Create Preset</button>
            {% else %}
            <button type="submit" class="btn">Save Changes</button>
            <button type="button" class="btn delete-preset-btn" data-preset-id="{{ preset.id }}" data-preset-name="{{ preset.name }}" style="background-color: #e74c3c; color: white;">Delete Preset</button>
            {% endif %}
            {% if from_admin == 'true' %}
            <a href="{% url 'admin_presets' %}" class="btn btn-secondary">Cancel</a>
            {% else %}
            <a href="{% url 'submit_queue' %}" class="btn btn-secondary">Cancel</a>
            {% endif %}
        </div> -->
        <!-- Preset Name Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.name.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.name.label }} <span style="color: #e74c3c;">*</span>
            </label>
            {{ form.name }}
            {% if form.name.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.name.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.name.help_text }}</small>
        </div>

        <!-- Public/Private Selection -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px; border-left: 4px solid #3498db;">
            
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                <label for="{{ form.is_public.id_for_label }}" style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;">
                    {{ form.is_public }}
                    <span style="margin-left: 0.5rem; font-weight: bold;">{{ form.is_public.label }}</span>
                </label>
            </div>

            {% if form.is_public.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.is_public.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">
                Public presets are visible to all users. Only you and admins can edit your public presets. Leave unchecked for a private preset that only you can see and edit.
            </small>

        </div>
        <!-- Title Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.title.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.title.label }}
            </label>
            {{ form.title }}
            {% if form.title.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.title.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.title.help_text }}</small>
        </div>

        <!-- Description Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.description.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.description.label }}
            </label>
            {{ form.description }}
            {% if form.description.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.description.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.description.help_text }}</small>
        </div>

        <!-- Requested Measurement Time -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.requested_measurement_days.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Requested Measurement Time on Machine (days)
            </label>
            {{ form.requested_measurement_days }}
            {% if form.requested_measurement_days.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.requested_measurement_days.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.requested_measurement_days.help_text }}</small>
        </div>

        <!-- Temperature Fields -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_min_temp.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_min_temp.label }}
            </label>
            {{ form.required_min_temp }}
            {% if form.required_min_temp.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_min_temp.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_min_temp.help_text }}</small>
        </div>

        <!-- DEPRECATED: Max Temperature field removed as it was confusing to users -->
        {% comment %}
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_max_temp.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_max_temp.label }}
            </label>
            {{ form.required_max_temp }}
            {% if form.required_max_temp.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_max_temp.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_max_temp.help_text }}</small>
        </div>
        {% endcomment %}

        <!-- B-field Section -->
        <div style="margin-bottom: 1.5rem;">
            <label for="requireBField" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                <input type="checkbox" id="requireBField" style="margin-right: 0.5rem; width: auto; cursor: pointer;">
                <span style="font-weight: bold;">Require Magnetic B-field</span>
            </label>

            <div id="bFieldOptions" style="margin-left: 1.5rem; margin-top: 1rem; display: none;">
                <p style="margin-bottom: 0.75rem; color: #7f8c8d; font-size: 0.9rem;">
                    Select which axes you need and specify the required field strength:
                </p>

                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <label for="requireBFieldX" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                        <input type="checkbox" id="requireBFieldX" style="margin-right: 0.5rem; width: auto; cursor: pointer;">
                        <strong>X-axis</strong>
                    </label>
                    <span id="bFieldXInput" style="display: none; margin-left: 1rem;">
                        {{ form.required_b_field_x.label }}: {{ form.required_b_field_x }}
                    </span>
                </div>

                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <label for="requireBFieldY" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                        <input type="checkbox" id="requireBFieldY" style="margin-right: 0.5rem; width: auto; cursor: pointer;">
                        <strong>Y-axis</strong>
                    </label>
                    <span id="bFieldYInput" style="display: none; margin-left: 1rem;">
                        {{ form.required_b_field_y.label }}: {{ form.required_b_field_y }}
                    </span>
                </div>

                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <label for="requireBFieldZ" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                        <input type="checkbox" id="requireBFieldZ" style="margin-right: 0.5rem; width: auto; cursor: pointer;">
                        <strong>Z-axis</strong>
                    </label>
                    <span id="bFieldZInput" style="display: none; margin-left: 1rem;">
                        {{ form.required_b_field_z.label }}: {{ form.required_b_field_z }}
                    </span>
                </div>

                <div id="bFieldZDirection" style="margin-top: 0.75rem; margin-left: 1.5rem; padding: 0.75rem; background-color: white; border-radius: 4px; border: 1px solid #ddd; display: none;">
                    <label for="{{ form.required_b_field_direction.id_for_label }}" style="display: inline-block; font-weight: bold; margin-right: 0.5rem;">
                        {{ form.required_b_field_direction.label }}:
                    </label>
                    {{ form.required_b_field_direction }}
                    <small style="color: #7f8c8d; margin-left: 0.5rem;">
                        {{ form.required_b_field_direction.help_text }}
                    </small>
                </div>
            </div>
        </div>

        <!-- Connection Requirements -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_dc_lines.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_dc_lines.label }}
            </label>
            {{ form.required_dc_lines }}
            {% if form.required_dc_lines.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_dc_lines.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_dc_lines.help_text }}</small>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_rf_lines.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_rf_lines.label }}
            </label>
            {{ form.required_rf_lines }}
            {% if form.required_rf_lines.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_rf_lines.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_rf_lines.help_text }}</small>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_daughterboard.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_daughterboard.label }}
            </label>
            {{ form.required_daughterboard }}
            {% if form.required_daughterboard.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_daughterboard.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_daughterboard.help_text }}</small>
        </div>

        <!-- Optical Requirements -->
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <label for="{{ form.requires_optical.id_for_label }}" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                    <span title="">{{ form.requires_optical }}</span>
                    <span style="margin-left: 0.5rem; font-weight: bold;">{{ form.requires_optical.label }}</span>
                </label>
                <button type="button" id="viewOpticalMachinesBtn" class="btn btn-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                    View Compatible Machines
                </button>
            </div>

            {% if form.requires_optical.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.requires_optical.errors }}</div>
            {% endif %}

            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.requires_optical.help_text }} Click "View Compatible Machines" to see and select which machine to use for optical measurements.</small>

            <!-- Selected machine display -->
            <div id="selectedMachineDisplay" style="display: none; margin-top: 1rem; padding: 1rem; background-color: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #2c3e50;">Selected Machine:</strong>
                        <span id="selectedMachineName" style="margin-left: 0.5rem; color: #3498db; font-weight: bold;"></span>
                        <span id="selectedMachineDetails" style="margin-left: 0.5rem; color: #7f8c8d; font-size: 0.9rem;"></span>
                    </div>
                    <button type="button" id="changeMachineBtn" class="btn btn-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                        Change Machine
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Submit Buttons -->
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            {% if mode == 'create' %}
            <button type="submit" class="btn">Create Preset</button>
            {% elif mode == 'view' %}
            <!-- No action buttons in view mode, just navigation -->
            {% else %}
            <button type="submit" class="btn">Save Changes</button>
            <button type="button" class="btn delete-preset-btn" data-preset-id="{{ preset.id }}" data-preset-name="{{ preset.name }}" style="background-color: #e74c3c; color: white;">Delete Preset</button>
            {% endif %}
            {% if from_admin == 'true' %}
            <a href="{% url 'admin_presets' %}" class="btn btn-secondary">{% if mode == 'view' %}Back{% else %}Cancel{% endif %}</a>
            {% else %}
            <a href="{% url 'submit_queue' %}" class="btn btn-secondary">{% if mode == 'view' %}Back{% else %}Cancel{% endif %}</a>
            {% endif %}
        </div>
    </form>

    <style>
        /* Make all checkboxes have pointer cursor */
        input[type="checkbox"] {
            cursor: pointer !important;
        }
        label:has(input[type="checkbox"]) {
            cursor: pointer !important;
        }

        /* Machine option button hover styles */
        .machine-option-btn-preset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background-color: #fff;
        }

        .machine-option-btn-preset:active {
            transform: translateY(0);
        }
    </style>

    {% if mode == 'view' %}
    <script>
        // Disable all form fields in view mode
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('presetForm');
            if (form) {
                // Disable all inputs, textareas, and selects
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(function(input) {
                    input.disabled = true;
                    input.style.cursor = 'not-allowed';
                    input.style.backgroundColor = '#f5f5f5';
                });

                // Hide form checkboxes that trigger UI changes
                const requireBField = document.getElementById('requireBField');
                if (requireBField) requireBField.disabled = true;
                const requireBFieldX = document.getElementById('requireBFieldX');
                if (requireBFieldX) requireBFieldX.disabled = true;
                const requireBFieldY = document.getElementById('requireBFieldY');
                if (requireBFieldY) requireBFieldY.disabled = true;
                const requireBFieldZ = document.getElementById('requireBFieldZ');
                if (requireBFieldZ) requireBFieldZ.disabled = true;
            }
        });
    </script>
    {% endif %}

    <!-- Thanos Delete Confirmation Modal -->
    <div id="thanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:2rem; border-radius:10px; max-width:400px; width:90%; text-align:center; position:relative;">
            <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
            <p id="thanosMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-wrap: break-word;"></p>
            <div style="display:flex; justify-content:space-around; gap:1rem;">
                <button id="thanosYes" class="btn btn-danger">Yes, snap it immediately</button>
                <button id="thanosNo" class="btn btn-secondary">No, spare its variables</button>
            </div>
            <span id="thanosClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
        </div>
    </div>

    <script>
        // Thanos modal for delete confirmation
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('thanosModal');
            const message = document.getElementById('thanosMessage');
            const btnYes = document.getElementById('thanosYes');
            const btnNo = document.getElementById('thanosNo');
            const btnClose = document.getElementById('thanosClose');
            let currentPresetId = null;
            let currentPresetName = null;

            // Open modal when delete button clicked
            document.querySelectorAll('.delete-preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentPresetId = this.getAttribute('data-preset-id');
                    currentPresetName = this.getAttribute('data-preset-name');
                    message.textContent = `Are you sure you want to delete preset "${currentPresetName}"?`;
                    modal.style.display = 'flex';
                });
            });

            // Yes button: submit delete form
            btnYes.addEventListener('click', function() {
                if (currentPresetId) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/schedule/preset/delete/${currentPresetId}/`;

                    // Add CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);

                    document.body.appendChild(form);
                    form.submit();
                }
            });

            // No button: close modal
            btnNo.addEventListener('click', function() {
                modal.style.display = 'none';
                currentPresetId = null;
                currentPresetName = null;
            });

            // Close button: close modal
            btnClose.addEventListener('click', function() {
                modal.style.display = 'none';
                currentPresetId = null;
                currentPresetName = null;
            });

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if(e.target === modal) {
                    modal.style.display = 'none';
                    currentPresetId = null;
                    currentPresetName = null;
                }
            });
        });
    </script>

    <script>
        // B-field hierarchical checkbox logic
        document.getElementById('requireBField').addEventListener('change', function() {
            document.getElementById('bFieldOptions').style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                // Reset all B-field inputs when unchecked
                document.getElementById('requireBFieldX').checked = false;
                document.getElementById('requireBFieldY').checked = false;
                document.getElementById('requireBFieldZ').checked = false;
                document.getElementById('bFieldXInput').style.display = 'none';
                document.getElementById('bFieldYInput').style.display = 'none';
                document.getElementById('bFieldZInput').style.display = 'none';
                document.getElementById('bFieldZDirection').style.display = 'none';
                // Reset field values
                document.getElementById('{{ form.required_b_field_x.id_for_label }}').value = '0';
                document.getElementById('{{ form.required_b_field_y.id_for_label }}').value = '0';
                document.getElementById('{{ form.required_b_field_z.id_for_label }}').value = '0';
            }
        });

        document.getElementById('requireBFieldX').addEventListener('change', function() {
            document.getElementById('bFieldXInput').style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                document.getElementById('{{ form.required_b_field_x.id_for_label }}').value = '0';
            }
        });

        document.getElementById('requireBFieldY').addEventListener('change', function() {
            document.getElementById('bFieldYInput').style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                document.getElementById('{{ form.required_b_field_y.id_for_label }}').value = '0';
            }
        });

        document.getElementById('requireBFieldZ').addEventListener('change', function() {
            document.getElementById('bFieldZInput').style.display = this.checked ? 'block' : 'none';
            document.getElementById('bFieldZDirection').style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                document.getElementById('{{ form.required_b_field_z.id_for_label }}').value = '0';
            }
        });

        // Initialize form state based on existing values (for edit mode or validation errors)
        window.addEventListener('DOMContentLoaded', function() {
            const bFieldX = parseFloat(document.getElementById('{{ form.required_b_field_x.id_for_label }}').value) || 0;
            const bFieldY = parseFloat(document.getElementById('{{ form.required_b_field_y.id_for_label }}').value) || 0;
            const bFieldZ = parseFloat(document.getElementById('{{ form.required_b_field_z.id_for_label }}').value) || 0;

            if (bFieldX > 0 || bFieldY > 0 || bFieldZ > 0) {
                document.getElementById('requireBField').checked = true;
                document.getElementById('bFieldOptions').style.display = 'block';

                if (bFieldX > 0) {
                    document.getElementById('requireBFieldX').checked = true;
                    document.getElementById('bFieldXInput').style.display = 'block';
                }
                if (bFieldY > 0) {
                    document.getElementById('requireBFieldY').checked = true;
                    document.getElementById('bFieldYInput').style.display = 'block';
                }
                if (bFieldZ > 0) {
                    document.getElementById('requireBFieldZ').checked = true;
                    document.getElementById('bFieldZInput').style.display = 'block';
                    document.getElementById('bFieldZDirection').style.display = 'block';
                }
            }
        });
    </script>

    <script>
        // Prevent scroll from changing number input values while still allowing page scroll
        (function() {
            // Get all number inputs
            const numberInputs = document.querySelectorAll('input[type="number"]');

            // Prevent mouse wheel from changing values ONLY on focused number inputs
            numberInputs.forEach(function(input) {
                input.addEventListener('wheel', function(e) {
                    // Only prevent if this input is focused
                    if (document.activeElement === this) {
                        e.preventDefault();
                        // Blur the input so the page can scroll
                        this.blur();
                    }
                }, { passive: false });
            });

            // Also blur focused number inputs when the page is scrolled
            window.addEventListener('scroll', function() {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.type === 'number') {
                    activeElement.blur();
                }
            }, { passive: true });
        })();
    </script>

    <script>
        // Real-time validation with error messages
        (function() {
            const numberInputs = document.querySelectorAll('input[type="number"]');
            const descriptionField = document.querySelector('textarea[name="description"]');

            // Auto-clear default values on focus
            numberInputs.forEach(function(input) {
                input.addEventListener('focus', function() {
                    // Clear if the value is 0 or empty
                    if (this.value === '0' || this.value === '0.00' || this.value === '') {
                        this.value = '';
                    }
                    // Select all text on focus for easy replacement
                    this.select();
                });
            });

            // Create error message element for each input
            numberInputs.forEach(function(input) {
                // Create error message div
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'color: #e74c3c; font-size: 0.9rem; margin-top: 0.25rem; display: none; font-weight: bold;';
                errorDiv.className = 'input-validation-error';

                // Insert error div after the input
                input.parentNode.insertBefore(errorDiv, input.nextSibling);

                // Validation function
                function validateInput() {
                    const value = parseFloat(input.value);
                    const min = parseFloat(input.getAttribute('min'));
                    const max = parseFloat(input.getAttribute('max'));
                    const fieldName = input.parentNode.querySelector('label')?.textContent?.replace('*', '').trim() || 'This field';

                    // Clear previous error
                    errorDiv.textContent = '';
                    errorDiv.style.display = 'none';
                    input.style.borderColor = '';

                    // Skip validation if empty and field is not required
                    if (input.value === '' || input.value === null) {
                        return true;
                    }

                    // Check if value is a valid number
                    if (isNaN(value)) {
                        errorDiv.textContent = `${fieldName}: Please enter a valid number`;
                        errorDiv.style.display = 'block';
                        input.style.borderColor = '#e74c3c';
                        return false;
                    }

                    // Check min constraint
                    if (!isNaN(min) && value < min) {
                        errorDiv.textContent = `${fieldName}: Must be at least ${min}`;
                        errorDiv.style.display = 'block';
                        input.style.borderColor = '#e74c3c';
                        return false;
                    }

                    // Check max constraint
                    if (!isNaN(max) && value > max) {
                        errorDiv.textContent = `${fieldName}: Must be at most ${max}`;
                        errorDiv.style.display = 'block';
                        input.style.borderColor = '#e74c3c';
                        return false;
                    }

                    return true;
                }

                // Validate on blur (clicking/tabbing away)
                input.addEventListener('blur', validateInput);

                // Validate on Enter or Tab key
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        validateInput();
                    }
                });

                // Validate on input change (real-time feedback after first interaction)
                input.addEventListener('input', function() {
                    // Only validate if the input has been interacted with before
                    if (input.dataset.touched === 'true') {
                        validateInput();
                    }
                });

                // Mark as touched when user interacts
                input.addEventListener('blur', function() {
                    input.dataset.touched = 'true';
                });
            });

            // Device name (title) field validation (optional, shows warning if < 3 chars for queue submission)
            const titleField = document.querySelector('input[name="title"]');
            if (titleField) {
                const titleWarningDiv = document.createElement('div');
                titleWarningDiv.style.cssText = 'color: #f39c12; font-size: 0.9rem; margin-top: 0.25rem; display: none;';
                titleWarningDiv.className = 'input-validation-warning';
                titleField.parentNode.insertBefore(titleWarningDiv, titleField.nextSibling);

                function validateTitle() {
                    const value = titleField.value.trim();
                    const queueMinLength = 3;

                    // Clear previous warning
                    titleWarningDiv.textContent = '';
                    titleWarningDiv.style.display = 'none';
                    titleField.style.borderColor = '';

                    // Show informative warning if entered but < 3 chars (doesn't block submission)
                    if (value !== '' && value.length < queueMinLength) {
                        titleWarningDiv.textContent = `Note: ${queueMinLength - value.length} more character(s) needed for queue submission`;
                        titleWarningDiv.style.display = 'block';
                        titleField.style.borderColor = '#f39c12';
                    }

                    return true; // Always return true, doesn't block
                }

                // Validate on blur
                titleField.addEventListener('blur', function() {
                    this.dataset.touched = 'true';
                    validateTitle();
                });

                // Validate on Enter or Tab
                titleField.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        validateTitle();
                    }
                });

                // Real-time validation after first interaction
                titleField.addEventListener('input', function() {
                    if (this.dataset.touched === 'true') {
                        validateTitle();
                    }
                });
            }

            // Description field validation (optional, shows warning if < 50 chars for queue submission)
            if (descriptionField) {
                const descWarningDiv = document.createElement('div');
                descWarningDiv.style.cssText = 'color: #f39c12; font-size: 0.9rem; margin-top: 0.25rem; display: none;';
                descWarningDiv.className = 'input-validation-warning';
                descriptionField.parentNode.insertBefore(descWarningDiv, descriptionField.nextSibling);

                function validateDescription() {
                    const value = descriptionField.value.trim();
                    const queueMinLength = 50;

                    // Clear previous warning
                    descWarningDiv.textContent = '';
                    descWarningDiv.style.display = 'none';
                    descriptionField.style.borderColor = '';

                    // Show informative warning if entered but < 50 chars (doesn't block submission)
                    if (value !== '' && value.length < queueMinLength) {
                        descWarningDiv.textContent = `Note: ${queueMinLength - value.length} more character(s) needed for queue submission`;
                        descWarningDiv.style.display = 'block';
                        descriptionField.style.borderColor = '#f39c12';
                    }

                    return true; // Always return true, doesn't block
                }

                // Validate on blur
                descriptionField.addEventListener('blur', function() {
                    this.dataset.touched = 'true';
                    validateDescription();
                });

                // Validate on Enter or Tab
                descriptionField.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        // Allow Shift+Enter for new lines
                        validateDescription();
                    } else if (e.key === 'Tab') {
                        validateDescription();
                    }
                });

                // Real-time validation after first interaction
                descriptionField.addEventListener('input', function() {
                    if (this.dataset.touched === 'true') {
                        validateDescription();
                    }
                });
            }

            // Validate all fields on form submit
            const form = document.getElementById('presetForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    let hasErrors = false;

                    // Title validation on submit - just update warning, doesn't block
                    if (titleField) {
                        titleField.dataset.touched = 'true';
                        validateTitle();
                    }

                    // Description validation on submit - just update warning, doesn't block
                    if (descriptionField) {
                        descriptionField.dataset.touched = 'true';
                        validateDescription();
                    }

                    numberInputs.forEach(function(input) {
                        const value = parseFloat(input.value);
                        const min = parseFloat(input.getAttribute('min'));
                        const max = parseFloat(input.getAttribute('max'));
                        const fieldName = input.parentNode.querySelector('label')?.textContent?.replace('*', '').trim() || 'This field';
                        const errorDiv = input.nextSibling;

                        // Mark as touched
                        input.dataset.touched = 'true';

                        // Clear previous error
                        errorDiv.textContent = '';
                        errorDiv.style.display = 'none';
                        input.style.borderColor = '';

                        // Skip validation if empty and field is not required
                        if (input.value === '' || input.value === null) {
                            return;
                        }

                        // Check if value is a valid number
                        if (isNaN(value)) {
                            errorDiv.textContent = `${fieldName}: Please enter a valid number`;
                            errorDiv.style.display = 'block';
                            input.style.borderColor = '#e74c3c';
                            hasErrors = true;
                            return;
                        }

                        // Check min constraint
                        if (!isNaN(min) && value < min) {
                            errorDiv.textContent = `${fieldName}: Must be at least ${min}`;
                            errorDiv.style.display = 'block';
                            input.style.borderColor = '#e74c3c';
                            hasErrors = true;
                            return;
                        }

                        // Check max constraint
                        if (!isNaN(max) && value > max) {
                            errorDiv.textContent = `${fieldName}: Must be at most ${max}`;
                            errorDiv.style.display = 'block';
                            input.style.borderColor = '#e74c3c';
                            hasErrors = true;
                            return;
                        }
                    });

                    if (hasErrors) {
                        e.preventDefault();
                        // Scroll to first error
                        const firstError = document.querySelector('.input-validation-error[style*="display: block"]');
                        if (firstError) {
                            firstError.previousSibling.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }
        })();

        // ===============================
        // Prevent Decimal Input for RF/DC Lines
        // ===============================
        (function() {
            const dcLinesInput = document.getElementById('{{ form.required_dc_lines.id_for_label }}');
            const rfLinesInput = document.getElementById('{{ form.required_rf_lines.id_for_label }}');

            function preventDecimal(e) {
                // Prevent decimal point, comma, 'e', and minus sign
                if (e.key === '.' || e.key === ',' || e.key === 'e' || e.key === 'E' || e.key === '-' || e.key === '+') {
                    e.preventDefault();
                }
            }

            if (dcLinesInput) {
                dcLinesInput.addEventListener('keydown', preventDecimal);
                // Also prevent paste of decimal values
                dcLinesInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        this.value = this.value.replace(/[^0-9]/g, '');
                    }, 0);
                });
            }

            if (rfLinesInput) {
                rfLinesInput.addEventListener('keydown', preventDecimal);
                // Also prevent paste of decimal values
                rfLinesInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        this.value = this.value.replace(/[^0-9]/g, '');
                    }, 0);
                });
            }
        })();

        // Optical Capabilities Modal Logic
        (function() {
            const form = document.getElementById('presetForm');
            const opticalCheckbox = document.getElementById('{{ form.requires_optical.id_for_label }}');
            const opticalModal = document.getElementById('opticalCapabilitiesModal');
            const cancelOpticalBtn = document.getElementById('cancelOpticalBtn');
            const viewMachinesBtn = document.getElementById('viewOpticalMachinesBtn');

            if (!form || !opticalCheckbox || !opticalModal || !viewMachinesBtn) {
                return;
            }

            // Restore selected machine if editing preset with optical machine already selected
            {% if mode == 'edit' and preset.selected_optical_machine %}
            (function() {
                const machineId = '{{ preset.selected_optical_machine.id }}';
                const machineName = '{{ preset.selected_optical_machine.name }}';
                const machineDetails = '{{ preset.selected_optical_machine.get_optical_capabilities_display }}';

                // Add hidden input
                const machineInput = document.createElement('input');
                machineInput.type = 'hidden';
                machineInput.id = 'selected_machine_id';
                machineInput.name = 'selected_machine_id';
                machineInput.value = machineId;
                machineInput.dataset.machineName = machineName;
                machineInput.dataset.machineDetails = machineDetails;
                form.appendChild(machineInput);

                // Show selected machine display
                const selectedMachineDisplay = document.getElementById('selectedMachineDisplay');
                const selectedMachineNameSpan = document.getElementById('selectedMachineName');
                const selectedMachineDetailsSpan = document.getElementById('selectedMachineDetails');

                if (selectedMachineDisplay && selectedMachineNameSpan && selectedMachineDetailsSpan) {
                    selectedMachineNameSpan.textContent = machineName;
                    selectedMachineDetailsSpan.textContent = machineDetails;
                    selectedMachineDisplay.style.display = 'block';
                }
            })();
            {% endif %}

            // Show modal when "View Compatible Machines" button is clicked
            viewMachinesBtn.addEventListener('click', function() {
                showOpticalModal();
            });

            function showOpticalModal() {
                // Collect form data for filtering machines
                const formData = new FormData(form);
                const params = new URLSearchParams();

                // Add all requirements to query parameters
                params.append('required_min_temp', formData.get('required_min_temp') || '0');
                if (formData.get('required_max_temp')) {
                    params.append('required_max_temp', formData.get('required_max_temp'));
                }
                params.append('required_b_field_x', formData.get('required_b_field_x') || '0');
                params.append('required_b_field_y', formData.get('required_b_field_y') || '0');
                params.append('required_b_field_z', formData.get('required_b_field_z') || '0');
                params.append('required_b_field_direction', formData.get('required_b_field_direction') || '');
                params.append('required_dc_lines', formData.get('required_dc_lines') || '0');
                params.append('required_rf_lines', formData.get('required_rf_lines') || '0');
                params.append('required_daughterboard', formData.get('required_daughterboard') || '');

                // Fetch filtered optical machines from API
                fetch(`/schedule/api/optical-machines/?${params.toString()}`)
                    .then(r => r.json())
                    .then(data => {
                        const machineListContainer = document.getElementById('opticalMachineList');
                        if (!machineListContainer) {
                            console.error('Machine list container not found');
                            return;
                        }

                        // Clear existing content
                        machineListContainer.innerHTML = '';

                        if (data.machines && data.machines.length > 0) {
                            // Build machine option buttons dynamically
                            data.machines.forEach(machine => {
                                const button = document.createElement('button');
                                button.type = 'button';
                                button.className = 'machine-option-btn-preset';
                                button.setAttribute('data-machine-id', machine.id);
                                button.setAttribute('data-machine-name', machine.name);
                                button.setAttribute('data-machine-details', `${machine.optical_capabilities} - ${machine.queue_count} in queue`);
                                button.style.cssText = 'padding: 1.5rem; border: 2px solid #3498db; border-radius: 8px; background-color: #ecf0f1; cursor: pointer; text-align: left; transition: all 0.2s; width: 100%;';

                                button.innerHTML = `
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h3 style="margin: 0 0 0.5rem 0; color: #2c3e50;">${machine.name}</h3>
                                            <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">${machine.optical_capabilities}</p>
                                            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #16a085;">
                                                Current queue: ${machine.queue_count} entries
                                            </p>
                                        </div>
                                        <span style="font-size: 2rem; color: #3498db;">â†’</span>
                                    </div>
                                `;

                                machineListContainer.appendChild(button);
                            });
                        } else {
                            // No machines match requirements
                            machineListContainer.innerHTML = `
                                <p style="color: #e74c3c; text-align: center; padding: 2rem;">
                                    No machines with optical capabilities match your requirements. Please adjust your requirements or contact an administrator.
                                </p>
                            `;
                        }

                        // Show modal
                        opticalModal.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error loading optical machines:', error);
                        // Show error in modal
                        const machineListContainer = document.getElementById('opticalMachineList');
                        if (machineListContainer) {
                            machineListContainer.innerHTML = `
                                <p style="color: #e74c3c; text-align: center; padding: 2rem;">
                                    Error loading machines. Please try again.
                                </p>
                            `;
                        }
                        opticalModal.style.display = 'block';
                    });
            }

            function closeOpticalModal() {
                opticalModal.style.display = 'none';
            }

            function selectMachine(machineId, machineName, machineDetails) {
                // Add hidden input for machine selection
                let machineInput = document.getElementById('selected_machine_id');
                if (!machineInput) {
                    machineInput = document.createElement('input');
                    machineInput.type = 'hidden';
                    machineInput.id = 'selected_machine_id';
                    machineInput.name = 'selected_machine_id';
                    machineInput.dataset.machineName = '';
                    machineInput.dataset.machineDetails = '';
                    form.appendChild(machineInput);
                }
                machineInput.value = machineId;
                machineInput.dataset.machineName = machineName;
                machineInput.dataset.machineDetails = machineDetails;

                // Show selected machine display
                const selectedMachineDisplay = document.getElementById('selectedMachineDisplay');
                const selectedMachineNameSpan = document.getElementById('selectedMachineName');
                const selectedMachineDetailsSpan = document.getElementById('selectedMachineDetails');

                if (selectedMachineDisplay && selectedMachineNameSpan && selectedMachineDetailsSpan) {
                    selectedMachineNameSpan.textContent = machineName;
                    selectedMachineDetailsSpan.textContent = machineDetails;
                    selectedMachineDisplay.style.display = 'block';
                }

                // Close modal
                opticalModal.style.display = 'none';
            }

            function clearMachineSelection() {
                const machineInput = document.getElementById('selected_machine_id');
                if (machineInput) {
                    machineInput.remove();
                }

                const selectedMachineDisplay = document.getElementById('selectedMachineDisplay');
                if (selectedMachineDisplay) {
                    selectedMachineDisplay.style.display = 'none';
                }
            }

            // Machine selection handlers (attach to dynamically generated buttons)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.machine-option-btn-preset')) {
                    const btn = e.target.closest('.machine-option-btn-preset');
                    const machineId = btn.getAttribute('data-machine-id');
                    const machineName = btn.getAttribute('data-machine-name');
                    const machineDetails = btn.getAttribute('data-machine-details');
                    selectMachine(machineId, machineName, machineDetails);
                }
            });

            // Change machine button handler
            const changeMachineBtn = document.getElementById('changeMachineBtn');
            if (changeMachineBtn) {
                changeMachineBtn.addEventListener('click', function() {
                    showOpticalModal();
                });
            }

            // Handle checkbox change - clear selection if unchecked
            opticalCheckbox.addEventListener('change', function() {
                if (!this.checked) {
                    clearMachineSelection();
                }
            });

            // Cancel/Close button
            if (cancelOpticalBtn) {
                cancelOpticalBtn.addEventListener('click', closeOpticalModal);
            }

            // Close on backdrop click
            opticalModal.addEventListener('click', function(e) {
                if (e.target === opticalModal) {
                    closeOpticalModal();
                }
            });
        })();
    </script>

    <!-- Optical Capabilities Info Modal -->
    <div id="opticalCapabilitiesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1000; overflow: auto;">
        <div style="background-color: #fefefe; margin: 10% auto; padding: 2rem; border: 1px solid #888; border-radius: 8px; width: 80%; max-width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; color: #2c3e50;">Compatible Machines with Optical Capabilities</h2>
            <p style="color: #7f8c8d; margin-bottom: 1.5rem;">
                Based on your current requirements, these machines have optical capabilities and meet all specifications:
            </p>

            <div id="opticalMachineList" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
                <!-- Machines will be loaded dynamically via JavaScript -->
                <p style="text-align: center; padding: 2rem; color: #7f8c8d;">Loading available machines...</p>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" id="cancelOpticalBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
