{% extends 'base.html' %}
{% load static %}
{% block title %}User Management - Admin{% endblock %}

{% block content %}
<div class="card">
    <h1>User Management</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">Approve, manage, and review all users.</p>
    <div style="margin-top: 1rem;">
        <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">← Back to Dashboard</a>
    </div>
</div>

<!-- Search Bar -->
<div class="card">
    <form method="get" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
        <div style="flex: 1; min-width: 200px;">
            <label for="search" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Search Users</label>
            <input type="text" name="search" id="search" value="{{ search_query }}" placeholder="Username, email, name..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div>
            <button type="submit" class="btn">Search</button>
            <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear</button>
        </div>
    </form>
</div>

<!-- Two-Section Layout (Vertical) -->
<div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
    <!-- UNAPPROVED USERS (Pending + Rejected) -->
    {% if unapproved_users %}
    <div class="card" style="display: flex; flex-direction: column;">
        <h2 style="padding: 0.75rem 0; margin: 0; border-bottom: 2px solid #e74c3c; color: #e74c3c;">
            Unapproved Users ({{ unapproved_users|length }})
        </h2>

        <div style="max-height: 600px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                <thead style="position: sticky; top: 0; background: white; z-index: 9;">
                    <tr style="border-bottom: 2px solid #ddd; text-align: left;">
                        <th style="padding: 0.75rem;">Username</th>
                        <th style="padding: 0.75rem;">Status</th>
                        <th style="padding: 0.75rem;">Actions</th>
                    </tr>
                </thead>
            <tbody>
                {% for user_item in unapproved_users %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.75rem;">
                        <div>
                            <strong>{{ user_item.username }}</strong>
                            <div style="font-size: 0.85rem; color: #7f8c8d;">{{ user_item.email|default:"—" }}</div>
                        </div>
                    </td>
                    <td style="padding: 0.75rem;">
                        {% if user_item.profile.status == 'pending' %}
                            <span style="background-color: #f39c12; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.85rem; font-weight: bold;">PENDING</span>
                        {% elif user_item.profile.status == 'rejected' %}
                            <span style="background-color: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.85rem; font-weight: bold;">REJECTED</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem;">
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <!-- Approve Button (always available for unapproved users) -->
                            <form method="post" action="{% url 'approve_user' user_item.id %}" style="display: inline; margin: 0;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">Approve</button>
                            </form>

                            {% if user_item.profile.status == 'pending' %}
                                <!-- Pending: Show Reject button -->
                                <form method="post" action="{% url 'reject_user' user_item.id %}" style="display: inline; margin: 0;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-warning" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">Reject</button>
                                </form>
                            {% elif user_item.profile.status == 'rejected' %}
                                <!-- Rejected: Show Delete button -->
                                <form method="post" action="{% url 'delete_user' user_item.id %}" class="delete-user-form" data-username="{{ user_item.username }}" style="display: inline; margin: 0;">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">Delete</button>
                                </form>
                            {% endif %}

                            <!-- Edit Button -->
                            <button type="button" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem; background-color: #3498db; color: white;" onclick="window.location.href='/schedule/admin-users/edit-user-info/{{ user_item.id }}/'">Edit</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- APPROVED USERS -->
    {% if approved_users %}
    <div class="card" style="display: flex; flex-direction: column;">
        <h2 style="padding: 0.75rem 0; margin: 0; border-bottom: 2px solid #2ecc71; color: #2ecc71;">
            Approved Users ({{ approved_users|length }})
        </h2>

        <div style="max-height: 600px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                <thead style="position: sticky; top: 0; background: white; z-index: 9;">
                    <tr style="border-bottom: 2px solid #ddd; text-align: left;">
                        <th style="padding: 0.75rem;">Username</th>
                        <th style="padding: 0.75rem;">Status</th>
                        <th style="padding: 0.75rem;">Actions</th>
                    </tr>
                </thead>
            <tbody>
                {% for user_item in approved_users %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <!-- Promote/Demote button (superuser only) -->
                            {% if user.is_superuser and not user_item.is_superuser %}
                                {% if not user_item.is_staff %}
                                    <!-- Non-staff: show orange up arrow to promote to staff -->
                                    <form method="post" action="{% url 'promote_to_staff' user_item.id %}" style="display: inline; margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn" style="background-color: #f39c12; color: white; padding: 0.15rem 0.4rem; font-size: 0.75rem;" title="Promote to staff">↑</button>
                                    </form>
                                {% elif user_item.is_staff and not user_item.profile.is_developer %}
                                    <!-- Staff (non-developer): show purple up arrow (to dev) above gray down arrow (demote from staff) -->
                                    <div style="display: flex; flex-direction: column; gap: 0.1rem;">
                                        <form method="post" action="{% url 'promote_to_developer' user_item.id %}" style="margin: 0;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn" style="background-color: #9b59b6; color: white; padding: 0.15rem 0.4rem; font-size: 0.75rem;" title="Promote to developer">↑</button>
                                        </form>
                                        <form method="post" action="{% url 'demote_from_staff' user_item.id %}" style="margin: 0;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-secondary" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" title="Demote to regular user">↓</button>
                                        </form>
                                    </div>
                                {% elif user_item.profile.is_developer %}
                                    <!-- Developer: only show gray down arrow (demote from developer) -->
                                    <form method="post" action="{% url 'demote_from_developer' user_item.id %}" style="display: inline; margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-secondary" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" title="Demote from developer to staff">↓</button>
                                    </form>
                                {% endif %}
                            {% endif %}

                            <div>
                                <strong>{{ user_item.username }}</strong>
                                {% if user_item.is_staff %}
                                    <span style="background-color: #f39c12; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">STAFF</span>
                                {% endif %}
                                {% if user_item.profile.is_developer %}
                                    <span style="background-color: #9b59b6; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">DEVELOPER</span>
                                {% endif %}
                                {% if user_item.is_superuser %}
                                    <span style="background-color: #e74c3c; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">SUPERUSER</span>
                                {% endif %}
                                <div style="font-size: 0.85rem; color: #7f8c8d;">{{ user_item.email|default:"—" }}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 0.75rem;">
                        {% if user_item.is_staff or user_item.is_superuser %}
                            <span style="background-color: #f39c12; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.85rem; font-weight: bold;">STAFF</span>
                        {% else %}
                            <span style="background-color: #2ecc71; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.85rem; font-weight: bold;">APPROVED</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem;">
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            {% if user_item.is_superuser %}
                                <!-- Superusers cannot be managed here -->
                                <span style="color: #7f8c8d; font-size: 0.9rem;">Django Admin only</span>
                            {% elif user_item.is_staff %}
                                <!-- Staff users (only superusers can manage) -->
                                {% if user.is_superuser %}
                                    <form method="post" action="{% url 'reject_user' user_item.id %}" style="display: inline; margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem; background-color: #e74c3c; color: white;">Unapprove</button>
                                    </form>

                                    <button type="button" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem; background-color: #3498db; color: white;" onclick="window.location.href='/schedule/admin-users/edit-user-info/{{ user_item.id }}/'">Edit</button>
                                {% else %}
                                    <!-- Regular staff cannot manage other staff -->
                                    <span style="color: #7f8c8d; font-size: 0.9rem;">Superuser only</span>
                                {% endif %}
                            {% else %}
                                <!-- Regular approved users -->
                                <form method="post" action="{% url 'reject_user' user_item.id %}" style="display: inline; margin: 0;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem; background-color: #e74c3c; color: white;">Unapprove</button>
                                </form>

                                <button type="button" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.9rem; background-color: #3498db; color: white;" onclick="window.location.href='/schedule/admin-users/edit-user-info/{{ user_item.id }}/'">Edit</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
<!-- making a change so I can push -->
<!-- Edit User Information Section -->
<!-- <div class="card" style="margin-top: 1rem;">
    <h2>Edit User Information</h2>
    <p style="color: #7f8c8d; margin-bottom: 1rem;">Change a user's username, email, name, security question, or other information.</p>

    <form method="get" action="{% url 'admin_edit_user_info' %}" style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <label for="user_select" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Select User</label>
            <select name="user_id" id="user_select" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- Select a user --</option>
                {% for user_item in users %}
                    <option value="{{ user_item.id }}">{{ user_item.username }} ({{ user_item.email }})</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <button type="button" class="btn" onclick="editSelectedUser()">Edit User Info</button>
        </div>
    </form>
</div> -->

<div style="margin-top: 1rem;">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">← Back to Dashboard</a>
</div>

<!-- Thanos Delete Confirmation Modal -->
<div id="thanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:400px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p id="thanosMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-wrap: break-word;"></p>
        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="thanosYes" class="btn btn-danger">Yes, snap immediately</button>
            <button id="thanosNo" class="btn btn-secondary">No, spare their life</button>
        </div>
        <span id="thanosClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<!-- CURRENTLY ONLINE USERS -->
<div class="card" style="margin-top: 2rem;">
    <h2 style="margin-bottom: 1rem;">Currently Online Users ({{ online_count }})</h2>
    {% if online_users_data %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; min-width: 1000px; border-collapse: collapse;">
            <thead style="background: #f8f9fa;">
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="padding: 0.75rem; text-align: left;">Username</th>
                    <th style="padding: 0.75rem; text-align: left;">Browser</th>
                    <th style="padding: 0.75rem; text-align: left;">OS</th>
                    <th style="padding: 0.75rem; text-align: left;">Device</th>
                    <th style="padding: 0.75rem; text-align: left;">IP Address</th>
                    <th style="padding: 0.75rem; text-align: left;">Last Seen</th>
                    <th style="padding: 0.75rem; text-align: center;">Pages (15min)</th>
                    <th style="padding: 0.75rem; text-align: left;">Roles</th>
                </tr>
            </thead>
            <tbody>
                {% for online_user in online_users_data %}
                <tr style="border-bottom: 1px solid #eee; background-color: #e8f8f5;">
                    <td style="padding: 0.75rem;">
                        <strong>{{ online_user.username }}</strong>
                        <div style="font-size: 0.85rem; color: #7f8c8d;">{{ online_user.email }}</div>
                    </td>
                    <td style="padding: 0.75rem;">{{ online_user.browser }}</td>
                    <td style="padding: 0.75rem;">{{ online_user.os }}</td>
                    <td style="padding: 0.75rem;">{{ online_user.device }}</td>
                    <td style="padding: 0.75rem; font-family: monospace; font-size: 0.85rem;">{{ online_user.ip_address }}</td>
                    <td style="padding: 0.75rem;">{{ online_user.last_seen|date:"M d, Y H:i" }}</td>
                    <td style="padding: 0.75rem; text-align: center;">{{ online_user.page_count }}</td>
                    <td style="padding: 0.75rem;">
                        {% for role in online_user.roles %}
                            {% if role == 'Admin' %}
                                <span style="background-color: #e74c3c; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.15rem;">A</span>
                            {% elif role == 'Developer' %}
                                <span style="background-color: #9b59b6; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.15rem;">D</span>
                            {% elif role == 'Staff' %}
                                <span style="background-color: #f39c12; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.15rem;">S</span>
                            {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: #7f8c8d; padding: 1rem; text-align: center;">No users currently online</p>
    {% endif %}
</div>

<!-- PER-USER ANALYTICS -->
<div class="card" style="margin-top: 2rem;">
    <h2 style="margin-bottom: 1rem;">Per-User Analytics (All-Time)</h2>
    <div style="overflow-x: auto;">
        <table style="width: 100%; min-width: 1000px; border-collapse: collapse;">
            <thead style="background: #f8f9fa;">
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="padding: 0.75rem; text-align: left;">Username</th>
                    <th style="padding: 0.75rem; text-align: left;">Email</th>
                    <th style="padding: 0.75rem; text-align: left;">Roles</th>
                    <th style="padding: 0.75rem; text-align: center;">Status</th>
                    <th style="padding: 0.75rem; text-align: center;">Online</th>
                    <th style="padding: 0.75rem; text-align: left;">Last Seen</th>
                    <th style="padding: 0.75rem; text-align: center;">Page Views</th>
                    <th style="padding: 0.75rem; text-align: center;">Queue Entries</th>
                    <th style="padding: 0.75rem; text-align: center;">Feedback</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in per_user_stats %}
                <tr {% if stat.is_online %}style="border-bottom: 1px solid #eee; background-color: #e8f8f5;"{% else %}style="border-bottom: 1px solid #eee;"{% endif %}>
                    <td style="padding: 0.75rem;">
                        <strong>{{ stat.user.username }}</strong>
                    </td>
                    <td style="padding: 0.75rem; font-size: 0.9rem;">{{ stat.email|default:"—" }}</td>
                    <td style="padding: 0.75rem;">
                        {% for role in stat.roles %}
                            {% if role == 'Admin' %}
                                <span style="background-color: #e74c3c; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.15rem;">A</span>
                            {% elif role == 'Developer' %}
                                <span style="background-color: #9b59b6; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.15rem;">D</span>
                            {% elif role == 'Staff' %}
                                <span style="background-color: #f39c12; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.15rem;">S</span>
                            {% else %}
                                <span style="background-color: #3498db; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.15rem;">U</span>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td style="padding: 0.75rem; text-align: center;">
                        <span style="
                            background-color: {% if stat.status == 'Approved' %}#2ecc71{% elif stat.status == 'Pending' %}#f39c12{% elif stat.status == 'Rejected' %}#e74c3c{% else %}#7f8c8d{% endif %};
                            color: white;
                            padding: 0.15rem 0.4rem;
                            border-radius: 3px;
                            font-size: 0.75rem;
                        ">{{ stat.status }}</span>
                    </td>
                    <td style="padding: 0.75rem; text-align: center; font-size: 1.2rem;">
                        {% if stat.is_online %}
                            <span style="color: #27ae60; font-weight: bold;">●</span>
                        {% else %}
                            <span style="color: #95a5a6;">○</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem;">
                        {% if stat.last_activity %}
                            {{ stat.last_activity|date:"M d, Y H:i" }}
                        {% else %}
                            <span style="color: #7f8c8d;">Never</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem; text-align: center;">{{ stat.page_views_all_time }}</td>
                    <td style="padding: 0.75rem; text-align: center;">{{ stat.queue_entries_all_time }}</td>
                    <td style="padding: 0.75rem; text-align: center;">{{ stat.feedback_all_time }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" style="padding: 1rem; text-align: center; color: #7f8c8d;">No user data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Legend -->
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
        <p style="color: #7f8c8d; margin: 0; font-size: 0.85rem;">
            <strong>Online Status:</strong>
            <span style="color: #27ae60; font-weight: bold;">●</span> Online now (active in last 15 min) |
            <span style="color: #95a5a6;">○</span> Offline |
            <span style="background-color: #e8f8f5; padding: 0.2rem 0.4rem; border-radius: 3px;">Green background</span> = Currently online
        </p>
        <p style="color: #7f8c8d; margin: 0.5rem 0 0 0; font-size: 0.85rem;">
            <strong>Role Key:</strong>
            <span style="background-color: #e74c3c; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem;">A</span> = Admin |
            <span style="background-color: #9b59b6; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem;">D</span> = Developer |
            <span style="background-color: #f39c12; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem;">S</span> = Staff |
            <span style="background-color: #3498db; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem;">U</span> = User
        </p>
    </div>
</div>

<script>
function clearFilters() {
    // Clear search input
    document.getElementById('search').value = '';
    // Submit the form to refresh with cleared filters
    document.querySelector('form').submit();
}

function editSelectedUser() {
    const userSelect = document.getElementById('user_select');
    const userId = userSelect.value;

    if (!userId) {
        alert('Please select a user to edit.');
        return;
    }

    // Navigate to the edit page for the selected user
    window.location.href = `/schedule/admin-users/edit-user-info/${userId}/`;
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Save scroll position before any form submission
    const forms = document.querySelectorAll('form[method="post"]');
    forms.forEach(function(form) {
        form.addEventListener('submit', function() {
            sessionStorage.setItem('adminUsersScrollPosition', window.scrollY);
        });
    });

    // Restore scroll position after page load
    const savedPosition = sessionStorage.getItem('adminUsersScrollPosition');
    if (savedPosition) {
        window.scrollTo(0, parseInt(savedPosition));
        sessionStorage.removeItem('adminUsersScrollPosition');
    }

    // Thanos modal handlers
    const modal = document.getElementById('thanosModal');
    const message = document.getElementById('thanosMessage');
    const btnYes = document.getElementById('thanosYes');
    const btnNo = document.getElementById('thanosNo');
    const btnClose = document.getElementById('thanosClose');
    let currentForm = null;

    // Open modal when delete button clicked
    document.querySelectorAll('.delete-user-form button').forEach(btn => {
        btn.addEventListener('click', function() {
            currentForm = this.closest('form');
            const username = currentForm.getAttribute('data-username');
            message.textContent = `Are you sure you want to delete the account of user "${username}"?`;
            modal.style.display = 'flex';
        });
    });

    // Yes button: submit form
    btnYes.addEventListener('click', function() {
        if(currentForm) {
            // Save scroll position before submit
            sessionStorage.setItem('adminUsersScrollPosition', window.scrollY);
            currentForm.submit();
        }
    });

    // No button: close modal
    btnNo.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // Close icon
    btnClose.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // Click outside modal content closes
    modal.addEventListener('click', function(e) {
        if(e.target === modal) modal.style.display = 'none';
    });
});
</script>

{% endblock %}
