{% extends 'base.html' %}

{% block title %}Database Management - Lab Equipment Queue{% endblock %}

{% block content %}
<div class="card">
    <h1>Database Management</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">Manage database storage and archived measurements.</p>
</div>

<!-- Storage Statistics -->
<div class="card" style="border-left: 4px solid {% if storage_stats.status == 'critical' %}#e74c3c{% elif storage_stats.status == 'warning' %}#f39c12{% else %}#2ecc71{% endif %};">
    <h2 style="margin-top: 0;">Database Storage</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
        <div>
            <p style="color: #7f8c8d; margin: 0;">Current Size</p>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">{{ storage_stats.current_size_mb }} MB</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin: 0;">Maximum Size</p>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">{{ storage_stats.max_size_mb }} MB</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin: 0;">Used</p>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0; color: {% if storage_stats.status == 'critical' %}#e74c3c{% elif storage_stats.status == 'warning' %}#f39c12{% else %}#2ecc71{% endif %};">
                {{ storage_stats.used_percentage }}%
            </p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin: 0;">Available</p>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">{{ storage_stats.available_mb }} MB</p>
        </div>
    </div>

    <!-- Progress Bar -->
    <div style="background: #ecf0f1; height: 30px; border-radius: 5px; overflow: hidden; margin: 1rem 0;">
        <div style="
            width: {{ storage_stats.used_percentage }}%;
            height: 100%;
            background: {% if storage_stats.status == 'critical' %}#e74c3c{% elif storage_stats.status == 'warning' %}#f39c12{% else %}#2ecc71{% endif %};
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        ">
            {{ storage_stats.used_percentage }}%
        </div>
    </div>

    {% if storage_stats.status == 'critical' %}
    <div style="background: #fee; border-left: 4px solid #e74c3c; padding: 1rem; margin-top: 1rem;">
        <strong style="color: #e74c3c;">CRITICAL:</strong> Database is at {{ storage_stats.used_percentage }}% capacity.
        Please export and clear old archived measurements immediately.
    </div>
    {% elif storage_stats.status == 'warning' %}
    <div style="background: #fef9e7; border-left: 4px solid #f39c12; padding: 1rem; margin-top: 1rem;">
        <strong style="color: #f39c12;">WARNING:</strong> Database is at {{ storage_stats.used_percentage }}% capacity.
        Consider exporting and clearing old archived measurements soon.
    </div>
    {% endif %}
</div>

<!-- Storage Breakdown -->
<div class="card">
    <h2 style="margin-top: 0;">Storage Breakdown</h2>
    <p style="color: #7f8c8d; margin-bottom: 1rem;">Detailed breakdown of database storage by category.</p>

    <div class="table-container">
        <table class="styled-table">
            <thead>
                <tr>
                    <th style="text-align: left;">Category</th>
                    <th style="text-align: center;">Records</th>
                    <th style="text-align: center;">Estimated Size</th>
                    <th style="text-align: center;">Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for key, item in storage_breakdown.items %}
                <tr>
                    <td style="text-align: left;">{{ item.name }}</td>
                    <td style="text-align: center;">{{ item.row_count|default:"0" }}</td>
                    <td style="text-align: center;">{{ item.estimated_size_mb }} MB</td>
                    <td style="text-align: center;">{{ item.percentage }}%</td>
                </tr>
                {% endfor %}
                <tr style="border-top: 2px solid #34495e; font-weight: bold; background: #f8f9fa;">
                    <td style="text-align: left;">Total Application Data</td>
                    <td style="text-align: center;">—</td>
                    <td style="text-align: center;">{{ total_estimated_mb }} MB</td>
                    <td style="text-align: center;">100%</td>
                </tr>
                <tr style="background: #fff3cd;">
                    <td style="text-align: left;">Database Overhead</td>
                    <td style="text-align: center;">—</td>
                    <td style="text-align: center;">{{ overhead_mb }} MB</td>
                    <td style="text-align: center;">—</td>
                </tr>
                <tr style="border-top: 2px solid #34495e; font-weight: bold; background: #e8f5e9;">
                    <td style="text-align: left;">Actual Database Size</td>
                    <td style="text-align: center;">—</td>
                    <td style="text-align: center;">{{ storage_stats.current_size_mb }} MB</td>
                    <td style="text-align: center;">—</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; margin-top: 1rem;">
        <p style="margin: 0 0 0.5rem 0; color: #1976d2;">
            <strong>About Database Overhead:</strong>
        </p>
        <p style="margin: 0; color: #1976d2; font-size: 0.95rem;">
            The difference between application data ({{ total_estimated_mb }} MB) and actual database size ({{ storage_stats.current_size_mb }} MB)
            is <strong>{{ overhead_mb }} MB</strong> of PostgreSQL overhead, which includes:
        </p>
        <ul style="margin: 0.5rem 0 0 1.5rem; color: #1976d2; font-size: 0.95rem;">
            <li><strong>Indexes</strong> - Primary keys, foreign keys, and custom indexes (typically 30-50% of total size)</li>
            <li><strong>Django system tables</strong> - Migrations, sessions, permissions, content types, admin logs</li>
            <li><strong>PostgreSQL overhead</strong> - TOAST storage, free space maps, visibility maps, dead tuples</li>
        </ul>
    </div>
</div>

<!-- Archive Statistics -->
<div class="card">
    <h2 style="margin-top: 0;">Archived Measurements</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
        <div>
            <p style="color: #7f8c8d; margin: 0;">Total Records</p>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">{{ archive_count }}</p>
        </div>
        <div>
            <p style="color: #7f8c8d; margin: 0;">Estimated Size</p>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">~{{ estimated_archive_size_mb }} MB</p>
        </div>
    </div>
</div>

<!-- Export Full Database Backup -->
<div class="card" style="border-left: 4px solid #8e44ad;">
    <h2 style="margin-top: 0; color: #8e44ad;">Export Full Database Backup</h2>
    <p style="color: #7f8c8d;">Download a complete backup of the entire database for disaster recovery.</p>

    <div style="margin-top: 1rem;">
        <a href="{% url 'admin_export_full_database' %}" class="btn" style="background: #8e44ad;">
            Export Complete Database
        </a>
    </div>

    <p style="color: #7f8c8d; margin-top: 1rem; font-size: 0.9rem;">
        Includes all data: users, machines, queue entries, presets, archived measurements, and notifications.
        Recommended before major system changes or monthly for backups.
    </p>
</div>

<!-- Cloud Backups (GitHub) -->
<div class="card" style="border-left: 4px solid #2ecc71;">
    <h2 style="margin-top: 0; color: #2ecc71;">Cloud Backups</h2>
    <p style="color: #7f8c8d;">Automated nightly backups stored in GitHub. These run daily at 12:30 AM Central.</p>

    <div id="cloudBackupsContainer" style="margin-top: 1rem;">
        <p style="color: #7f8c8d;"><em>Loading cloud backups...</em></p>
    </div>

    <div id="cloudBackupsError" style="display: none; background: #fee; border-left: 4px solid #e74c3c; padding: 1rem; margin-top: 1rem;">
    </div>
</div>

<script>
// Load cloud backups from GitHub
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('cloudBackupsContainer');
    const errorDiv = document.getElementById('cloudBackupsError');

    fetch('{% url "admin_list_github_backups" %}')
        .then(response => {
            // Check if response is OK before parsing JSON
            if (!response.ok) {
                // If redirected to login page (HTML response), show auth error
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Session expired or authentication required. Please refresh the page.');
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                errorDiv.innerHTML = `<strong style="color: #e74c3c;">Error:</strong> ${data.error}`;
                errorDiv.style.display = 'block';
                container.innerHTML = '';
                return;
            }

            if (data.message) {
                container.innerHTML = `<p style="color: #7f8c8d;">${data.message}</p>`;
                return;
            }

            if (!data.backups || data.backups.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d;">No cloud backups found yet. Backups run nightly at 12:30 AM Central.</p>';
                return;
            }

            // Build table of backups
            let html = `
                <div class="table-container">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Backup Date</th>
                                <th style="text-align: center;">Size</th>
                                <th style="text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.backups.forEach(backup => {
                // Parse date from filename: database_backup_2024-01-15_06-30-00.json
                const match = backup.name.match(/database_backup_(\d{4}-\d{2}-\d{2})_(\d{2})-(\d{2})-(\d{2})\.json/);
                let dateStr = backup.name;
                if (match) {
                    const date = new Date(`${match[1]}T${match[2]}:${match[3]}:${match[4]}Z`);
                    dateStr = date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                }

                // Format size
                const sizeKB = (backup.size / 1024).toFixed(1);
                const sizeStr = backup.size > 1024 * 1024
                    ? `${(backup.size / 1024 / 1024).toFixed(2)} MB`
                    : `${sizeKB} KB`;

                const downloadUrl = `/schedule/admin/github-backups/download/${encodeURIComponent(backup.name)}/`;
                html += `
                    <tr>
                        <td style="text-align: left;">${dateStr}</td>
                        <td style="text-align: center;">${sizeStr}</td>
                        <td style="text-align: center;">
                            <a href="${downloadUrl}"
                               class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.85rem; background: #2ecc71;">
                                Download
                            </a>
                            <button type="button"
                               class="btn restore-cloud-btn"
                               data-filename="${backup.name}"
                               data-date="${dateStr}"
                               style="padding: 0.3rem 0.6rem; font-size: 0.85rem; background: #e67e22; margin-left: 0.5rem;">
                                Restore
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <p style="color: #7f8c8d; margin-top: 1rem; font-size: 0.9rem;">
                    Last ${data.backups.length} backups shown. Click "Restore" to restore directly from a cloud backup.
                </p>
            `;

            container.innerHTML = html;

            // Add event listeners to restore buttons
            container.querySelectorAll('.restore-cloud-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filename = this.dataset.filename;
                    const dateStr = this.dataset.date;
                    openCloudRestoreModal(filename, dateStr);
                });
            });
        })
        .catch(error => {
            errorDiv.innerHTML = `<strong style="color: #e74c3c;">Network Error:</strong> ${error.message}`;
            errorDiv.style.display = 'block';
            container.innerHTML = '';
        });
});
</script>

<!-- Export Archive Measurements -->
<div class="card" style="border-left: 4px solid #3498db;">
    <h2 style="margin-top: 0; color: #3498db;">Export Archived Measurements</h2>
    <p style="color: #7f8c8d;">Download archived measurement records only.</p>

    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <a href="{% url 'admin_export_archive' %}?format=json" class="btn" style="background: #3498db;">
            Export as JSON ({{ archive_count }} records)
        </a>
        <a href="{% url 'admin_export_archive' %}?format=csv" class="btn" style="background: #27ae60;">
            Export as CSV ({{ archive_count }} records)
        </a>
    </div>

    <p style="color: #7f8c8d; margin-top: 1rem; font-size: 0.9rem;">
        JSON format preserves all data. CSV format is easier to view in spreadsheets.
    </p>
</div>

<!-- Import/Restore Database -->
<div class="card" style="border-left: 4px solid #e67e22;">
    <h2 style="margin-top: 0; color: #e67e22;">Import/Restore Database</h2>
    <p style="color: #7f8c8d;">Upload a backup file to restore database state.</p>

    <form id="importForm" style="margin-top: 1rem;">
        {% csrf_token %}
        <div style="margin-bottom: 1rem;">
            <label for="backupFile" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                Select Backup File (.json):
            </label>
            <input type="file" id="backupFile" name="backup_file" accept=".json" style="padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px;">
        </div>

        <div style="margin-bottom: 1rem;">
            <label for="importMode" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                Import Mode:
            </label>
            <select id="importMode" name="import_mode" style="padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px; width: 100%; max-width: 400px;">
                <option value="merge">Merge - Keep existing data, add new records (safer)</option>
                <option value="replace">Replace - Clear database and restore (WARNING: destructive)</option>
            </select>
        </div>

        <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.9rem;">
            <strong>Merge mode:</strong> Existing records are preserved, only missing records are added.<br>
            <strong>Replace mode:</strong> All data is cleared before restoring (except superusers).
        </p>

        <button type="button" id="openImportModal" class="btn" style="background: #e67e22;">
            Import Database Backup
        </button>
    </form>
</div>

<!-- Clear Archive -->
<div class="card" style="border-left: 4px solid #e74c3c;">
    <h2 style="margin-top: 0; color: #e74c3c;">Clear Archive (Danger Zone)</h2>
    <p style="color: #7f8c8d;">Permanently delete all archived measurements to free up database space.</p>

    {% if archive_count == 0 %}
    <div style="background: #e8f5e9; border-left: 4px solid #2ecc71; padding: 1rem; margin: 1rem 0;">
        <strong style="color: #2ecc71;">Archive is empty.</strong> No measurements to clear.
    </div>
    {% else %}
    <div style="background: #fee; border: 2px solid #e74c3c; padding: 1.5rem; border-radius: 5px; margin-top: 1rem;">
        <h3 style="margin-top: 0; color: #e74c3c;">WARNING: This action cannot be undone!</h3>

        <ul style="color: #7f8c8d;">
            <li>This will permanently delete <strong>{{ archive_count }} archived measurements</strong></li>
            <li><strong>Automatic backup will be downloaded</strong> before deletion</li>
            <li>All users will be notified that the archive was cleared</li>
            <li>Users should contact you for old data if needed</li>
        </ul>

        <div style="margin-top: 1rem;">
            <button id="openThanosModal" class="btn" style="background: #e74c3c;">
                Delete All {{ archive_count }} Archived Measurements
            </button>
            <a href="{% url 'admin_dashboard' %}" class="btn" style="background: #95a5a6; margin-left: 0.5rem;">
                Cancel
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Thanos Delete Confirmation Modal -->
{% load static %}
<div id="thanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p style="font-weight:bold; margin-bottom:1rem; font-size:1.1rem; color: #e74c3c;">
            Are you absolutely sure you want to delete {{ archive_count }} archived measurements?
        </p>
        <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.9rem;">
            A backup will be downloaded automatically before deletion.
        </p>

        <label for="thanosConfirmation" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
            Type <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">CONFIRM DELETE</code>:
        </label>
        <input
            type="text"
            id="thanosConfirmation"
            style="width: 100%; max-width: 300px; padding: 0.5rem; border: 2px solid #e74c3c; border-radius: 5px; font-family: monospace; margin-bottom: 1rem;"
            placeholder="CONFIRM DELETE"
        >
        <div id="thanosError" style="color: #e74c3c; font-size: 0.9rem; margin-bottom: 1rem; display: none;"></div>

        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="thanosYes" class="btn" style="background: #e74c3c;">Yes, snap it away</button>
            <button id="thanosNo" class="btn" style="background: #95a5a6;">No, spare the archive</button>
        </div>
        <span id="thanosClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<div class="card">
    <a href="{% url 'admin_dashboard' %}" class="btn" style="background: #95a5a6;">
        ← Back to Dashboard
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('thanosModal');
    const openBtn = document.getElementById('openThanosModal');
    const confirmInput = document.getElementById('thanosConfirmation');
    const errorDiv = document.getElementById('thanosError');
    const btnYes = document.getElementById('thanosYes');
    const btnNo = document.getElementById('thanosNo');
    const btnClose = document.getElementById('thanosClose');

    if (!openBtn) return; // Archive is empty, no button

    // Open Thanos modal
    openBtn.addEventListener('click', function() {
        modal.style.display = 'flex';
        confirmInput.value = '';
        errorDiv.style.display = 'none';
        confirmInput.focus();
    });

    // Close modal
    function closeModal() {
        modal.style.display = 'none';
        confirmInput.value = '';
        errorDiv.style.display = 'none';
    }

    btnNo.addEventListener('click', closeModal);
    btnClose.addEventListener('click', closeModal);

    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Yes button: Download backup, then delete
    btnYes.addEventListener('click', function() {
        const confirmation = confirmInput.value.trim();

        if (confirmation !== 'CONFIRM DELETE') {
            errorDiv.textContent = 'Incorrect confirmation text. Please type exactly "CONFIRM DELETE".';
            errorDiv.style.display = 'block';
            return;
        }

        // Disable button to prevent double-click
        btnYes.disabled = true;
        btnYes.textContent = 'Downloading backup...';

        // Step 1: Download backup automatically
        const backupUrl = '{% url "admin_clear_archive_with_backup" %}';
        const backupLink = document.createElement('a');
        backupLink.href = backupUrl;
        backupLink.download = 'archive_backup_before_delete.json';
        document.body.appendChild(backupLink);
        backupLink.click();
        document.body.removeChild(backupLink);

        // Wait 1 second for download to start, then delete
        setTimeout(function() {
            btnYes.textContent = 'Deleting...';

            // Step 2: Submit delete request via AJAX
            fetch('{% url "admin_clear_archive" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'confirmation=' + encodeURIComponent(confirmation)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ Success: ${data.message}`);
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Unknown error occurred';
                    errorDiv.style.display = 'block';
                    btnYes.disabled = false;
                    btnYes.textContent = 'Yes, snap it away';
                }
            })
            .catch(error => {
                errorDiv.textContent = 'Network error: ' + error.message;
                errorDiv.style.display = 'block';
                btnYes.disabled = false;
                btnYes.textContent = 'Yes, snap it away';
            });
        }, 1000); // 1 second delay for backup download
    });

    // Allow Enter key to confirm
    confirmInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            btnYes.click();
        }
    });
});

// Import Database Modal Handlers
document.addEventListener('DOMContentLoaded', function() {
    const openImportBtn = document.getElementById('openImportModal');
    const importModal = document.getElementById('importThanosModal');
    const importConfirmInput = document.getElementById('importConfirmation');
    const importErrorDiv = document.getElementById('importError');
    const importYesBtn = document.getElementById('importYes');
    const importNoBtn = document.getElementById('importNo');
    const importCloseBtn = document.getElementById('importClose');
    const backupFileInput = document.getElementById('backupFile');
    const importModeSelect = document.getElementById('importMode');
    const importMessage = document.getElementById('importMessage');

    if (!openImportBtn) return; // Element not found

    // Open import modal
    openImportBtn.addEventListener('click', function() {
        // Validate file selection
        if (!backupFileInput.files || backupFileInput.files.length === 0) {
            alert('Please select a backup file first.');
            return;
        }

        const fileName = backupFileInput.files[0].name;
        const importMode = importModeSelect.value;
        const modeName = importMode === 'replace' ? 'REPLACE mode (DESTRUCTIVE)' : 'MERGE mode (safe)';

        importMessage.innerHTML = `Are you sure you want to restore database from:<br><strong>${fileName}</strong><br>Mode: <strong>${modeName}</strong>`;
        importConfirmInput.value = '';
        importErrorDiv.style.display = 'none';
        importModal.style.display = 'flex';
        importConfirmInput.focus();
    });

    // Close modal
    function closeImportModal() {
        importModal.style.display = 'none';
        importConfirmInput.value = '';
        importErrorDiv.style.display = 'none';
    }

    importNoBtn.addEventListener('click', closeImportModal);
    importCloseBtn.addEventListener('click', closeImportModal);

    // Close on background click
    importModal.addEventListener('click', function(e) {
        if (e.target === importModal) {
            closeImportModal();
        }
    });

    // Yes button: Confirm and import
    importYesBtn.addEventListener('click', function() {
        const confirmation = importConfirmInput.value.trim();

        if (confirmation !== 'CONFIRM RESTORE') {
            importErrorDiv.textContent = 'Incorrect confirmation text. Please type exactly "CONFIRM RESTORE".';
            importErrorDiv.style.display = 'block';
            return;
        }

        // Disable button to prevent double-click
        importYesBtn.disabled = true;
        importYesBtn.textContent = 'Importing...';

        // Prepare form data
        const formData = new FormData();
        formData.append('backup_file', backupFileInput.files[0]);
        formData.append('import_mode', importModeSelect.value);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        // Submit import request via AJAX
        fetch('{% url "admin_import_database" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeImportModal();
                alert(`Success: ${data.message}`);
                window.location.reload();
            } else {
                importErrorDiv.textContent = data.error || 'Unknown error occurred';
                importErrorDiv.style.display = 'block';
                importYesBtn.disabled = false;
                importYesBtn.textContent = 'Yes, restore database';
            }
        })
        .catch(error => {
            importErrorDiv.textContent = 'Network error: ' + error.message;
            importErrorDiv.style.display = 'block';
            importYesBtn.disabled = false;
            importYesBtn.textContent = 'Yes, restore database';
        });
    });

    // Allow Enter key to confirm
    importConfirmInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            importYesBtn.click();
        }
    });
});
</script>

<!-- Import/Restore Thanos Confirmation Modal -->
<div id="importThanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p id="importMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1.1rem; color: #e67e22;"></p>

        <label for="importConfirmation" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
            Type <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">CONFIRM RESTORE</code>:
        </label>
        <input
            type="text"
            id="importConfirmation"
            style="width: 100%; max-width: 300px; padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px; font-family: monospace; margin-bottom: 1rem;"
            placeholder="CONFIRM RESTORE"
        >
        <div id="importError" style="color: #e74c3c; font-size: 0.9rem; margin-bottom: 1rem; display: none;"></div>

        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="importYes" class="btn" style="background: #e67e22;">Yes, restore database</button>
            <button id="importNo" class="btn" style="background: #95a5a6;">No, cancel</button>
        </div>
        <span id="importClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<!-- Cloud Restore Confirmation Modal -->
<div id="cloudRestoreModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p id="cloudRestoreMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1.1rem; color: #e67e22;"></p>

        <div style="margin-bottom: 1rem; text-align: left;">
            <label for="cloudRestoreMode" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                Restore Mode:
            </label>
            <select id="cloudRestoreMode" style="width: 100%; padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px;">
                <option value="merge">Merge - Keep existing data, add new records (safer)</option>
                <option value="replace">Replace - Clear database and restore (WARNING: destructive)</option>
            </select>
        </div>

        <label for="cloudRestoreConfirmation" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
            Type <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">CONFIRM RESTORE</code>:
        </label>
        <input
            type="text"
            id="cloudRestoreConfirmation"
            style="width: 100%; max-width: 300px; padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px; font-family: monospace; margin-bottom: 1rem;"
            placeholder="CONFIRM RESTORE"
        >
        <div id="cloudRestoreError" style="color: #e74c3c; font-size: 0.9rem; margin-bottom: 1rem; display: none;"></div>

        <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.9rem;">
            <strong>Note:</strong> All users will be notified about this restore.
        </p>

        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="cloudRestoreYes" class="btn" style="background: #e67e22;">Yes, restore from cloud</button>
            <button id="cloudRestoreNo" class="btn" style="background: #95a5a6;">No, cancel</button>
        </div>
        <span id="cloudRestoreClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<script>
// Cloud Restore Modal Handlers
let pendingCloudRestoreFilename = null;

function openCloudRestoreModal(filename, dateStr) {
    const modal = document.getElementById('cloudRestoreModal');
    const message = document.getElementById('cloudRestoreMessage');
    const confirmInput = document.getElementById('cloudRestoreConfirmation');
    const errorDiv = document.getElementById('cloudRestoreError');

    pendingCloudRestoreFilename = filename;
    message.innerHTML = `Restore database from cloud backup:<br><strong>${dateStr}</strong>`;
    confirmInput.value = '';
    errorDiv.style.display = 'none';
    modal.style.display = 'flex';
    confirmInput.focus();
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('cloudRestoreModal');
    const confirmInput = document.getElementById('cloudRestoreConfirmation');
    const errorDiv = document.getElementById('cloudRestoreError');
    const modeSelect = document.getElementById('cloudRestoreMode');
    const btnYes = document.getElementById('cloudRestoreYes');
    const btnNo = document.getElementById('cloudRestoreNo');
    const btnClose = document.getElementById('cloudRestoreClose');

    // Close modal
    function closeCloudRestoreModal() {
        modal.style.display = 'none';
        confirmInput.value = '';
        errorDiv.style.display = 'none';
        pendingCloudRestoreFilename = null;
    }

    btnNo.addEventListener('click', closeCloudRestoreModal);
    btnClose.addEventListener('click', closeCloudRestoreModal);

    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeCloudRestoreModal();
        }
    });

    // Yes button: Confirm and restore from cloud
    btnYes.addEventListener('click', function() {
        const confirmation = confirmInput.value.trim();

        if (confirmation !== 'CONFIRM RESTORE') {
            errorDiv.textContent = 'Incorrect confirmation text. Please type exactly "CONFIRM RESTORE".';
            errorDiv.style.display = 'block';
            return;
        }

        if (!pendingCloudRestoreFilename) {
            errorDiv.textContent = 'No backup file selected.';
            errorDiv.style.display = 'block';
            return;
        }

        // Disable button to prevent double-click
        btnYes.disabled = true;
        btnYes.textContent = 'Restoring...';

        // Prepare form data
        const formData = new FormData();
        formData.append('import_mode', modeSelect.value);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        // Submit restore request via AJAX
        const restoreUrl = `/schedule/admin/github-backups/restore/${encodeURIComponent(pendingCloudRestoreFilename)}/`;

        fetch(restoreUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeCloudRestoreModal();
                alert(`Success: ${data.message}\n\nAll users have been notified.`);
                window.location.reload();
            } else {
                errorDiv.textContent = data.error || 'Unknown error occurred';
                errorDiv.style.display = 'block';
                btnYes.disabled = false;
                btnYes.textContent = 'Yes, restore from cloud';
            }
        })
        .catch(error => {
            errorDiv.textContent = 'Network error: ' + error.message;
            errorDiv.style.display = 'block';
            btnYes.disabled = false;
            btnYes.textContent = 'Yes, restore from cloud';
        });
    });

    // Allow Enter key to confirm
    confirmInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            btnYes.click();
        }
    });
});
</script>

{% endblock %}
