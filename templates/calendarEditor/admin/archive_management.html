{% extends 'base.html' %}

{% block title %}Database Management - Lab Equipment Queue{% endblock %}

{% block content %}

<style>
    /* Collapsible card styles - fridges pattern */
    .card-header {
        cursor: pointer;
        user-select: none;
    }

    .card-details {
        padding: 1.5rem;
        border-top: 1px solid #ddd;
        display: none;
    }

    .card-details.open {
        display: block;
    }

    .expand-icon {
        font-size: 1.2rem;
        transition: transform 0.3s;
        display: inline-block;
    }

    .expand-icon.open {
        transform: rotate(180deg);
    }
</style>

<div class="card">
    <h1>Database Management</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">Manage database storage and archived measurements.</p>
</div>

<!-- Turso Usage Metrics (Default: OPEN) -->
<div class="card" style="border-left: 4px solid #1abc9c;">
    <div class="card-header" onclick="toggleCard('turso-usage')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #1abc9c;">Turso Usage Metrics (Current Billing Cycle)</h2>
            <span class="expand-icon open" id="icon-turso-usage">▼</span>
        </div>
    </div>
    <div class="card-details open" id="details-turso-usage">
        {% if turso_usage %}
            <p style="color: #7f8c8d; margin-bottom: 1.5rem;">
                Real-time usage data from Turso API.
                <a href="https://turso.tech/app/{{ turso_org_slug }}/usage" target="_blank" style="color: #3498db;">View full dashboard →</a>
            </p>

            <!-- Rows Read -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <strong>Rows Read (Monthly)</strong>
                    <span>{{ turso_usage.rows_read|floatformat:0 }} / {{ turso_limits.rows_read_monthly|floatformat:0 }}</span>
                </div>
                <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: {% if turso_usage.rows_read_percent >= 90 %}#e74c3c{% elif turso_usage.rows_read_percent >= 75 %}#f39c12{% else %}#3498db{% endif %};
                                height: 100%; width: {{ turso_usage.rows_read_percent|floatformat:1 }}%;"></div>
                </div>
                <small style="color: #7f8c8d;">{{ turso_usage.rows_read_percent|floatformat:1 }}% used</small>
            </div>

            <!-- Rows Written -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <strong>Rows Written (Monthly)</strong>
                    <span>{{ turso_usage.rows_written|floatformat:0 }} / {{ turso_limits.rows_written_monthly|floatformat:0 }}</span>
                </div>
                <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: {% if turso_usage.rows_written_percent >= 90 %}#e74c3c{% elif turso_usage.rows_written_percent >= 75 %}#f39c12{% else %}#9b59b6{% endif %};
                                height: 100%; width: {{ turso_usage.rows_written_percent|floatformat:1 }}%;"></div>
                </div>
                <small style="color: #7f8c8d;">{{ turso_usage.rows_written_percent|floatformat:1 }}% used</small>
            </div>

            <!-- Storage -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <strong>Storage</strong>
                    <span>{{ turso_usage.storage_mb|floatformat:2 }} MB / {{ turso_limits.storage_mb|floatformat:0 }} MB</span>
                </div>
                <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: {% if turso_usage.storage_percent >= 90 %}#e74c3c{% elif turso_usage.storage_percent >= 75 %}#f39c12{% else %}#1abc9c{% endif %};
                                height: 100%; width: {{ turso_usage.storage_percent|floatformat:1 }}%;"></div>
                </div>
                <small style="color: #7f8c8d;">{{ turso_usage.storage_percent|floatformat:1 }}% used</small>
            </div>

            <!-- Databases -->
            <div>
                <strong>Total Databases:</strong> {{ turso_usage.databases }}
            </div>
        {% else %}
            <p style="color: #e74c3c;">
                Unable to fetch Turso usage metrics. Please verify these are set correctly in the Render environment:
                <br><code>TURSO_ORG_SLUG</code> and <code>TURSO_API_TOKEN</code> environment variables.
            </p>
            <p style="color: #7f8c8d; font-size: 0.9rem;">
                Get your organization slug from: <a href="https://turso.tech/dashboard" target="_blank">Turso Dashboard</a>
            </p>
        {% endif %}
    </div>
</div>

<!-- Cloud Backups (GitHub) (Default: OPEN) -->
<div class="card" style="border-left: 4px solid #f432f4;">
    <div class="card-header" onclick="toggleCard('cloud-backups')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #f432f4;">Cloud Backups</h2>
            <span class="expand-icon open" id="icon-cloud-backups">▼</span>
        </div>
    </div>
    <div class="card-details open" id="details-cloud-backups">
        <p style="color: #7f8c8d;">Automated nightly backups stored in GitHub. These run daily at 12:30 AM Central. Keeps the 90 most recent.</p>

        <!-- Month selector dropdown -->
        <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
            <label for="cloudBackupMonthSelect" style="font-weight: bold; white-space: nowrap;">View month:</label>
            <select id="cloudBackupMonthSelect" style="padding: 0.5rem; border: 2px solid #f432f4; border-radius: 5px; flex: 1; max-width: 200px;">
                <option value="loading">Loading...</option>
            </select>
            <button id="openBackupSelectorBtn" class="btn" style="background: #3498db; padding: 0.5rem 1rem;">
                Browse All
            </button>
        </div>

        <!-- Horizontally scrollable card container -->
        <div id="cloudBackupsScrollContainer" style="
            overflow-x: auto;
            white-space: nowrap;
            padding: 1rem 0;
            margin: 0 -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
        ">
            <p style="color: #7f8c8d;"><em>Loading cloud backups...</em></p>
        </div>

        <div id="cloudBackupsError" style="display: none; background: #fee; border-left: 4px solid #e74c3c; padding: 1rem; margin-top: 1rem;">
        </div>

        <p id="cloudBackupsCount" style="color: #7f8c8d; margin-top: 0.5rem; font-size: 0.9rem;"></p>
    </div>
</div>


<!-- Storage Breakdown (Default: COLLAPSED) -->
<div class="card">
    <div class="card-header" onclick="toggleCard('storage-breakdown')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">Storage Breakdown</h2>
            <span class="expand-icon" id="icon-storage-breakdown">▼</span>
        </div>
    </div>
    <div class="card-details" id="details-storage-breakdown">
        <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.95rem;">
            Estimated storage breakdown by model/table. Actual sizes may vary by ±20-30% due to SQLite indexes,
            system tables (django_migrations, django_session, etc.), and database overhead.
        </p>
        
        <div class="table-container">
            <table class="styled-table">
                <thead>
                    <tr>
                        <th style="text-align: left;">Category</th>
                        <th style="text-align: center;">Records</th>
                        <th style="text-align: center;">Estimated Size</th>
                        <th style="text-align: center;">Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, item in storage_breakdown.items %}
                    <tr>
                        <td style="text-align: left;">{{ item.name }}</td>
                        <td style="text-align: center;">{{ item.row_count|default:"0" }}</td>
                        <td style="text-align: center;">{{ item.estimated_size_mb }} MB</td>
                        <td style="text-align: center;">{{ item.percentage }}%</td>
                    </tr>
                    {% endfor %}
                    <tr style="border-top: 2px solid #34495e; font-weight: bold; background: #f8f9fa;">
                        <td style="text-align: left;">Total Application Data</td>
                        <td style="text-align: center;">—</td>
                        <td style="text-align: center;">{{ total_estimated_mb }} MB</td>
                        <td style="text-align: center;">100%</td>
                    </tr>
                    <tr style="border-top: 2px solid #34495e; font-weight: bold; background: #e8f5e9;">
                        <td style="text-align: left;">Estimated Database Size</td>
                        <td style="text-align: center;">—</td>
                        <td style="text-align: center;">{{ storage_stats.current_size_mb }} MB</td>
                        <td style="text-align: center;">—</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 1rem;">
            <strong>Note:</strong> Estimates are based on average row sizes multiplied by record counts,
            plus 40% overhead for SQLite indexes, WAL files, and system tables.
            For exact storage usage, check the Turso dashboard above.
        </p>
    </div>
</div>
<!-- Import/Restore Database (Default: COLLAPSED) -->
<div class="card" style="border-left: 4px solid #e67e22;">
    <div class="card-header" onclick="toggleCard('import-restore')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #e67e22;">Import/Restore Database</h2>
            <span class="expand-icon" id="icon-import-restore">▼</span>
        </div>
    </div>
    <div class="card-details" id="details-import-restore">
        <p style="color: #7f8c8d;">Upload a backup file to restore database state.</p>
        
        <form id="importForm" style="margin-top: 1rem;">
            {% csrf_token %}
            <div style="margin-bottom: 1rem;">
                <label for="backupFile" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                    Select Backup File (.json):
                </label>
                <input type="file" id="backupFile" name="backup_file" accept=".json" style="padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label for="importMode" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                    Import Mode:
                </label>
                <select id="importMode" name="import_mode" style="padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px; width: 100%; max-width: 400px;">
                    <option value="merge">Merge - Keep existing data, add new records (safer)</option>
                    <option value="replace">Replace - Clear database and restore (WARNING: destructive)</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="silentRestore" name="silent_restore" value="true" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: bold;">Silent Restore (don't notify users)</span>
                </label>
                <p style="color: #7f8c8d; margin: 0.5rem 0 0 0; font-size: 0.85rem; padding-left: 1.75rem;">
                    When checked, users will NOT receive notifications about this database restore.
                </p>
            </div>

            <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.9rem;">
                <strong>Merge mode:</strong> Existing records are preserved, only missing records are added.<br>
                <strong>Replace mode:</strong> All data is cleared before restoring (except superusers).
            </p>

            <button type="button" id="openImportModal" class="btn" style="background: #e67e22;">
                Import Database Backup
            </button>
        </form>
    </div>
</div>

<!-- Backup Selector Modal -->
<div id="backupSelectorModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:600px; width:90%; max-height:80vh; display:flex; flex-direction:column; position:relative;">
        <h3 style="margin-top: 0; color: #2ecc71;">Select Cloud Backup</h3>

        <!-- Month filter in modal -->
        <div style="margin-bottom: 1rem;">
            <select id="modalMonthSelect" style="padding: 0.5rem; border: 2px solid #2ecc71; border-radius: 5px; width: 100%;">
                <option value="all">All Backups</option>
            </select>
        </div>

        <!-- Scrollable backup list -->
        <div id="backupSelectorList" style="flex: 1; overflow-y: auto; max-height: 400px; border: 1px solid #ecf0f1; border-radius: 5px;">
            <p style="padding: 1rem; color: #7f8c8d;">Loading...</p>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top: 1rem;">
            <button id="backupSelectorCancel" class="btn" style="background: #95a5a6;">Cancel</button>
        </div>
        <span id="backupSelectorClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.5rem; color: #7f8c8d;">&times;</span>
    </div>
</div>

<!-- Export Archived Measurements (Default: COLLAPSED) - Now includes Export Complete Database -->
<div class="card" style="border-left: 4px solid #3498db;">
    <div class="card-header" onclick="toggleCard('export-archive')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #3498db;">Download Backups</h2>
            <span class="expand-icon" id="icon-export-archive">▼</span>
        </div>
    </div>
    <div class="card-details" id="details-export-archive">
        <h3 style="color: #3498db; margin-top: 0;">Export Complete Database</h3>
        <p style="color: #7f8c8d;">Download {{ archive_count }} archived measurement records in .json or .csv format:</p>
        
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <a href="{% url 'admin_export_archive' %}?format=json" class="btn" style="background: #3498db;">
                JSON
            </a>
            <a href="{% url 'admin_export_archive' %}?format=csv" class="btn" style="background: #3498db;">
                CSV
            </a>
        </div>
        
        <p style="color: #7f8c8d; margin-top: 1rem; font-size: 0.9rem;">
            JSON preserves all data. CSV is easier to view in spreadsheets.
        </p>
        
        <hr style="border: none; border-top: 2px solid #ecf0f1; margin: 2rem 0;">
        
        <!-- Export Complete Database (moved here) -->
        <h3 style="color: #8e44ad; margin-top: 0;">Export Complete Database</h3>
        <p style="color: #7f8c8d;">Download a complete backup of the entire database for disaster recovery.</p>
        
        <div style="margin-top: 1rem;">
            <a href="{% url 'admin_export_full_database' %}" class="btn" style="background: #8e44ad;">
                Export Complete Database
            </a>
        </div>
        
        <p style="color: #7f8c8d; margin-top: 1rem; font-size: 0.9rem;">
            Includes all data: users, machines, queue entries, presets, archived measurements, and notifications.
            Recommended before major system changes or monthly for backups.
        </p>
    </div>
</div>

<!-- Clear Archive (Danger Zone) (Default: OPEN) - Now includes archived measurements info -->
<div class="card" style="border-left: 4px solid #e74c3c;">
    <div class="card-header" onclick="toggleCard('clear-archive')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #e74c3c;">Clear Archive (Danger Zone)</h2>
            <span class="expand-icon open" id="icon-clear-archive">▼</span>
        </div>
    </div>
    <div class="card-details" id="details-clear-archive">
        <!-- Archived Measurements Stats -->
        <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <h3 style="margin-top: 0; color: #495057;">Archived Measurements</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                    <p style="color: #7f8c8d; margin: 0;">Total Records</p>
                    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">{{ archive_count }}</p>
                </div>
                <div>
                    <p style="color: #7f8c8d; margin: 0;">Estimated Size</p>
                    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">~{{ estimated_archive_size_mb }} MB</p>
                </div>
            </div>
        </div>

        <p style="color: #7f8c8d;">Permanently delete all archived measurements to free up database space.</p>

        {% if archive_count == 0 %}
        <div style="background: #e8f5e9; border-left: 4px solid #2ecc71; padding: 1rem; margin: 1rem 0;">
            <strong style="color: #2ecc71;">Archive is empty.</strong> No measurements to clear.
        </div>
        {% else %}
        <div style="background: #fee; border: 2px solid #e74c3c; padding: 1.5rem; border-radius: 5px; margin-top: 1rem;">
            <h3 style="margin-top: 0; color: #e74c3c;">WARNING: This action cannot be undone!</h3>

            <ul style="color: #7f8c8d;">
                <li>This will permanently delete <strong>{{ archive_count }} archived measurements</strong></li>
                <li><strong>Automatic backup will be downloaded</strong> before deletion</li>
                <li>All users will be notified that the archive was cleared</li>
                <li>Users should contact you for old data if needed</li>
            </ul>

            <div style="margin-top: 1rem;">
                <button id="openThanosModal" class="btn" style="background: #e74c3c;">
                    Delete All {{ archive_count }} Archived Measurements
                </button>
                <a href="{% url 'admin_dashboard' %}" class="btn" style="background: #95a5a6; margin-left: 0.5rem;">
                    Cancel
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Simple toggle function like fridges page
function toggleCard(cardId) {
    const details = document.getElementById('details-' + cardId);
    const icon = document.getElementById('icon-' + cardId);

    if (details.classList.contains('open')) {
        details.classList.remove('open');
        icon.classList.remove('open');
    } else {
        details.classList.add('open');
        icon.classList.add('open');
    }
}

// Cloud Backups with horizontal scroll and selector modal
let allCloudBackups = [];
let backupsByMonth = {};

document.addEventListener('DOMContentLoaded', function() {
    const scrollContainer = document.getElementById('cloudBackupsScrollContainer');
    const errorDiv = document.getElementById('cloudBackupsError');
    const monthSelect = document.getElementById('cloudBackupMonthSelect');
    const countDisplay = document.getElementById('cloudBackupsCount');
    const openSelectorBtn = document.getElementById('openBackupSelectorBtn');
    const selectorModal = document.getElementById('backupSelectorModal');
    const selectorList = document.getElementById('backupSelectorList');
    const modalMonthSelect = document.getElementById('modalMonthSelect');
    const selectorCancel = document.getElementById('backupSelectorCancel');
    const selectorClose = document.getElementById('backupSelectorClose');

    // Save scroll position before page unload
    window.addEventListener('beforeunload', function() {
        sessionStorage.setItem('cloudBackupsScrollPos', scrollContainer.scrollLeft);
        sessionStorage.setItem('pageScrollPos', window.scrollY);
    });

    // Restore page scroll position
    const savedPageScroll = sessionStorage.getItem('pageScrollPos');
    if (savedPageScroll) {
        setTimeout(() => window.scrollTo(0, parseInt(savedPageScroll)), 100);
        sessionStorage.removeItem('pageScrollPos');
    }

    fetch('{% url "admin_list_github_backups" %}')
        .then(response => {
            if (!response.ok) {
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Session expired or authentication required. Please refresh the page.');
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                errorDiv.innerHTML = `<strong style="color: #e74c3c;">Error:</strong> ${data.error}`;
                errorDiv.style.display = 'block';
                scrollContainer.innerHTML = '';
                monthSelect.innerHTML = '<option value="">Error loading</option>';
                return;
            }

            if (data.message) {
                scrollContainer.innerHTML = `<p style="color: #7f8c8d; white-space: normal;">${data.message}</p>`;
                monthSelect.innerHTML = '<option value="">No backups</option>';
                return;
            }

            if (!data.backups || data.backups.length === 0) {
                scrollContainer.innerHTML = '<p style="color: #7f8c8d; white-space: normal;">No cloud backups found yet. Backups run nightly at 12:30 AM Central.</p>';
                monthSelect.innerHTML = '<option value="">No backups</option>';
                return;
            }

            // Process and organize backups by month
            allCloudBackups = data.backups.map(backup => {
                const match = backup.name.match(/database_backup_(\d{4}-\d{2}-\d{2})_(\d{2})-(\d{2})-(\d{2})\.json/);
                let date = null;
                let dateStr = backup.name;
                let monthKey = 'unknown';

                if (match) {
                    date = new Date(`${match[1]}T${match[2]}:${match[3]}:${match[4]}Z`);
                    dateStr = date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }

                const sizeKB = (backup.size / 1024).toFixed(1);
                const sizeStr = backup.size > 1024 * 1024
                    ? `${(backup.size / 1024 / 1024).toFixed(2)} MB`
                    : `${sizeKB} KB`;

                return {
                    ...backup,
                    date,
                    dateStr,
                    sizeStr,
                    monthKey
                };
            });

            // Group by month
            backupsByMonth = {};
            allCloudBackups.forEach(backup => {
                if (!backupsByMonth[backup.monthKey]) {
                    backupsByMonth[backup.monthKey] = [];
                }
                backupsByMonth[backup.monthKey].push(backup);
            });

            // Populate month dropdown
            const months = Object.keys(backupsByMonth).sort().reverse();
            monthSelect.innerHTML = months.map(month => {
                const [year, mon] = month.split('-');
                const monthName = new Date(year, parseInt(mon) - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
                return `<option value="${month}">${monthName} (${backupsByMonth[month].length})</option>`;
            }).join('');

            // Also populate modal dropdown
            modalMonthSelect.innerHTML = '<option value="all">All Backups (' + allCloudBackups.length + ')</option>' +
                months.map(month => {
                    const [year, mon] = month.split('-');
                    const monthName = new Date(year, parseInt(mon) - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
                    return `<option value="${month}">${monthName} (${backupsByMonth[month].length})</option>`;
                }).join('');

            // Determine which month to show (current or last if none this month)
            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            let selectedMonth = months[0]; // Default to most recent

            if (backupsByMonth[currentMonthKey] && backupsByMonth[currentMonthKey].length > 0) {
                selectedMonth = currentMonthKey;
            }

            monthSelect.value = selectedMonth;
            renderBackupsForMonth(selectedMonth);

            // Restore horizontal scroll position
            const savedScrollPos = sessionStorage.getItem('cloudBackupsScrollPos');
            if (savedScrollPos) {
                setTimeout(() => {
                    scrollContainer.scrollLeft = parseInt(savedScrollPos);
                }, 100);
                sessionStorage.removeItem('cloudBackupsScrollPos');
            }
        })
        .catch(error => {
            errorDiv.innerHTML = `<strong style="color: #e74c3c;">Network Error:</strong> ${error.message}`;
            errorDiv.style.display = 'block';
            scrollContainer.innerHTML = '';
        });

    // Month select change handler
    monthSelect.addEventListener('change', function() {
        renderBackupsForMonth(this.value);
    });

    // Render backups as horizontal cards
    function renderBackupsForMonth(monthKey) {
        const backups = backupsByMonth[monthKey] || [];

        if (backups.length === 0) {
            scrollContainer.innerHTML = '<p style="color: #7f8c8d; white-space: normal;">No backups for this month.</p>';
            countDisplay.textContent = '';
            return;
        }

        let html = '<div style="display: inline-flex; gap: 1rem;">';

        backups.forEach(backup => {
            const downloadUrl = `/schedule/admin/github-backups/download/${encodeURIComponent(backup.name)}/`;
            html += `
                <div style="
                    display: inline-block;
                    background: #f8f9fa;
                    border: 2px solid #f432f4;
                    border-radius: 8px;
                    padding: 1rem;
                    min-width: 200px;
                    white-space: normal;
                    vertical-align: top;
                ">
                    <p style="margin: 0 0 0.5rem 0; font-weight: bold; font-size: 0.95rem;">${backup.dateStr}</p>
                    <p style="margin: 0 0 0.75rem 0; color: #7f8c8d; font-size: 0.85rem;">${backup.sizeStr}</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="${downloadUrl}" class="btn" style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #2ecc71; flex: 1; text-align: center;">
                            Download
                        </a>
                        <button type="button" class="btn restore-cloud-btn"
                            data-filename="${backup.name}"
                            data-date="${backup.dateStr}"
                            style="padding: 0.3rem 0.5rem; font-size: 0.8rem; background: #e67e22; flex: 1;">
                            Restore
                        </button>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        scrollContainer.innerHTML = html;
        countDisplay.textContent = `${backups.length} backup${backups.length !== 1 ? 's' : ''} this month. Scroll for more or click "Browse All".`;

        // Add restore button listeners
        scrollContainer.querySelectorAll('.restore-cloud-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                openCloudRestoreModal(this.dataset.filename, this.dataset.date);
            });
        });
    }

    // Open selector modal
    openSelectorBtn.addEventListener('click', function() {
        selectorModal.style.display = 'flex';
        modalMonthSelect.value = 'all';
        renderSelectorList('all');
    });

    // Modal month filter change
    modalMonthSelect.addEventListener('change', function() {
        renderSelectorList(this.value);
    });

    // Render selector list
    function renderSelectorList(filter) {
        let backups = filter === 'all' ? allCloudBackups : (backupsByMonth[filter] || []);

        if (backups.length === 0) {
            selectorList.innerHTML = '<p style="padding: 1rem; color: #7f8c8d;">No backups found.</p>';
            return;
        }

        let html = '';
        backups.forEach(backup => {
            const downloadUrl = `/schedule/admin/github-backups/download/${encodeURIComponent(backup.name)}/`;
            html += `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 0.75rem 1rem;
                    border-bottom: 1px solid #ecf0f1;
                    gap: 1rem;
                ">
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: bold; font-size: 0.9rem;">${backup.dateStr}</p>
                        <p style="margin: 0; color: #7f8c8d; font-size: 0.8rem;">${backup.sizeStr}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="${downloadUrl}" class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #2ecc71;">
                            Download
                        </a>
                        <button type="button" class="btn modal-restore-btn"
                            data-filename="${backup.name}"
                            data-date="${backup.dateStr}"
                            style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #e67e22;">
                            Restore
                        </button>
                    </div>
                </div>
            `;
        });

        selectorList.innerHTML = html;

        // Add restore button listeners
        selectorList.querySelectorAll('.modal-restore-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                closeSelectorModal();
                openCloudRestoreModal(this.dataset.filename, this.dataset.date);
            });
        });
    }

    // Close selector modal
    function closeSelectorModal() {
        selectorModal.style.display = 'none';
    }

    selectorCancel.addEventListener('click', closeSelectorModal);
    selectorClose.addEventListener('click', closeSelectorModal);
    selectorModal.addEventListener('click', function(e) {
        if (e.target === selectorModal) {
            closeSelectorModal();
        }
    });

    // ESC key to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && selectorModal.style.display === 'flex') {
            closeSelectorModal();
        }
    });
});
</script>

<!-- Thanos Delete Confirmation Modal -->
{% load static %}
<div id="thanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p style="font-weight:bold; margin-bottom:1rem; font-size:1.1rem; color: #e74c3c;">
            Are you absolutely sure you want to delete {{ archive_count }} archived measurements?
        </p>
        <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.9rem;">
            A backup will be downloaded automatically before deletion.
        </p>

        <label for="thanosConfirmation" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
            Type <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">CONFIRM DELETE</code>:
        </label>
        <input
            type="text"
            id="thanosConfirmation"
            style="width: 100%; max-width: 300px; padding: 0.5rem; border: 2px solid #e74c3c; border-radius: 5px; font-family: monospace; margin-bottom: 1rem;"
            placeholder="CONFIRM DELETE"
        >
        <div id="thanosError" style="color: #e74c3c; font-size: 0.9rem; margin-bottom: 1rem; display: none;"></div>

        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="thanosYes" class="btn" style="background: #e74c3c;">Yes, snap it away</button>
            <button id="thanosNo" class="btn" style="background: #95a5a6;">No, spare the archive</button>
        </div>
        <span id="thanosClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<div class="card">
    <a href="{% url 'admin_dashboard' %}" class="btn" style="background: #95a5a6;">
        ← Back to Dashboard
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('thanosModal');
    const openBtn = document.getElementById('openThanosModal');
    const confirmInput = document.getElementById('thanosConfirmation');
    const errorDiv = document.getElementById('thanosError');
    const btnYes = document.getElementById('thanosYes');
    const btnNo = document.getElementById('thanosNo');
    const btnClose = document.getElementById('thanosClose');

    if (!openBtn) return; // Archive is empty, no button

    // Open Thanos modal
    openBtn.addEventListener('click', function() {
        modal.style.display = 'flex';
        confirmInput.value = '';
        errorDiv.style.display = 'none';
        confirmInput.focus();
    });

    // Close modal
    function closeModal() {
        modal.style.display = 'none';
        confirmInput.value = '';
        errorDiv.style.display = 'none';
    }

    btnNo.addEventListener('click', closeModal);
    btnClose.addEventListener('click', closeModal);

    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Yes button: Download backup, then delete
    btnYes.addEventListener('click', function() {
        const confirmation = confirmInput.value.trim();

        if (confirmation !== 'CONFIRM DELETE') {
            errorDiv.textContent = 'Incorrect confirmation text. Please type exactly "CONFIRM DELETE".';
            errorDiv.style.display = 'block';
            return;
        }

        // Disable button to prevent double-click
        btnYes.disabled = true;
        btnYes.textContent = 'Downloading backup...';

        // Step 1: Download backup automatically
        const backupUrl = '{% url "admin_clear_archive_with_backup" %}';
        const backupLink = document.createElement('a');
        backupLink.href = backupUrl;
        backupLink.download = 'archive_backup_before_delete.json';
        document.body.appendChild(backupLink);
        backupLink.click();
        document.body.removeChild(backupLink);

        // Wait 1 second for download to start, then delete
        setTimeout(function() {
            btnYes.textContent = 'Deleting...';

            // Step 2: Submit delete request via AJAX
            fetch('{% url "admin_clear_archive" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'confirmation=' + encodeURIComponent(confirmation)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ Success: ${data.message}`);
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Unknown error occurred';
                    errorDiv.style.display = 'block';
                    btnYes.disabled = false;
                    btnYes.textContent = 'Yes, snap it away';
                }
            })
            .catch(error => {
                errorDiv.textContent = 'Network error: ' + error.message;
                errorDiv.style.display = 'block';
                btnYes.disabled = false;
                btnYes.textContent = 'Yes, snap it away';
            });
        }, 1000); // 1 second delay for backup download
    });

    // Allow Enter key to confirm
    confirmInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            btnYes.click();
        }
    });
});

// Import Database Modal Handlers
document.addEventListener('DOMContentLoaded', function() {
    const openImportBtn = document.getElementById('openImportModal');
    const importModal = document.getElementById('importThanosModal');
    const importConfirmInput = document.getElementById('importConfirmation');
    const importErrorDiv = document.getElementById('importError');
    const importYesBtn = document.getElementById('importYes');
    const importNoBtn = document.getElementById('importNo');
    const importCloseBtn = document.getElementById('importClose');
    const backupFileInput = document.getElementById('backupFile');
    const importModeSelect = document.getElementById('importMode');
    const importMessage = document.getElementById('importMessage');

    if (!openImportBtn) return; // Element not found

    // Open import modal
    openImportBtn.addEventListener('click', function() {
        // Validate file selection
        if (!backupFileInput.files || backupFileInput.files.length === 0) {
            alert('Please select a backup file first.');
            return;
        }

        const fileName = backupFileInput.files[0].name;
        const importMode = importModeSelect.value;
        const modeName = importMode === 'replace' ? 'REPLACE mode (DESTRUCTIVE)' : 'MERGE mode (safe)';

        importMessage.innerHTML = `Are you sure you want to restore database from:<br><strong>${fileName}</strong><br>Mode: <strong>${modeName}</strong>`;
        importConfirmInput.value = '';
        importErrorDiv.style.display = 'none';
        importModal.style.display = 'flex';
        importConfirmInput.focus();
    });

    // Close modal
    function closeImportModal() {
        importModal.style.display = 'none';
        importConfirmInput.value = '';
        importErrorDiv.style.display = 'none';
    }

    importNoBtn.addEventListener('click', closeImportModal);
    importCloseBtn.addEventListener('click', closeImportModal);

    // Close on background click
    importModal.addEventListener('click', function(e) {
        if (e.target === importModal) {
            closeImportModal();
        }
    });

    // Yes button: Confirm and import
    importYesBtn.addEventListener('click', function() {
        const confirmation = importConfirmInput.value.trim();

        if (confirmation !== 'CONFIRM RESTORE') {
            importErrorDiv.textContent = 'Incorrect confirmation text. Please type exactly "CONFIRM RESTORE".';
            importErrorDiv.style.display = 'block';
            return;
        }

        // Disable button to prevent double-click
        importYesBtn.disabled = true;
        importYesBtn.textContent = 'Importing...';

        // Prepare form data
        const formData = new FormData();
        formData.append('backup_file', backupFileInput.files[0]);
        formData.append('import_mode', importModeSelect.value);
        formData.append('silent_restore', document.getElementById('silentRestore').checked ? 'true' : 'false');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        // Submit import request via AJAX
        fetch('{% url "admin_import_database" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeImportModal();
                alert(`Success: ${data.message}`);
                window.location.reload();
            } else {
                importErrorDiv.textContent = data.error || 'Unknown error occurred';
                importErrorDiv.style.display = 'block';
                importYesBtn.disabled = false;
                importYesBtn.textContent = 'Yes, restore database';
            }
        })
        .catch(error => {
            importErrorDiv.textContent = 'Network error: ' + error.message;
            importErrorDiv.style.display = 'block';
            importYesBtn.disabled = false;
            importYesBtn.textContent = 'Yes, restore database';
        });
    });

    // Allow Enter key to confirm
    importConfirmInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            importYesBtn.click();
        }
    });
});
</script>

<!-- Import/Restore Thanos Confirmation Modal -->
<div id="importThanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p id="importMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1.1rem; color: #e67e22;"></p>

        <label for="importConfirmation" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
            Type <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">CONFIRM RESTORE</code>:
        </label>
        <input
            type="text"
            id="importConfirmation"
            style="width: 100%; max-width: 300px; padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px; font-family: monospace; margin-bottom: 1rem;"
            placeholder="CONFIRM RESTORE"
        >
        <div id="importError" style="color: #e74c3c; font-size: 0.9rem; margin-bottom: 1rem; display: none;"></div>

        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="importYes" class="btn" style="background: #e67e22;">Yes, restore database</button>
            <button id="importNo" class="btn" style="background: #95a5a6;">No, cancel</button>
        </div>
        <span id="importClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<!-- Cloud Restore Confirmation Modal -->
<div id="cloudRestoreModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p id="cloudRestoreMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1.1rem; color: #e67e22;"></p>

        <div style="margin-bottom: 1rem; text-align: left;">
            <label for="cloudRestoreMode" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                Restore Mode:
            </label>
            <select id="cloudRestoreMode" style="width: 100%; padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px;">
                <option value="merge">Merge - Keep existing data, add new records (safer)</option>
                <option value="replace">Replace - Clear database and restore (WARNING: destructive)</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem; text-align: left;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="cloudSilentRestore" style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-weight: bold;">Silent Restore (don't notify users)</span>
            </label>
            <p style="color: #7f8c8d; margin: 0.5rem 0 0 0; font-size: 0.85rem; padding-left: 1.75rem;">
                When checked, users will NOT receive notifications about this database restore.
            </p>
        </div>

        <label for="cloudRestoreConfirmation" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
            Type <code style="background: #ecf0f1; padding: 2px 6px; border-radius: 3px;">CONFIRM RESTORE</code>:
        </label>
        <input
            type="text"
            id="cloudRestoreConfirmation"
            style="width: 100%; max-width: 300px; padding: 0.5rem; border: 2px solid #e67e22; border-radius: 5px; font-family: monospace; margin-bottom: 1rem;"
            placeholder="CONFIRM RESTORE"
        >
        <div id="cloudRestoreError" style="color: #e74c3c; font-size: 0.9rem; margin-bottom: 1rem; display: none;"></div>

        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="cloudRestoreYes" class="btn" style="background: #e67e22;">Yes, restore from cloud</button>
            <button id="cloudRestoreNo" class="btn" style="background: #95a5a6;">No, cancel</button>
        </div>
        <span id="cloudRestoreClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<script>
// Cloud Restore Modal Handlers
let pendingCloudRestoreFilename = null;

function openCloudRestoreModal(filename, dateStr) {
    const modal = document.getElementById('cloudRestoreModal');
    const message = document.getElementById('cloudRestoreMessage');
    const confirmInput = document.getElementById('cloudRestoreConfirmation');
    const errorDiv = document.getElementById('cloudRestoreError');

    pendingCloudRestoreFilename = filename;
    message.innerHTML = `Restore database from cloud backup:<br><strong>${dateStr}</strong>`;
    confirmInput.value = '';
    errorDiv.style.display = 'none';
    modal.style.display = 'flex';
    confirmInput.focus();
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('cloudRestoreModal');
    const confirmInput = document.getElementById('cloudRestoreConfirmation');
    const errorDiv = document.getElementById('cloudRestoreError');
    const modeSelect = document.getElementById('cloudRestoreMode');
    const btnYes = document.getElementById('cloudRestoreYes');
    const btnNo = document.getElementById('cloudRestoreNo');
    const btnClose = document.getElementById('cloudRestoreClose');

    // Close modal
    function closeCloudRestoreModal() {
        modal.style.display = 'none';
        confirmInput.value = '';
        errorDiv.style.display = 'none';
        pendingCloudRestoreFilename = null;
    }

    btnNo.addEventListener('click', closeCloudRestoreModal);
    btnClose.addEventListener('click', closeCloudRestoreModal);

    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeCloudRestoreModal();
        }
    });

    // Yes button: Confirm and restore from cloud
    btnYes.addEventListener('click', function() {
        const confirmation = confirmInput.value.trim();

        if (confirmation !== 'CONFIRM RESTORE') {
            errorDiv.textContent = 'Incorrect confirmation text. Please type exactly "CONFIRM RESTORE".';
            errorDiv.style.display = 'block';
            return;
        }

        if (!pendingCloudRestoreFilename) {
            errorDiv.textContent = 'No backup file selected.';
            errorDiv.style.display = 'block';
            return;
        }

        // Disable button to prevent double-click
        btnYes.disabled = true;
        btnYes.textContent = 'Restoring...';

        // Prepare form data
        const formData = new FormData();
        formData.append('import_mode', modeSelect.value);
        formData.append('silent_restore', document.getElementById('cloudSilentRestore').checked ? 'true' : 'false');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        // Submit restore request via AJAX
        const restoreUrl = `/schedule/admin/github-backups/restore/${encodeURIComponent(pendingCloudRestoreFilename)}/`;

        fetch(restoreUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeCloudRestoreModal();
                alert(`Success: ${data.message}\n\nAll users have been notified.`);
                window.location.reload();
            } else {
                errorDiv.textContent = data.error || 'Unknown error occurred';
                errorDiv.style.display = 'block';
                btnYes.disabled = false;
                btnYes.textContent = 'Yes, restore from cloud';
            }
        })
        .catch(error => {
            errorDiv.textContent = 'Network error: ' + error.message;
            errorDiv.style.display = 'block';
            btnYes.disabled = false;
            btnYes.textContent = 'Yes, restore from cloud';
        });
    });

    // Allow Enter key to confirm
    confirmInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            btnYes.click();
        }
    });
});
</script>

{% endblock %}
