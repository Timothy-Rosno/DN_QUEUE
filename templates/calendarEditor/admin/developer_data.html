{% extends 'base.html' %}
{% load static %}

{% block title %}Developer Data{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h1 style="margin: 0;">Developer Analytics Dashboard</h1>
        <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">← Back to Dashboard</a>
    </div>

    <!-- Date Range Filter -->
    <div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; align-items: center;">
        <span style="font-weight: bold; margin-right: 0.5rem;">Time Range:</span>
        <a href="?days=7" class="btn {% if days_filter == 7 %}btn-primary{% else %}btn-secondary{% endif %}" style="padding: 0.5rem 1rem;">Last 7 Days</a>
        <a href="?days=30" class="btn {% if days_filter == 30 %}btn-primary{% else %}btn-secondary{% endif %}" style="padding: 0.5rem 1rem;">Last 30 Days</a>
        <a href="?days=0" class="btn {% if days_filter == 0 %}btn-primary{% else %}btn-secondary{% endif %}" style="padding: 0.5rem 1rem;">All Time</a>
    </div>

    <!-- Summary Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="card" style="text-align: center; background: #3498db; color: white;">
            <h2 style="margin: 0; font-size: 2.5rem;">{{ users_online }}</h2>
            <p style="margin: 0.5rem 0 0 0;">Users Online Now</p>
            <small>(last 15 min)</small>
        </div>
        <div class="card" style="text-align: center; background: #27ae60; color: white;">
            <h2 style="margin: 0; font-size: 2.5rem;">{{ page_views_period }}</h2>
            <p style="margin: 0.5rem 0 0 0;">Page Views</p>
            <small>{% if days_filter == 0 %}(all time){% elif days_filter == 7 %}(last 7 days){% else %}(last 30 days){% endif %} / {{ page_views_all_time }} total</small>
        </div>
        <div class="card" style="text-align: center; background: #f39c12; color: white;">
            <h2 style="margin: 0; font-size: 2.5rem;">{{ queue_stats.total_period }}</h2>
            <p style="margin: 0.5rem 0 0 0;">Queue Requests</p>
            <small>{% if days_filter == 0 %}(all time){% elif days_filter == 7 %}(last 7 days){% else %}(last 30 days){% endif %} / {{ queue_stats.total_all_time }} total</small>
        </div>
        <div class="card" style="text-align: center; background: #9b59b6; color: white;">
            <h2 style="margin: 0; font-size: 2.5rem;">{{ feedback_stats.total }}</h2>
            <p style="margin: 0.5rem 0 0 0;">Total Feedback</p>
            <small>({{ feedback_stats.new }} new)</small>
        </div>
    </div>

    <!-- Currently Online Users -->
    {% if online_users_data %}
    <div class="card" style="margin-bottom: 1.5rem;">
        <h3>Currently Online Users ({{ online_users_data|length }})</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Username</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Browser</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">OS</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Device</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">IP Address</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Last Seen</th>
                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid #dee2e6;">Views (15m)</th>
                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Roles</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user_data in online_users_data %}
                    <tr>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">{{ user_data.username }}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6; font-size: 0.85rem; color: #7f8c8d;">{{ user_data.browser }}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6; font-size: 0.85rem; color: #7f8c8d;">{{ user_data.os }}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6; font-size: 0.85rem;">
                            {% if user_data.device_type == 'Mobile' %}
                                <span style="color: #e74c3c;">{{ user_data.device_type }}</span>
                            {% elif user_data.device_type == 'Tablet' %}
                                <span style="color: #f39c12;">{{ user_data.device_type }}</span>
                            {% else %}
                                <span style="color: #3498db;">{{ user_data.device_type }}</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6; font-size: 0.85rem; font-family: monospace; color: #7f8c8d;">{{ user_data.ip_address }}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6; font-size: 0.85rem;">{{ user_data.last_seen|timesince }} ago</td>
                        <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #dee2e6;">{{ user_data.page_count }}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">
                            {% for role in user_data.roles %}
                                {% if role == 'Admin' %}
                                    <span style="background-color: #e74c3c; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.2rem;">{{ role }}</span>
                                {% elif role == 'Developer' %}
                                    <span style="background-color: #9b59b6; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.2rem;">{{ role }}</span>
                                {% elif role == 'Staff' %}
                                    <span style="background-color: #f39c12; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.2rem;">{{ role }}</span>
                                {% else %}
                                    <span style="background-color: #95a5a6; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.2rem;">{{ role }}</span>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Per-User Analytics -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <h3>Per-User Analytics (All Users)</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 0.6rem; text-align: left; border-bottom: 2px solid #dee2e6;">Username</th>
                        <th style="padding: 0.6rem; text-align: left; border-bottom: 2px solid #dee2e6;">Email</th>
                        <th style="padding: 0.6rem; text-align: left; border-bottom: 2px solid #dee2e6;">Roles</th>
                        <th style="padding: 0.6rem; text-align: center; border-bottom: 2px solid #dee2e6;">Status</th>
                        <th style="padding: 0.6rem; text-align: left; border-bottom: 2px solid #dee2e6;">Last Seen</th>
                        <th style="padding: 0.6rem; text-align: center; border-bottom: 2px solid #dee2e6;">Page Views<br><small>(period / all)</small></th>
                        <th style="padding: 0.6rem; text-align: center; border-bottom: 2px solid #dee2e6;">Queue Entries<br><small>(period / all)</small></th>
                        <th style="padding: 0.6rem; text-align: center; border-bottom: 2px solid #dee2e6;">Feedback<br><small>(period / all)</small></th>
                    </tr>
                </thead>
                <tbody>
                    {% for user_stat in per_user_stats %}
                    <tr {% if user_stat.is_online %}style="background-color: #e8f8f5;"{% endif %}>
                        <td style="padding: 0.6rem; border-bottom: 1px solid #dee2e6;">{{ user_stat.username }}</td>
                        <td style="padding: 0.6rem; border-bottom: 1px solid #dee2e6; font-size: 0.85rem;">{{ user_stat.email }}</td>
                        <td style="padding: 0.6rem; border-bottom: 1px solid #dee2e6;">
                            {% if user_stat.roles %}
                                {% for role in user_stat.roles %}
                                    {% if role == 'Admin' %}
                                        <span style="background-color: #e74c3c; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.2rem;">A</span>
                                    {% elif role == 'Developer' %}
                                        <span style="background-color: #9b59b6; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.2rem;">D</span>
                                    {% elif role == 'Staff' %}
                                        <span style="background-color: #f39c12; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-right: 0.2rem;">S</span>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <span style="color: #95a5a6; font-size: 0.85rem;">User</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.6rem; text-align: center; border-bottom: 1px solid #dee2e6;">
                            {% if user_stat.is_online %}
                                <span style="color: #27ae60; font-weight: bold;">●</span>
                            {% else %}
                                <span style="color: #95a5a6;">○</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.6rem; border-bottom: 1px solid #dee2e6; font-size: 0.85rem;">
                            {% if user_stat.last_seen %}
                                {{ user_stat.last_seen|timesince }} ago
                            {% else %}
                                <span style="color: #95a5a6;">Never</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.6rem; text-align: center; border-bottom: 1px solid #dee2e6;">
                            <strong>{{ user_stat.page_views_period }}</strong> / {{ user_stat.page_views_all_time }}
                        </td>
                        <td style="padding: 0.6rem; text-align: center; border-bottom: 1px solid #dee2e6;">
                            <strong>{{ user_stat.queue_entries_period }}</strong> / {{ user_stat.queue_entries_all_time }}
                        </td>
                        <td style="padding: 0.6rem; text-align: center; border-bottom: 1px solid #dee2e6;">
                            <strong>{{ user_stat.feedback_submitted_period }}</strong> / {{ user_stat.feedback_submitted_all_time }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p style="color: #7f8c8d; margin-top: 1rem; font-size: 0.85rem;">
            <strong>Legend:</strong>
            <span style="color: #27ae60; font-weight: bold;">●</span> Online now |
            <span style="color: #95a5a6;">○</span> Offline |
            Green background = Currently online
        </p>
    </div>

    <!-- Charts Row 1 -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
            <h3>Top Pages {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <canvas id="topPagesChart"></canvas>
        </div>
        <div class="card">
            <h3>Top Browsers {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <canvas id="browsersChart"></canvas>
        </div>
        <div class="card">
            <h3>Device Breakdown {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <canvas id="deviceChart"></canvas>
        </div>
    </div>

    <!-- Charts Row 2: Browser × Device Type -->
    <div style="margin-bottom: 1.5rem;">
        <div class="card">
            <h3>Browser × Device Type {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <canvas id="browserDeviceChart"></canvas>
        </div>
    </div>

    <!-- Turso Database Usage -->
    <div style="margin-bottom: 1.5rem;">
        <div class="card" style="border-left: 4px solid #1abc9c;">
            <h3 style="color: #1abc9c;">Turso Database Usage (Current Billing Cycle)</h3>
            {% if turso_usage %}
                <p style="color: #7f8c8d; margin-bottom: 1.5rem; font-size: 0.9rem;">
                    Real-time usage data from Turso API.
                    <a href="https://turso.tech/app/{{ turso_org_slug }}/usage" target="_blank" style="color: #3498db;">View full dashboard →</a>
                </p>

                <!-- Rows Read -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>Rows Read (Monthly)</strong>
                        <span>{{ turso_usage.rows_read|floatformat:0 }} / {{ turso_limits.rows_read_monthly|floatformat:0 }}</span>
                    </div>
                    <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div style="background: {% if turso_usage.rows_read_percent >= 90 %}#e74c3c{% elif turso_usage.rows_read_percent >= 75 %}#f39c12{% else %}#3498db{% endif %};
                                    height: 100%; width: {{ turso_usage.rows_read_percent|floatformat:1 }}%;"></div>
                    </div>
                    <small style="color: #7f8c8d;">{{ turso_usage.rows_read_percent|floatformat:1 }}% used</small>
                </div>

                <!-- Rows Written -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>Rows Written (Monthly)</strong>
                        <span>{{ turso_usage.rows_written|floatformat:0 }} / {{ turso_limits.rows_written_monthly|floatformat:0 }}</span>
                    </div>
                    <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div style="background: {% if turso_usage.rows_written_percent >= 90 %}#e74c3c{% elif turso_usage.rows_written_percent >= 75 %}#f39c12{% else %}#9b59b6{% endif %};
                                    height: 100%; width: {{ turso_usage.rows_written_percent|floatformat:1 }}%;"></div>
                    </div>
                    <small style="color: #7f8c8d;">{{ turso_usage.rows_written_percent|floatformat:1 }}% used</small>
                </div>

                <!-- Storage -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>Storage</strong>
                        <span>{{ turso_usage.storage_mb|floatformat:2 }} MB / {{ turso_limits.storage_mb|floatformat:0 }} MB</span>
                    </div>
                    <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div style="background: {% if turso_usage.storage_percent >= 90 %}#e74c3c{% elif turso_usage.storage_percent >= 75 %}#f39c12{% else %}#1abc9c{% endif %};
                                    height: 100%; width: {{ turso_usage.storage_percent|floatformat:1 }}%;"></div>
                    </div>
                    <small style="color: #7f8c8d;">{{ turso_usage.storage_percent|floatformat:1 }}% used</small>
                </div>

                <!-- Databases -->
                <div>
                    <strong>Total Databases:</strong> {{ turso_usage.databases }}
                </div>
            {% else %}
                <p style="color: #e74c3c;">Unable to fetch Turso usage metrics. Please verify TURSO_ORG_SLUG and TURSO_API_TOKEN environment variables.</p>
            {% endif %}
        </div>
    </div>

    <!-- API Endpoint Hits -->
    <div style="margin-bottom: 1.5rem;">
        <div class="card">
            <h3>API Endpoint Hits {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 1rem;">Frequently-polled endpoints excluded from Top Pages chart</p>
            {% for endpoint, count in api_hits.items %}
                <p><strong>{{ endpoint }}:</strong> {{ count|floatformat:0 }} hits</p>
            {% endfor %}
        </div>
    </div>

    <!-- Peak Usage Times -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
            <h3>Peak Usage by Hour {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <canvas id="hourlyChart"></canvas>
        </div>
        <div class="card">
            <h3>Peak Usage by Day {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <!-- User Retention & Session Metrics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
            <h3>User Retention</h3>
            <p><strong>Daily Active Users (DAU):</strong> {{ dau }}</p>
            <p><strong>Weekly Active Users (WAU):</strong> {{ wau }}</p>
            <p><strong>Monthly Active Users (MAU):</strong> {{ mau }}</p>
            <p style="margin-top: 1rem;"><strong>New Users (Period):</strong> {{ new_users_period }}</p>
            <p><strong>Returning Users (Period):</strong> {{ returning_users }}</p>
        </div>
        <div class="card">
            <h3>Session Metrics</h3>
            <p><strong>Avg Session Duration:</strong> {{ avg_session_duration }} minutes</p>
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 0.5rem;">Average time between first and last page view in a session</p>
        </div>
    </div>

    <!-- Queue Advanced Metrics -->
    <div style="margin-bottom: 1.5rem;">
        <div class="card">
            <h3>Queue Performance Metrics {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                <div>
                    <p style="font-size: 2rem; font-weight: bold; color: #3498db; margin: 0;">{{ avg_queue_wait_time|floatformat:1 }}h</p>
                    <p style="color: #7f8c8d;">Avg Wait Time</p>
                </div>
                <div>
                    <p style="font-size: 2rem; font-weight: bold; color: #27ae60; margin: 0;">{{ queue_completion_rate|floatformat:1 }}%</p>
                    <p style="color: #7f8c8d;">Completion Rate</p>
                </div>
            </div>
            <h4 style="margin-top: 1.5rem;">Most Popular Machines</h4>
            {% for machine in popular_machines %}
                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                    <span>{{ machine.assigned_machine__name }}</span>
                    <span style="font-weight: bold;">{{ machine.count }} requests</span>
                </div>
            {% empty %}
                <p style="color: #7f8c8d;">No queue data available</p>
            {% endfor %}
        </div>
    </div>

    <!-- Top 10 Recently Active Users -->
    <div style="margin-bottom: 1.5rem;">
        <div class="card">
            <h3>Top 10 Most Recently Active Users {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f8f9fa;">
                        <tr style="border-bottom: 2px solid #ddd;">
                            <th style="padding: 0.75rem; text-align: left;">Rank</th>
                            <th style="padding: 0.75rem; text-align: left;">Username</th>
                            <th style="padding: 0.75rem; text-align: center;">Page Views</th>
                            <th style="padding: 0.75rem; text-align: center;">Queue Submissions</th>
                            <th style="padding: 0.75rem; text-align: center;">Feedback</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in top_10_users %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 0.75rem; font-weight: bold;">{{ forloop.counter }}</td>
                            <td style="padding: 0.75rem;">{{ stat.user.username }}</td>
                            <td style="padding: 0.75rem; text-align: center;">{{ stat.page_views }}</td>
                            <td style="padding: 0.75rem; text-align: center;">{{ stat.queue_submissions }}</td>
                            <td style="padding: 0.75rem; text-align: center;">{{ stat.feedback_count }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" style="padding: 1rem; text-align: center; color: #7f8c8d;">No user activity data</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Feedback Response Time -->
    <div style="margin-bottom: 1.5rem;">
        <div class="card">
            <h3>Feedback Response Time</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div>
                    <p style="font-size: 2rem; font-weight: bold; color: #f39c12; margin: 0;">{{ avg_feedback_review_time|floatformat:1 }}h</p>
                    <p style="color: #7f8c8d;">Avg Time to Review</p>
                    <p style="font-size: 0.85rem; color: #7f8c8d;">From submission to first review</p>
                </div>
                <div>
                    <p style="font-size: 2rem; font-weight: bold; color: #27ae60; margin: 0;">{{ avg_feedback_completion_time|floatformat:1 }}h</p>
                    <p style="color: #7f8c8d;">Avg Time to Complete</p>
                    <p style="font-size: 0.85rem; color: #7f8c8d;">From review to completion</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Statistics -->
    <div style="margin-bottom: 1.5rem;">
        <div class="card" style="border-left: 4px solid #e74c3c;">
            <h3 style="color: #e74c3c;">Error Tracking {% if days_filter == 0 %}(All Time){% elif days_filter == 7 %}(Last 7 Days){% else %}(Last 30 Days){% endif %}</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="text-align: center;">
                    <p style="font-size: 2rem; font-weight: bold; color: #e74c3c; margin: 0;">{{ total_errors }}</p>
                    <p style="color: #7f8c8d; font-size: 0.9rem;">Total Errors</p>
                </div>
                <div style="text-align: center;">
                    <p style="font-size: 2rem; font-weight: bold; color: #e67e22; margin: 0;">{{ error_404_count }}</p>
                    <p style="color: #7f8c8d; font-size: 0.9rem;">404 Not Found</p>
                </div>
                <div style="text-align: center;">
                    <p style="font-size: 2rem; font-weight: bold; color: #c0392b; margin: 0;">{{ error_500_count }}</p>
                    <p style="color: #7f8c8d; font-size: 0.9rem;">500 Server Errors</p>
                </div>
                <div style="text-align: center;">
                    <p style="font-size: 2rem; font-weight: bold; color: #e74c3c; margin: 0;">{{ error_403_count }}</p>
                    <p style="color: #7f8c8d; font-size: 0.9rem;">403 Forbidden</p>
                </div>
            </div>

            <h4>Top Error Paths</h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem;">
                    <thead style="background: #f8f9fa;">
                        <tr style="border-bottom: 2px solid #ddd;">
                            <th style="padding: 0.5rem; text-align: left;">Path</th>
                            <th style="padding: 0.5rem; text-align: center;">Type</th>
                            <th style="padding: 0.5rem; text-align: center;">Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for error in top_error_paths %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 0.5rem; font-family: monospace; font-size: 0.85rem;">{{ error.path }}</td>
                            <td style="padding: 0.5rem; text-align: center;">
                                <span style="background-color: {% if error.error_type == '404' %}#e67e22{% elif error.error_type == '500' %}#c0392b{% else %}#e74c3c{% endif %}; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.75rem;">{{ error.error_type }}</span>
                            </td>
                            <td style="padding: 0.5rem; text-align: center; font-weight: bold;">{{ error.count }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" style="padding: 1rem; text-align: center; color: #27ae60;">No errors recorded!</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h4>Recent Errors</h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f8f9fa;">
                        <tr style="border-bottom: 2px solid #ddd;">
                            <th style="padding: 0.5rem; text-align: left;">Time</th>
                            <th style="padding: 0.5rem; text-align: left;">User</th>
                            <th style="padding: 0.5rem; text-align: left;">Path</th>
                            <th style="padding: 0.5rem; text-align: center;">Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for error in recent_errors %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 0.5rem; font-size: 0.85rem;">{{ error.created_at|date:"M d, H:i" }}</td>
                            <td style="padding: 0.5rem;">{{ error.user.username|default:"Anonymous" }}</td>
                            <td style="padding: 0.5rem; font-family: monospace; font-size: 0.85rem;">{{ error.path|truncatechars:50 }}</td>
                            <td style="padding: 0.5rem; text-align: center;">
                                <span style="background-color: {% if error.error_type == '404' %}#e67e22{% elif error.error_type == '500' %}#c0392b{% else %}#e74c3c{% endif %}; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.75rem;">{{ error.error_type }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" style="padding: 1rem; text-align: center; color: #27ae60;">No recent errors!</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detailed Stats Row -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <div class="card">
            <h3>Queue Activity</h3>
            <p><strong>Period:</strong> {{ queue_stats.total_period }} requests</p>
            <p><strong>All Time:</strong> {{ queue_stats.total_all_time }} requests</p>
            <p><strong>Completed (Period):</strong> {{ queue_stats.completed_period }} entries</p>
            <p><strong>Completed (All Time):</strong> {{ queue_stats.completed_all_time }} entries</p>
        </div>
        <div class="card">
            <h3>Feedback Status</h3>
            <p style="color: #e74c3c;"><strong>New:</strong> {{ feedback_stats.new }}</p>
            <p style="color: #f39c12;"><strong>Reviewed:</strong> {{ feedback_stats.reviewed }}</p>
            <p style="color: #27ae60;"><strong>Completed:</strong> {{ feedback_stats.completed }}</p>
            <p><strong>Total:</strong> {{ feedback_stats.total }}</p>
        </div>
        <div class="card">
            <h3>User Statistics</h3>
            <p><strong>Total Users:</strong> {{ user_types.total }}</p>
            <p><strong>Active (Period):</strong> {{ user_types.active_period }}</p>
            <p><strong>Staff Members:</strong> {{ user_types.staff }}</p>
            <p><strong>Developers:</strong> {{ user_types.developers }}</p>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Top Pages Chart
const topPagesCtx = document.getElementById('topPagesChart').getContext('2d');
new Chart(topPagesCtx, {
    type: 'bar',
    data: {
        labels: [{% for page in top_pages %}'{{ page.page_title }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Page Views',
            data: [{% for page in top_pages %}{{ page.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: '#3498db',
            borderColor: '#2980b9',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: { beginAtZero: true }
        }
    }
});

// Browsers Chart
const browsersCtx = document.getElementById('browsersChart').getContext('2d');
new Chart(browsersCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for browser, count in top_browsers %}'{{ browser }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for browser, count in top_browsers %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: ['#3498db', '#e74c3c', '#f39c12', '#9b59b6', '#27ae60'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Device Chart
const deviceCtx = document.getElementById('deviceChart').getContext('2d');
new Chart(deviceCtx, {
    type: 'pie',
    data: {
        labels: ['Desktop', 'Mobile', 'Tablet'],
        datasets: [{
            data: [{{ device_breakdown.desktop }}, {{ device_breakdown.mobile }}, {{ device_breakdown.tablet }}],
            backgroundColor: ['#3498db', '#e74c3c', '#f39c12'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Browser × Device Type Chart
const browserDeviceCtx = document.getElementById('browserDeviceChart').getContext('2d');
new Chart(browserDeviceCtx, {
    type: 'bar',
    data: {
        labels: [{% for combo, count in browser_device_stats %}'{{ combo }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Page Views',
            data: [{% for combo, count in browser_device_stats %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                '#3498db', '#e74c3c', '#f39c12', '#9b59b6', '#27ae60',
                '#16a085', '#2980b9', '#8e44ad', '#c0392b', '#d35400'
            ],
            borderColor: '#fff',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: { beginAtZero: true }
        }
    }
});

// Hourly Usage Chart
const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
new Chart(hourlyCtx, {
    type: 'line',
    data: {
        labels: [{% for label in hour_labels %}'{{ label }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Page Views',
            data: [{% for count in hour_counts %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: 'rgba(52, 152, 219, 0.2)',
            borderColor: '#3498db',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Daily Usage Chart
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'bar',
    data: {
        labels: [{% for label in day_labels %}'{{ label }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Page Views',
            data: [{% for count in day_counts %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: ['#3498db', '#e74c3c', '#f39c12', '#9b59b6', '#27ae60', '#16a085', '#2980b9'],
            borderColor: '#fff',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});
</script>
{% endblock %}
