{% extends 'base.html' %}
{% block title %}Edit User Information - Admin{% endblock %}

{% block content %}
<div class="card">
    <h1>Edit User Information</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">Editing information for user: <strong>{{ user_to_edit.username }}</strong></p>

    <div style="margin-top: 1rem;">
        <a href="{% url 'admin_users' %}" class="btn btn-secondary">‚Üê Back to User Management</a>
    </div>
</div>

<div class="card">
    <form method="post">
        {% csrf_token %}

        <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Account Information</h3>

        <!-- Username -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.username.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Username *
            </label>
            {{ form.username }}
            {% if form.username.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.username.errors }}</div>
            {% endif %}
        </div>

        <!-- Email -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.email.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Email *
            </label>
            {{ form.email }}
            {% if form.email.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.email.errors }}</div>
            {% endif %}
        </div>

        <!-- First Name -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.first_name.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                First Name
            </label>
            {{ form.first_name }}
            {% if form.first_name.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.first_name.errors }}</div>
            {% endif %}
        </div>

        <!-- Last Name -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.last_name.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Last Name
            </label>
            {{ form.last_name }}
            {% if form.last_name.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.last_name.errors }}</div>
            {% endif %}
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Profile Information</h3>

        <!-- Phone Number -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.phone_number.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.phone_number.label }}
            </label>
            {{ form.phone_number }}
            {% if form.phone_number.help_text %}
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">{{ form.phone_number.help_text }}</small>
            {% endif %}
            {% if form.phone_number.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.phone_number.errors }}</div>
            {% endif %}
        </div>

        <!-- Organization -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.organization.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.organization.label }}
            </label>
            {{ form.organization }}
            {% if form.organization.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.organization.errors }}</div>
            {% endif %}
        </div>

        <!-- Organization Other (conditional) -->
        <div id="organization-other-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ form.organization_other.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.organization_other.label }}
            </label>
            {{ form.organization_other }}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="organizationOtherError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="organizationOtherCharCount"></span></small>
            </div>
            {% if form.organization_other.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.organization_other.errors }}</div>
            {% endif %}
        </div>

        <!-- Department (conditional) -->
        <div id="department-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ form.department.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.department.label }}
            </label>
            {{ form.department }}
            {% if form.department.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.department.errors }}</div>
            {% endif %}
        </div>

        <!-- Department Other (conditional) -->
        <div id="department-other-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ form.department_other.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.department_other.label }}
            </label>
            {{ form.department_other }}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="departmentOtherError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="departmentOtherCharCount"></span></small>
            </div>
            {% if form.department_other.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.department_other.errors }}</div>
            {% endif %}
        </div>

        <!-- Notes -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.notes.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.notes.label }}
            </label>
            {{ form.notes }}
            {% if form.notes.help_text %}
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">{{ form.notes.help_text }}</small>
            {% endif %}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="notesError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="notesCharCount"></span></small>
            </div>
            {% if form.notes.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.notes.errors }}</div>
            {% endif %}
        </div>

        <!-- Slack Member ID -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.slack_member_id.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Slack Member ID
            </label>
            {{ form.slack_member_id }}
            <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">
                Optional - Leave blank for automatic lookup
            </small>
            {% if form.slack_member_id.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.slack_member_id.errors }}</div>
            {% endif %}
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Security Settings</h3>

        <!-- Security Question -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.security_question.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Security Question
            </label>
            {{ form.security_question }}
            {% if form.security_question.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.security_question.errors }}</div>
            {% endif %}
        </div>

        <!-- Custom Security Question -->
        <div id="customQuestionDiv" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ form.security_question_custom.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Custom Security Question
            </label>
            {{ form.security_question_custom }}
            {% if form.security_question_custom.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.security_question_custom.errors }}</div>
            {% endif %}
        </div>

        <!-- Security Answer -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.security_answer.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                New Security Answer
            </label>
            {{ form.security_answer }}
            <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">
                {{ form.security_answer.help_text }}
            </small>
            {% if form.security_answer.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.security_answer.errors }}</div>
            {% endif %}
        </div>

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn">Save Changes</button>
            <a href="{% url 'admin_users' %}" class="btn btn-secondary" style="margin-left: 1rem;">Cancel</a>
        </div>
    </form>
</div>

<script>
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const organizationSelect = document.getElementById('{{ form.organization.id_for_label }}');
    const organizationOtherField = document.getElementById('organization-other-field');
    const departmentField = document.getElementById('department-field');
    const departmentSelect = document.getElementById('{{ form.department.id_for_label }}');
    const departmentOtherField = document.getElementById('department-other-field');
    const securityQuestionSelect = document.getElementById('{{ form.security_question.id_for_label }}');
    const customQuestionDiv = document.getElementById('customQuestionDiv');

    // Handle organization selection changes
    function toggleOrganizationFields() {
        const orgValue = organizationSelect.value;

        // Show/hide organization_other field
        if (orgValue === 'other') {
            organizationOtherField.style.display = 'block';
        } else {
            organizationOtherField.style.display = 'none';
        }

        // Show/hide department field (only for UArk)
        if (orgValue === 'uark') {
            departmentField.style.display = 'block';
        } else {
            departmentField.style.display = 'none';
            // Reset department selection when hiding
            departmentSelect.value = '';
            departmentOtherField.style.display = 'none';
        }
    }

    // Handle department selection changes
    function toggleDepartmentOtherField() {
        const deptValue = departmentSelect.value;

        // Show/hide department_other field
        if (deptValue === 'other') {
            departmentOtherField.style.display = 'block';
        } else {
            departmentOtherField.style.display = 'none';
        }
    }

    // Handle security question changes
    function toggleCustomQuestion() {
        if (securityQuestionSelect.value === 'custom') {
            customQuestionDiv.style.display = 'block';
        } else {
            customQuestionDiv.style.display = 'none';
        }
    }

    // Add event listeners
    organizationSelect.addEventListener('change', toggleOrganizationFields);
    departmentSelect.addEventListener('change', toggleDepartmentOtherField);
    securityQuestionSelect.addEventListener('change', toggleCustomQuestion);

    // Initialize on page load
    toggleOrganizationFields();
    toggleDepartmentOtherField();
    toggleCustomQuestion();

    // Character counter functionality
    setupCharacterCounter('{{ form.organization_other.id_for_label }}', 'organizationOtherCharCount', 'organizationOtherError', 100);
    setupCharacterCounter('{{ form.department_other.id_for_label }}', 'departmentOtherCharCount', 'departmentOtherError', 100);
    setupCharacterCounter('{{ form.notes.id_for_label }}', 'notesCharCount', 'notesError', 500);
});

// Character counter setup function
function setupCharacterCounter(fieldId, counterId, errorId, maxLength) {
    const field = document.getElementById(fieldId);
    const counter = document.getElementById(counterId);
    const errorDiv = document.getElementById(errorId);

    if (!field || !counter || !errorDiv) return;

    function updateCounter() {
        let length = field.value.length;

        // Enforce max length
        if (length > maxLength) {
            field.value = field.value.slice(0, maxLength);
            length = maxLength;
        }

        const remaining = maxLength - length;

        // Display counter only when near the limit (25 or fewer characters remaining)
        if (remaining <= 25) {
            counter.textContent = remaining + " characters remaining";
            if (remaining <= 10) {
                counter.style.color = "#e74c3c"; // danger red
            } else {
                counter.style.color = "#f39c12"; // warning orange
            }
        } else {
            counter.textContent = "";
            counter.style.color = "#7f8c8d"; // normal gray
        }

        // Clear any error messages
        errorDiv.style.display = "none";
    }

    // Initialize counter on page load
    updateCounter();

    // Update on input
    field.addEventListener("input", updateCounter);
    field.addEventListener("keyup", updateCounter);
}
</script>

{% endblock %}
