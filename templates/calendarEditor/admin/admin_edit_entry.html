{% extends 'base.html' %}

{% block title %}Edit Queue Entry - Admin{% endblock %}

{% block content %}
<div class="card">
    <div id="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h1 style="margin: 0;">Edit Queue Entry</h1>
    </div>

    <!-- Entry Info -->
    <div style="background-color: #ecf0f1; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
        <p style="margin: 0.25rem 0;"><strong>User:</strong> {{ queue_entry.user.username }}</p>
        <p style="margin: 0.25rem 0;"><strong>Status:</strong> {{ queue_entry.get_status_display }}</p>
        <p style="margin: 0.25rem 0;"><strong>Submitted:</strong> {{ queue_entry.created_at|date:"M d, Y g:i A" }}</p>
    </div>

    <!-- Machine Selection and Queue Position Controls -->
    {% if not show_machine_warning %}
    <div style="background-color: #e8f4f8; border-left: 4px solid #3498db; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #2c3e50;">Machine Assignment & Queue Position</h3>

        <!-- Machine Selection -->
        <div style="margin-bottom: 1.5rem;">
            <label for="machine_select" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Current Machine:
            </label>
            {% if compatible_machines %}
                <select id="machine_select" name="machine_select" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem;">
                    {% for machine in compatible_machines %}
                        <option value="{{ machine.id }}" {% if machine.id == queue_entry.assigned_machine.id %}selected{% endif %}>
                            {{ machine.name }}{% if machine.id == queue_entry.assigned_machine.id %} (Current){% endif %}
                            - Available in {{ machine.get_estimated_wait_time.total_seconds|floatformat:0|add:"0"|floatformat:0 }}s
                            ({{ machine.get_queue_count }} in queue)
                        </option>
                    {% endfor %}
                </select>
                <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">
                    Showing {{ compatible_machines|length }} compatible machine{{ compatible_machines|length|pluralize }}.
                    Sorted by availability (earliest first).
                </small>
            {% else %}
                <p style="color: #e74c3c; margin: 0.5rem 0;">No compatible machines found for current requirements.</p>
            {% endif %}
        </div>

        <!-- Queue Position Controls (only for queued entries) -->
        {% if queue_entry.status == 'queued' %}
        <div style="margin-bottom: 0;">
            <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Queue Position: #{{ queue_entry.queue_position }} of {{ max_queue_position }}
            </label>
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="queue_position_action" value="keep" checked style="margin-right: 0.25rem;">
                    Keep Current (#{{ queue_entry.queue_position }})
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="queue_position_action" value="first" style="margin-right: 0.25rem;">
                    Move to First
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="queue_position_action" value="last" style="margin-right: 0.25rem;">
                    Move to Last
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="queue_position_action" value="custom" id="custom_position_radio" style="margin-right: 0.25rem;">
                    Custom:
                </label>
                <input type="number" name="manual_queue_position" id="manual_queue_position"
                       min="1" max="{{ max_queue_position }}" placeholder="#"
                       style="width: 60px; padding: 0.25rem; border: 1px solid #bdc3c7; border-radius: 4px;"
                       onfocus="document.getElementById('custom_position_radio').checked = true;">
            </div>
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">
                Position 1 is next to run (ON DECK). Max position: {{ max_queue_position }}
            </small>
        </div>
        {% else %}
        <div style="margin-bottom: 0;">
            <p style="color: #7f8c8d; margin: 0.5rem 0;"><strong>Queue Position:</strong> N/A (entry is currently running)</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if show_machine_warning %}
    <!-- Machine Change Warning -->
    <div style="background-color: #ffe6e6; border-left: 4px solid #e74c3c; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
        <h3 style="color: #e74c3c; margin-top: 0;">⚠️ Machine Reassignment Required</h3>
        <p style="margin: 0.5rem 0;">The changes you made require reassigning this entry to a different machine:</p>
        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li><strong>Current Machine:</strong> {{ old_machine.name }}</li>
            <li><strong>New Machine:</strong> {{ new_machine.name }} ({{ compatibility_score }}% compatible)</li>
        </ul>
        <p style="margin: 0.5rem 0;"><strong>The queue will be automatically reordered.</strong></p>
        <p style="margin: 0.5rem 0; font-weight: bold;">Do you want to proceed with these changes?</p>

        <form method="post" style="margin-top: 1rem; display: inline-block;">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="hidden" name="confirmed" value="true">
            <button type="submit" class="btn" style="background-color: #e74c3c; color: white;">Yes, Save Changes</button>
            <a href="{% url 'admin_queue' %}" class="btn btn-secondary" style="margin-left: 0.5rem;">Cancel</a>
        </form>
    </div>
    {% else %}

    <!-- Edit Form -->
    <form method="post" id="editForm">
        {% csrf_token %}
        <input type="hidden" name="manual_machine_id" id="manual_machine_id" value="">

        {% if form.non_field_errors %}
            <div style="background-color: #ffe6e6; color: #e74c3c; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- Title -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.title.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.title.label }}
            </label>
            {{ form.title }}
            {% if form.title.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.title.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.title.help_text }}</small>
            <small id="titleCounter" style="color: #7f8c8d; display: block; margin-top: 0.25rem;"></small>
        </div>

        <!-- Description -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.description.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.description.label }}
            </label>
            {{ form.description }}
            {% if form.description.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.description.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.description.help_text }}</small>
            <small id="descCounter" style="color: #7f8c8d; display: block; margin-top: 0.25rem;"></small>
        </div>

        <!-- Min Temperature -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_min_temp.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_min_temp.label }}
            </label>
            {{ form.required_min_temp }}
            {% if form.required_min_temp.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_min_temp.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_min_temp.help_text }}</small>
        </div>

        <!-- DEPRECATED: Max Temperature field removed as it was confusing to users -->
        {% comment %}
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_max_temp.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_max_temp.label }}
            </label>
            {{ form.required_max_temp }}
            {% if form.required_max_temp.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_max_temp.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_max_temp.help_text }}</small>
        </div>
        {% endcomment %}

        <!-- B-field X -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_b_field_x.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_b_field_x.label }}
            </label>
            {{ form.required_b_field_x }}
            {% if form.required_b_field_x.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_b_field_x.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_b_field_x.help_text }}</small>
        </div>

        <!-- B-field Y -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_b_field_y.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_b_field_y.label }}
            </label>
            {{ form.required_b_field_y }}
            {% if form.required_b_field_y.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_b_field_y.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_b_field_y.help_text }}</small>
        </div>

        <!-- B-field Z -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_b_field_z.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_b_field_z.label }}
            </label>
            {{ form.required_b_field_z }}
            {% if form.required_b_field_z.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_b_field_z.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_b_field_z.help_text }}</small>
        </div>

        <!-- B-field Direction -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_b_field_direction.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_b_field_direction.label }}
            </label>
            {{ form.required_b_field_direction }}
            {% if form.required_b_field_direction.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_b_field_direction.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_b_field_direction.help_text }}</small>
        </div>

        <!-- DC Lines -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_dc_lines.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_dc_lines.label }}
            </label>
            {{ form.required_dc_lines }}
            {% if form.required_dc_lines.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_dc_lines.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_dc_lines.help_text }}</small>
        </div>

        <!-- RF Lines -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_rf_lines.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_rf_lines.label }}
            </label>
            {{ form.required_rf_lines }}
            {% if form.required_rf_lines.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_rf_lines.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_rf_lines.help_text }}</small>
        </div>

        <!-- Daughterboard -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_daughterboard.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_daughterboard.label }}
            </label>
            {{ form.required_daughterboard }}
            {% if form.required_daughterboard.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_daughterboard.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_daughterboard.help_text }}</small>
        </div>

        <!-- Optical Requirements -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.requires_optical.id_for_label }}" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                <span title="">{{ form.requires_optical }}</span>
                <span style="margin-left: 0.5rem; font-weight: bold;">{{ form.requires_optical.label }}</span>
            </label>
            {% if form.requires_optical.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.requires_optical.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.requires_optical.help_text }}</small>
        </div>

        <!-- Estimated Duration -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.estimated_duration_hours.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.estimated_duration_hours.label }}
            </label>
            {{ form.estimated_duration_hours }}
            {% if form.estimated_duration_hours.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.estimated_duration_hours.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.estimated_duration_hours.help_text }}</small>
        </div>

        <!-- Special Requirements -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.special_requirements.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.special_requirements.label }}
            </label>
            {{ form.special_requirements }}
            {% if form.special_requirements.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.special_requirements.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.special_requirements.help_text }}</small>
            <small id="specialCounter" style="color: #7f8c8d; display: block; margin-top: 0.25rem;"></small>
        </div>

        <!-- Rush Job -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.is_rush_job.id_for_label }}" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                <span title="">{{ form.is_rush_job }}</span>
                <span style="margin-left: 0.5rem; font-weight: bold; color: #e74c3c;">{{ form.is_rush_job.label }}</span>
            </label>
            {% if form.is_rush_job.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.is_rush_job.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.is_rush_job.help_text }}</small>
        </div>

        <!-- Action Buttons -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #bdc3c7;">
            <button type="submit" class="btn">Save Changes</button>
            <a href="{% url 'admin_queue' %}" class="btn btn-secondary" style="margin-left: 1rem;">Cancel</a>
        </div>
    </form>
    {% endif %}
</div>

<script>
// Character counters and form submission handling
document.addEventListener('DOMContentLoaded', function() {
    const titleField = document.getElementById('{{ form.title.id_for_label }}');
    const titleCounter = document.getElementById('titleCounter');
    const descField = document.getElementById('{{ form.description.id_for_label }}');
    const descCounter = document.getElementById('descCounter');
    const specialField = document.getElementById('{{ form.special_requirements.id_for_label }}');
    const specialCounter = document.getElementById('specialCounter');

    function updateCounter(field, counter, maxLength) {
        if (field && counter) {
            const remaining = maxLength - field.value.length;
            counter.textContent = `${remaining} characters remaining`;
            counter.style.color = remaining < 20 ? '#e74c3c' : '#7f8c8d';
        }
    }

    if (titleField) {
        updateCounter(titleField, titleCounter, 75);
        titleField.addEventListener('input', function() {
            updateCounter(titleField, titleCounter, 75);
        });
    }

    if (descField) {
        updateCounter(descField, descCounter, 500);
        descField.addEventListener('input', function() {
            updateCounter(descField, descCounter, 500);
        });
    }

    if (specialField) {
        updateCounter(specialField, specialCounter, 500);
        specialField.addEventListener('input', function() {
            updateCounter(specialField, specialCounter, 500);
        });
    }

    // Handle form submission - copy machine selection to hidden field
    const editForm = document.getElementById('editForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            const machineSelect = document.getElementById('machine_select');
            const manualMachineId = document.getElementById('manual_machine_id');

            if (machineSelect && manualMachineId) {
                // Only set the hidden field if user changed the machine
                const currentMachineId = '{{ queue_entry.assigned_machine.id }}';
                if (machineSelect.value !== currentMachineId) {
                    manualMachineId.value = machineSelect.value;
                }
            }
        });
    }
});
</script>
{% endblock %}
