{% extends 'base.html' %}

{% block title %}Edit Queue Entry - Admin{% endblock %}

{% block content %}
<div class="card">
    <div id="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h1 style="margin: 0;">Edit Queue Entry</h1>
    </div>

    <!-- Entry Info -->
    <div style="background-color: #ecf0f1; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
        <p style="margin: 0.25rem 0;"><strong>User:</strong> {{ queue_entry.user.username }}</p>
        <p style="margin: 0.25rem 0;"><strong>Status:</strong> {{ queue_entry.get_status_display }}</p>
        <p style="margin: 0.25rem 0;"><strong>Submitted:</strong> {{ queue_entry.created_at|date:"M d, Y g:i A" }}</p>
    </div>

    <!-- Machine Selection and Queue Position Controls -->
    {% if not show_machine_warning %}
    <div style="background-color: #e8f4f8; border-left: 4px solid #3498db; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #2c3e50;">Machine Assignment & Queue Position</h3>

        <!-- Machine Selection -->
        <div style="margin-bottom: 1.5rem;">
            <label for="machine_select" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Current Machine:
            </label>
            {% if compatible_machines %}
                <select id="machine_select" name="machine_select" style="width: 100%; padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1rem;">
                    {% for machine in compatible_machines %}
                        <option value="{{ machine.id }}"
                                data-queue-count="{{ machine.get_queue_count }}"
                                data-adjusted-queue-count="{{ machine.adjusted_queue_count }}"
                                {% if machine.id == queue_entry.assigned_machine.id %}selected{% endif %}>
                            {% with wait_time=machine.get_estimated_wait_time %}
                                {{ machine.name }}{% if machine.id == queue_entry.assigned_machine.id %} (Current){% endif %} - {{ machine.get_queue_count }} in queue - Wait: {{ wait_time.days }}d {% widthratio wait_time.seconds 3600 1 %}h
                            {% endwith %}
                        </option>
                    {% endfor %}
                </select>
                <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">
                    Showing {{ compatible_machines|length }} compatible machine{{ compatible_machines|length|pluralize }}.
                    Sorted by availability (earliest first).
                </small>
            {% else %}
                <p style="color: #e74c3c; margin: 0.5rem 0;">No compatible machines found for current requirements.</p>
            {% endif %}
        </div>

        <!-- Queue Position Controls -->
        <div style="margin-bottom: 0;">
            {% if queue_entry.status == 'queued' %}
            <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Queue Position: #{{ queue_entry.queue_position }} of <span id="max_position_display">{{ max_queue_position }}</span>
            </label>
            {% else %}
            <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Queue Position: <span style="color: #e67e22;">Currently Running</span>
            </label>
            <p style="color: #7f8c8d; margin: 0.5rem 0; font-size: 0.9rem;">
                If reassigned to a machine with a running job, this entry will be queued. Select position below:
            </p>
            {% endif %}
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                {% if queue_entry.status == 'queued' %}
                <label id="keep_current_option" style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="queue_position_action" value="keep" id="keep_current_radio" checked style="margin-right: 0.25rem;">
                    Keep Current (#<span id="current_position_display">{{ queue_entry.queue_position }}</span>)
                </label>
                {% endif %}
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="queue_position_action" value="first" id="first_radio" {% if queue_entry.status == 'running' %}checked{% endif %} style="margin-right: 0.25rem;">
                    Move to First
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="queue_position_action" value="last" id="last_radio" style="margin-right: 0.25rem;">
                    Move to Last
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="queue_position_action" value="custom" id="custom_position_radio" style="margin-right: 0.25rem;">
                    Custom:
                </label>
                <input type="number" name="manual_queue_position" id="manual_queue_position"
                       min="1" max="{{ max_queue_position }}" placeholder="#"
                       style="width: 60px; padding: 0.25rem; border: 1px solid #bdc3c7; border-radius: 4px;"
                       onfocus="document.getElementById('custom_position_radio').checked = true;">
            </div>
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">
                Position 1 is next to run (ON DECK). Max position for selected machine: <span id="max_position_help">{{ max_queue_position }}</span>
            </small>
        </div>
    </div>
    {% endif %}

    {% if show_machine_warning %}
    <!-- Machine Change Warning -->
    <div style="background-color: #ffe6e6; border-left: 4px solid #e74c3c; padding: 1rem; margin-bottom: 1.5rem; border-radius: 4px;">
        <h3 style="color: #e74c3c; margin-top: 0;">⚠️ Machine Reassignment Required</h3>
        <p style="margin: 0.5rem 0;">The changes you made require reassigning this entry to a different machine:</p>
        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li><strong>Current Machine:</strong> {{ old_machine.name }}</li>
            <li><strong>New Machine:</strong> {{ new_machine.name }} ({{ compatibility_score }}% compatible)</li>
        </ul>
        <p style="margin: 0.5rem 0;"><strong>The queue will be automatically reordered.</strong></p>
        <p style="margin: 0.5rem 0; font-weight: bold;">Do you want to proceed with these changes?</p>

        <form method="post" style="margin-top: 1rem; display: inline-block;">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="hidden" name="confirmed" value="true">
            <button type="submit" class="btn" style="background-color: #e74c3c; color: white;">Yes, Save Changes</button>
            <a href="{% url 'admin_queue' %}" class="btn btn-secondary" style="margin-left: 0.5rem;">Cancel</a>
        </form>
    </div>
    {% else %}

    <!-- Edit Form -->
    <form method="post" id="editForm">
        {% csrf_token %}
        <input type="hidden" name="manual_machine_id" id="manual_machine_id" value="">

        {% if form.non_field_errors %}
            <div style="background-color: #ffe6e6; color: #e74c3c; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- Title -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.title.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.title.label }}
            </label>
            {{ form.title }}
            {% if form.title.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.title.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.title.help_text }}</small>
            <small id="titleCounter" style="color: #7f8c8d; display: block; margin-top: 0.25rem;"></small>
        </div>

        <!-- Description -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.description.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.description.label }}
            </label>
            {{ form.description }}
            {% if form.description.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.description.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.description.help_text }}</small>
            <small id="descCounter" style="color: #7f8c8d; display: block; margin-top: 0.25rem;"></small>
        </div>

        <!-- Min Temperature -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_min_temp.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_min_temp.label }}
            </label>
            {{ form.required_min_temp }}
            {% if form.required_min_temp.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_min_temp.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_min_temp.help_text }}</small>
        </div>

        <!-- DEPRECATED: Max Temperature field removed as it was confusing to users -->
        {% comment %}
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_max_temp.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_max_temp.label }}
            </label>
            {{ form.required_max_temp }}
            {% if form.required_max_temp.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_max_temp.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_max_temp.help_text }}</small>
        </div>
        {% endcomment %}

        <!-- B-field X -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_b_field_x.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_b_field_x.label }}
            </label>
            {{ form.required_b_field_x }}
            {% if form.required_b_field_x.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_b_field_x.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_b_field_x.help_text }}</small>
        </div>

        <!-- B-field Y -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_b_field_y.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_b_field_y.label }}
            </label>
            {{ form.required_b_field_y }}
            {% if form.required_b_field_y.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_b_field_y.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_b_field_y.help_text }}</small>
        </div>

        <!-- B-field Z -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_b_field_z.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_b_field_z.label }}
            </label>
            {{ form.required_b_field_z }}
            {% if form.required_b_field_z.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_b_field_z.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_b_field_z.help_text }}</small>
        </div>

        <!-- B-field Direction -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_b_field_direction.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_b_field_direction.label }}
            </label>
            {{ form.required_b_field_direction }}
            {% if form.required_b_field_direction.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_b_field_direction.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_b_field_direction.help_text }}</small>
        </div>

        <!-- DC Lines -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_dc_lines.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_dc_lines.label }}
            </label>
            {{ form.required_dc_lines }}
            {% if form.required_dc_lines.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_dc_lines.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_dc_lines.help_text }}</small>
        </div>

        <!-- RF Lines -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_rf_lines.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_rf_lines.label }}
            </label>
            {{ form.required_rf_lines }}
            {% if form.required_rf_lines.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_rf_lines.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_rf_lines.help_text }}</small>
        </div>

        <!-- Daughterboard -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.required_daughterboard.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.required_daughterboard.label }}
            </label>
            {{ form.required_daughterboard }}
            {% if form.required_daughterboard.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.required_daughterboard.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.required_daughterboard.help_text }}</small>
        </div>

        <!-- Optical Requirements -->
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <label for="{{ form.requires_optical.id_for_label }}" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                    <span title="">{{ form.requires_optical }}</span>
                    <span style="margin-left: 0.5rem; font-weight: bold;">{{ form.requires_optical.label }}</span>
                </label>
                <button type="button" id="viewOpticalMachinesBtn" class="btn btn-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                    View Compatible Machines
                </button>
            </div>
            {% if form.requires_optical.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.requires_optical.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.requires_optical.help_text }} Click "View Compatible Machines" to see which machines match these requirements and have optical capabilities.</small>
        </div>

        <!-- Estimated Duration -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.estimated_duration_hours.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.estimated_duration_hours.label }}
            </label>
            {{ form.estimated_duration_hours }}
            {% if form.estimated_duration_hours.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.estimated_duration_hours.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.estimated_duration_hours.help_text }}</small>
        </div>

        <!-- Special Requirements -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.special_requirements.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.special_requirements.label }}
            </label>
            {{ form.special_requirements }}
            {% if form.special_requirements.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.special_requirements.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.special_requirements.help_text }}</small>
            <small id="specialCounter" style="color: #7f8c8d; display: block; margin-top: 0.25rem;"></small>
        </div>

        <!-- Rush Job -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.is_rush_job.id_for_label }}" style="display: flex; align-items: center; cursor: pointer; padding: 12px; margin: -12px;">
                <span title="">{{ form.is_rush_job }}</span>
                <span style="margin-left: 0.5rem; font-weight: bold; color: #e74c3c;">{{ form.is_rush_job.label }}</span>
            </label>
            {% if form.is_rush_job.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.is_rush_job.errors }}</div>
            {% endif %}
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">{{ form.is_rush_job.help_text }}</small>
        </div>

        <!-- Action Buttons -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #bdc3c7;">
            <button type="submit" class="btn">Save Changes</button>
            <a href="{% url 'admin_queue' %}" class="btn btn-secondary" style="margin-left: 1rem;">Cancel</a>
        </div>
    </form>
    {% endif %}
</div>

<script>
// Character counters and form submission handling
document.addEventListener('DOMContentLoaded', function() {
    const titleField = document.getElementById('{{ form.title.id_for_label }}');
    const titleCounter = document.getElementById('titleCounter');
    const descField = document.getElementById('{{ form.description.id_for_label }}');
    const descCounter = document.getElementById('descCounter');
    const specialField = document.getElementById('{{ form.special_requirements.id_for_label }}');
    const specialCounter = document.getElementById('specialCounter');

    function updateCounter(field, counter, maxLength) {
        if (field && counter) {
            const remaining = maxLength - field.value.length;
            counter.textContent = `${remaining} characters remaining`;
            counter.style.color = remaining < 20 ? '#e74c3c' : '#7f8c8d';
        }
    }

    if (titleField) {
        updateCounter(titleField, titleCounter, 75);
        titleField.addEventListener('input', function() {
            updateCounter(titleField, titleCounter, 75);
        });
    }

    if (descField) {
        updateCounter(descField, descCounter, 500);
        descField.addEventListener('input', function() {
            updateCounter(descField, descCounter, 500);
        });
    }

    if (specialField) {
        updateCounter(specialField, specialCounter, 500);
        specialField.addEventListener('input', function() {
            updateCounter(specialField, specialCounter, 500);
        });
    }

    // Update queue position max when machine selection changes
    const machineSelect = document.getElementById('machine_select');
    if (machineSelect) {
        const originalMachineId = '{{ queue_entry.assigned_machine.id }}';
        const keepCurrentOption = document.getElementById('keep_current_option');
        const keepCurrentRadio = document.getElementById('keep_current_radio');
        const lastRadio = document.getElementById('last_radio');
        const firstRadio = document.getElementById('first_radio');

        machineSelect.addEventListener('change', function() {
            const selectedOption = machineSelect.options[machineSelect.selectedIndex];
            const selectedMachineId = machineSelect.value;
            // Use adjusted queue count which accounts for this entry being moved to the selected machine
            const adjustedCount = parseInt(selectedOption.getAttribute('data-adjusted-queue-count') || '1');

            // Update max position displays
            const maxPositionDisplay = document.getElementById('max_position_display');
            const maxPositionHelp = document.getElementById('max_position_help');
            const manualPositionInput = document.getElementById('manual_queue_position');

            if (maxPositionDisplay) {
                maxPositionDisplay.textContent = adjustedCount;
            }
            if (maxPositionHelp) {
                maxPositionHelp.textContent = adjustedCount;
            }
            if (manualPositionInput) {
                manualPositionInput.max = adjustedCount;
            }

            // Handle "Keep Current" option visibility
            if (keepCurrentOption && keepCurrentRadio && lastRadio) {
                if (selectedMachineId === originalMachineId) {
                    // Machine unchanged - show "Keep Current" and make it default
                    keepCurrentOption.style.display = 'flex';
                    keepCurrentRadio.checked = true;
                } else {
                    // Machine changed - hide "Keep Current" and default to "Move to Last"
                    keepCurrentOption.style.display = 'none';
                    if (keepCurrentRadio.checked) {
                        lastRadio.checked = true;
                    }
                }
            }
        });
    }

    // Handle form submission - copy machine selection to hidden field
    const editForm = document.getElementById('editForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            const machineSelect = document.getElementById('machine_select');
            const manualMachineId = document.getElementById('manual_machine_id');

            if (machineSelect && manualMachineId) {
                // Only set the hidden field if user changed the machine
                const currentMachineId = '{{ queue_entry.assigned_machine.id }}';
                if (machineSelect.value !== currentMachineId) {
                    manualMachineId.value = machineSelect.value;
                }
            }
        });
    }

    // Optical Capabilities Modal Logic (Informational Only)
    const opticalCheckbox = document.getElementById('{{ form.requires_optical.id_for_label }}');
    const opticalModal = document.getElementById('opticalCapabilitiesModal');
    const cancelOpticalBtn = document.getElementById('cancelOpticalBtn');
    const viewMachinesBtn = document.getElementById('viewOpticalMachinesBtn');

    if (opticalCheckbox && opticalModal && viewMachinesBtn) {
        // Show modal when "View Compatible Machines" button is clicked
        viewMachinesBtn.addEventListener('click', function() {
            showOpticalModal();
        });

        function showOpticalModal() {
            // Collect form data for filtering machines
            const formData = new FormData(editForm);
            const params = new URLSearchParams();

            // Add all requirements to query parameters
            params.append('required_min_temp', formData.get('required_min_temp') || '0');
            if (formData.get('required_max_temp')) {
                params.append('required_max_temp', formData.get('required_max_temp'));
            }
            params.append('required_b_field_x', formData.get('required_b_field_x') || '0');
            params.append('required_b_field_y', formData.get('required_b_field_y') || '0');
            params.append('required_b_field_z', formData.get('required_b_field_z') || '0');
            params.append('required_b_field_direction', formData.get('required_b_field_direction') || '');
            params.append('required_dc_lines', formData.get('required_dc_lines') || '0');
            params.append('required_rf_lines', formData.get('required_rf_lines') || '0');
            params.append('required_daughterboard', formData.get('required_daughterboard') || '');

            // Fetch filtered optical machines from API
            fetch(`/schedule/api/optical-machines/?${params.toString()}`)
                .then(r => r.json())
                .then(data => {
                    const machineListContainer = document.getElementById('opticalMachineList');
                    if (!machineListContainer) {
                        console.error('Machine list container not found');
                        return;
                    }

                    // Clear existing content
                    machineListContainer.innerHTML = '';

                    if (data.machines && data.machines.length > 0) {
                        // Build machine info cards dynamically
                        data.machines.forEach(machine => {
                            const card = document.createElement('div');
                            card.style.cssText = 'padding: 1.5rem; border: 2px solid #3498db; border-radius: 8px; background-color: #ecf0f1;';

                            card.innerHTML = `
                                <div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #2c3e50;">${machine.name}</h3>
                                    <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">${machine.optical_capabilities}</p>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #16a085;">
                                        Current queue: ${machine.queue_count} entries
                                    </p>
                                </div>
                            `;

                            machineListContainer.appendChild(card);
                        });
                    } else {
                        // No machines match requirements
                        machineListContainer.innerHTML = `
                            <p style="color: #e74c3c; text-align: center; padding: 2rem;">
                                No machines with optical capabilities match your requirements. Please adjust your requirements or contact an administrator.
                            </p>
                        `;
                    }

                    // Show modal
                    opticalModal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading optical machines:', error);
                    // Show error in modal
                    const machineListContainer = document.getElementById('opticalMachineList');
                    if (machineListContainer) {
                        machineListContainer.innerHTML = `
                            <p style="color: #e74c3c; text-align: center; padding: 2rem;">
                                Error loading machines. Please try again.
                            </p>
                        `;
                    }
                    opticalModal.style.display = 'block';
                });
        }

        function closeOpticalModal() {
            opticalModal.style.display = 'none';
        }

        // Cancel/Close button
        if (cancelOpticalBtn) {
            cancelOpticalBtn.addEventListener('click', closeOpticalModal);
        }

        // Close on backdrop click
        opticalModal.addEventListener('click', function(e) {
            if (e.target === opticalModal) {
                closeOpticalModal();
            }
        });
    }
});
</script>

<!-- Optical Capabilities Info Modal -->
<div id="opticalCapabilitiesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1000; overflow: auto;">
    <div style="background-color: #fefefe; margin: 10% auto; padding: 2rem; border: 1px solid #888; border-radius: 8px; width: 80%; max-width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="margin-top: 0; color: #2c3e50;">Compatible Machines with Optical Capabilities</h2>
        <p style="color: #7f8c8d; margin-bottom: 1.5rem;">
            Based on your current requirements, these machines have optical capabilities and meet all specifications:
        </p>

        <div id="opticalMachineList" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
            <!-- Machines will be loaded dynamically via JavaScript -->
            <p style="text-align: center; padding: 2rem; color: #7f8c8d;">Loading available machines...</p>
        </div>

        <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
            <button type="button" id="cancelOpticalBtn" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

{% endblock %}
