{% extends 'base.html' %}

{% block title %}Admin Dashboard - Lab Equipment Queue{% endblock %}

{% block content %}
<div class="card">
    <h1>Admin Dashboard</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">Welcome, {{ user.username }}. Manage users, machines, and queue entries.</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <!-- User Stats -->
    <div class="card" style="border-left: 4px solid #e74c3c;">
        <h3 style="margin-top: 0; color: #e74c3c;">Pending Users</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">{{ pending_users }}</p>
        <a href="{% url 'admin_users' %}?status=pending" class="btn">Review Pending Users</a>
    </div>

    <!-- Total Users -->
    <div class="card" style="border-left: 4px solid #3498db;">
        <h3 style="margin-top: 0; color: #3498db;">Total Users</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">{{ total_users }}</p>
        <a href="{% url 'admin_users' %}" class="btn">Manage Users</a>
    </div>

    <!-- Machines -->
    <div class="card" style="border-left: 4px solid #2ecc71;">
        <h3 style="margin-top: 0; color: #2ecc71;">Machines</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">{{ active_machines }}/{{ total_machines }}</p>
        <small style="color: #7f8c8d;">Active / Total</small><br>
        <a href="{% url 'admin_machines' %}" class="btn" style="margin-top: 0.5rem;">Manage Machines</a>
    </div>

    <!-- Queue Entries -->
    <div class="card" style="border-left: 4px solid #f39c12;">
        <h3 style="margin-top: 0; color: #f39c12;">Queue Entries</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">{{ queued_entries }}</p>
        <small style="color: #7f8c8d;">Queued</small><br>
        <a href="{% url 'admin_queue' %}" class="btn" style="margin-top: 0.5rem;">Manage Queue</a>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
    <!-- Running Entries -->
    <div class="card" style="border-left: 4px solid #9b59b6;">
        <h3 style="margin-top: 0; color: #9b59b6;">Running Experiments</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">{{ running_entries }}</p>
        <a href="{% url 'admin_queue' %}?status=running" class="btn">View Running</a>
    </div>

    <!-- Rush Jobs -->
    <div class="card" style="border-left: 4px solid #e67e22;">
        <h3 style="margin-top: 0; color: #e67e22;">Rush Job Appeals</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">{{ rush_jobs }}</p>
        <a href="{% url 'admin_rush_jobs' %}" class="btn">Review Rush Jobs</a>
    </div>

    <!-- Presets -->
    <div class="card" style="border-left: 4px solid #1abc9c;">
        <h3 style="margin-top: 0; color: #1abc9c;">Total Presets</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;">{{ total_presets }}</p>
        <a href="{% url 'admin_presets' %}" class="btn">Manage Presets</a>
    </div>

    <!-- Database Storage -->
    <div class="card" id="storage-widget" style="border-left: 4px solid #95a5a6;">
        <h3 style="margin-top: 0; color: #95a5a6;">Database Storage</h3>
        <p style="font-size: 2.5rem; font-weight: bold; margin: 1rem 0;" id="storage-usage">
            <span style="font-size: 1rem; color: #7f8c8d;">Loading...</span>
        </p>
        <div id="storage-bar" style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden; margin: 1rem 0;">
            <div id="storage-progress" style="width: 0%; height: 100%; background: #95a5a6; transition: width 0.3s;"></div>
        </div>
        <a href="{% url 'admin_archive_management' %}" class="btn">Manage Storage</a>
    </div>

    <!-- Django Admin Link -->
    <div class="card" style="border-left: 4px solid #34495e;">
        <h3 style="margin-top: 0; color: #34495e;">Django Admin</h3>
        <p style="color: #7f8c8d; margin: 1rem 0;">Access the default Django admin interface for advanced management.</p>
        <a href="/admin/" class="btn">Go to Django Admin</a>
    </div>
</div>

<script>
// Load storage stats dynamically
fetch('{% url "admin_storage_stats" %}')
    .then(response => response.json())
    .then(data => {
        const usageText = document.getElementById('storage-usage');
        const widget = document.getElementById('storage-widget');
        const progress = document.getElementById('storage-progress');

        usageText.innerHTML = data.used_percentage + '%';
        progress.style.width = data.used_percentage + '%';

        // Color based on status
        let color = '#95a5a6';  // default gray
        if (data.status === 'critical') {
            color = '#e74c3c';  // red
            widget.innerHTML += '<div style="background: #fee; border-left: 4px solid #e74c3c; padding: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem;"><strong style="color: #e74c3c;">CRITICAL</strong> - Clear archive soon!</div>';
        } else if (data.status === 'warning') {
            color = '#f39c12';  // orange
            widget.querySelector('h3').style.color = color;
            progress.style.background = color;
            widget.style.borderLeftColor = color;
        } else if (data.status === 'ok') {
            color = '#2ecc71';  // green
        }

        widget.querySelector('h3').style.color = color;
        progress.style.background = color;
        widget.style.borderLeftColor = color;
    })
    .catch(error => {
        console.error('Error loading storage stats:', error);
        document.getElementById('storage-usage').innerHTML = '<span style="font-size: 1rem; color: #e74c3c;">Error</span>';
    });
</script>
{% endblock %}
