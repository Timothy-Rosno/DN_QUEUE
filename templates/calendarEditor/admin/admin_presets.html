{% extends 'base.html' %}
{% load static %}
{% block title %}Manage Presets - Admin{% endblock %}

{% block content %}
<style>
/* Collapsible card styles */
.card-header {
    cursor: pointer;
    user-select: none;
}

.card-details {
    padding: 1.5rem;
    border-top: 1px solid #ddd;
    display: none;
}

.card-details.open {
    display: block;
}

.expand-icon {
    font-size: 1.2rem;
    transition: transform 0.3s;
    display: inline-block;
}

.expand-icon.open {
    transform: rotate(180deg);
}

.preset-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 800px;
}
.preset-table th,
.preset-table td {
    padding: 0.5rem 0.75rem;
    vertical-align: top;
    text-align: left;
}
.preset-table thead tr {
    border-bottom: 2px solid #ddd;
}
.preset-table tbody tr {
    border-bottom: 1px solid #eee;
}
.preset-table tbody tr:hover {
    background-color: #f8f9fa;
}
/* Text overflow handling - apply directly to td */
.preset-table td.ellipsis {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>

<div class="card">
    <h1>Manage Presets</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">View and manage all queue presets (public and private).</p>
    <div style="margin-top: 1rem;">
        <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">← Back to Dashboard</a>
    </div>
</div>

<!-- Summary Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="card" style="border-left: 4px solid #1abc9c;">
        <h3 style="margin-top: 0; color: #1abc9c;">Public Presets</h3>
        <p style="font-size: 2rem; font-weight: bold; margin: 0.5rem 0;">{{ total_public }}</p>
    </div>
    <div class="card" style="border-left: 4px solid #9b59b6;">
        <h3 style="margin-top: 0; color: #9b59b6;">Private Presets</h3>
        <p style="font-size: 2rem; font-weight: bold; margin: 0.5rem 0;">{{ total_private }}</p>
    </div>
</div>

<!-- Public Presets -->
<div class="card" style="border-left: 4px solid #1abc9c;">
    <div class="card-header" onclick="toggleCard('public-presets')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #1abc9c;">Public Presets ({{ total_public }})</h2>
            <span class="expand-icon open" id="icon-public-presets">▼</span>
        </div>
    </div>
    <div class="card-details open" id="details-public-presets">
        {% if public_presets %}
        <div style="overflow-x: auto; margin: 0 -1.5rem; padding: 0 1.5rem;">
            <table class="preset-table">
            <thead>
                <tr>
                    <th style="width: 12%;">Author</th>
                    <th style="width: 35%;">Preset Name</th>
                    <th style="width: 28%;">Last Edited</th>
                    <th style="width: 25%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for username, presets in public_presets.items %}
                    {% for preset in presets %}
                    <tr>
                        <td class="ellipsis" title="{{ preset.creator_username }}">
                            <strong style="color: #2c3e50;">{{ preset.creator_username }}</strong>
                        </td>
                        <td class="ellipsis" title="{{ preset.name }}{% if preset.title %} - {{ preset.title }}{% endif %}">
                            <strong>{{ preset.name }}</strong>
                            {% if preset.title %}
                                <span style="color: #7f8c8d; font-size: 0.85rem;"> - {{ preset.title }}</span>
                            {% endif %}
                        </td>
                        <td style="white-space: nowrap;">
                            <div style="font-size: 0.9rem;">{{ preset.last_edited_at|date:"M d, Y H:i" }}</div>
                            {% if preset.last_edited_by %}
                                <div style="color: #7f8c8d; font-size: 0.85rem;">by {{ preset.last_edited_by.username }}</div>
                            {% endif %}
                        </td>
                        <td style="white-space: nowrap;">
                            <a href="{% url 'edit_preset' preset.id %}?from_admin=true" class="btn btn-sm" style="background-color: #3498db; color: white;">Edit</a>
                            <button type="button" class="btn btn-sm btn-danger delete-preset-btn" data-preset-id="{{ preset.id }}" data-preset-name="{{ preset.name }}">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
            <p style="color: #7f8c8d; font-style: italic;">No public presets found.</p>
        {% endif %}
    </div>
</div>

<!-- Private Presets -->
<div class="card" style="border-left: 4px solid #9b59b6;">
    <div class="card-header" onclick="toggleCard('private-presets')">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #9b59b6;">Private Presets ({{ total_private }})</h2>
            <span class="expand-icon open" id="icon-private-presets">▼</span>
        </div>
    </div>
    <div class="card-details open" id="details-private-presets">
        {% if private_presets %}
        <div style="overflow-x: auto; margin: 0 -1.5rem; padding: 0 1.5rem;">
            <table class="preset-table">
            <thead>
                <tr>
                    <th style="width: 12%;">Author</th>
                    <th style="width: 35%;">Preset Name</th>
                    <th style="width: 28%;">Last Edited</th>
                    <th style="width: 25%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for username, presets in private_presets.items %}
                    {% for preset in presets %}
                    <tr>
                        <td class="ellipsis" title="{{ preset.creator_username }}">
                            <strong style="color: #2c3e50;">{{ preset.creator_username }}</strong>
                        </td>
                        <td class="ellipsis" title="{{ preset.name }}{% if preset.title %} - {{ preset.title }}{% endif %}">
                            <strong>{{ preset.name }}</strong>
                            {% if preset.title %}
                                <span style="color: #7f8c8d; font-size: 0.85rem;"> - {{ preset.title }}</span>
                            {% endif %}
                        </td>
                        <td style="white-space: nowrap;">
                            <div style="font-size: 0.9rem;">{{ preset.last_edited_at|date:"M d, Y H:i" }}</div>
                            {% if preset.last_edited_by %}
                                <div style="color: #7f8c8d; font-size: 0.85rem;">by {{ preset.last_edited_by.username }}</div>
                            {% endif %}
                        </td>
                        <td style="white-space: nowrap;">
                            {% if preset.creator_username == current_user.username %}
                                {# Creator can edit/delete their own presets #}
                                <a href="{% url 'edit_preset' preset.id %}?from_admin=true" class="btn btn-sm" style="background-color: #3498db; color: white;">Edit</a>
                                <button type="button" class="btn btn-sm btn-danger delete-preset-btn" data-preset-id="{{ preset.id }}" data-preset-name="{{ preset.name }}">Delete</button>
                            {% elif current_user.is_superuser and not preset.creator_is_approved %}
                                {# Superusers can delete orphaned presets (creator no longer approved) #}
                                <a href="{% url 'view_preset' preset.id %}?from_admin=true" class="btn btn-sm" style="background-color: #7f8c8d; color: white;">View</a>
                                <button type="button" class="btn btn-sm btn-danger delete-preset-btn" data-preset-id="{{ preset.id }}" data-preset-name="{{ preset.name }}" title="Author is no longer an approved account">Delete</button>
                            {% else %}
                                {# Staff/admin can only view private presets #}
                                <a href="{% url 'view_preset' preset.id %}?from_admin=true" class="btn btn-sm" style="background-color: #7f8c8d; color: white;">View</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
            <p style="color: #7f8c8d; font-style: italic;">No private presets found.</p>
        {% endif %}
    </div>
</div>

<div style="margin-top: 1rem;">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">← Back to Dashboard</a>
</div>

<!-- Hidden CSRF token for JavaScript -->
{% csrf_token %}

<!-- Thanos Delete Confirmation Modal -->
<div id="thanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:400px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p id="thanosMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-wrap: break-word;"></p>
        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="thanosYes" class="btn btn-danger">Yes, snap it immediately</button>
            <button id="thanosNo" class="btn btn-secondary">No, spare its variables</button>
        </div>
        <span id="thanosClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<script>
// Toggle collapsible card sections
function toggleCard(cardId) {
    const details = document.getElementById('details-' + cardId);
    const icon = document.getElementById('icon-' + cardId);

    if (details.classList.contains('open')) {
        details.classList.remove('open');
        icon.classList.remove('open');
    } else {
        details.classList.add('open');
        icon.classList.add('open');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('thanosModal');
    const message = document.getElementById('thanosMessage');
    const btnYes = document.getElementById('thanosYes');
    const btnNo = document.getElementById('thanosNo');
    const btnClose = document.getElementById('thanosClose');
    let currentPresetId = null;
    let currentPresetName = null;

    // Open modal when delete button clicked
    document.querySelectorAll('.delete-preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentPresetId = this.getAttribute('data-preset-id');
            currentPresetName = this.getAttribute('data-preset-name');
            message.textContent = `Are you sure you want to delete preset "${currentPresetName}"?`;
            modal.style.display = 'flex';
        });
    });

    // Yes button: submit delete form
    btnYes.addEventListener('click', function() {
        if (currentPresetId) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/schedule/preset/delete/${currentPresetId}/`;

            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
    });

    // No button: close modal
    btnNo.addEventListener('click', function() {
        modal.style.display = 'none';
        currentPresetId = null;
        currentPresetName = null;
    });

    // Close button: close modal
    btnClose.addEventListener('click', function() {
        modal.style.display = 'none';
        currentPresetId = null;
        currentPresetName = null;
    });

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if(e.target === modal) {
            modal.style.display = 'none';
            currentPresetId = null;
            currentPresetName = null;
        }
    });
});
</script>
{% endblock %}
