{% extends 'base.html' %}
{% load static %}

{% block title %}Queue Management - Admin{% endblock %}

{% block content %}
<div class="card">
    <h1>Queue Management</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">View and manage all queue entries.</p>
    <div style="margin-top: 1rem;">
        <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">← Back to Dashboard</a>
    </div>
</div>

<!-- <div class="card">
    <form method="get" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
        <div style="min-width: 150px;">
            <label for="status" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Status</label>
            <select name="status" id="status" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                <option value="queued" {% if status_filter == 'queued' %}selected{% endif %}>Queued</option>
                <option value="running" {% if status_filter == 'running' %}selected{% endif %}>Running</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>

        <div style="min-width: 200px;">
            <label for="machine" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Machine</label>
            <select name="machine" id="machine" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all" {% if machine_filter == 'all' %}selected{% endif %}>All Machines</option>
                {% for machine in machines %}
                    <option value="{{ machine.id }}" {% if machine_filter == machine.id|stringformat:"s" %}selected{% endif %}>{{ machine.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <button type="submit" class="btn">Filter</button>
            <a href="{% url 'admin_queue' %}" class="btn btn-secondary">Clear</a>
        </div>
    </form>
</div> -->

<div class="card">
    <h2>Queue Entries by Machine</h2>

    {% if machine_queue_data %}
        {% for machine_data in machine_queue_data %}
            <div style="margin-bottom: 2rem; border: 2px solid #3498db; border-radius: 8px; padding: 1.5rem;">
                <h3 style="margin-top: 0; color: #3498db;">
                    {% if machine_data.machine %}
                        {{ machine_data.machine.name }}
                    {% else %}
                        Unassigned Entries
                    {% endif %}
                    <span style="color: #7f8c8d; font-size: 0.9rem; font-weight: normal;">({{ machine_data.entries|length }} entries)</span>
                </h3>

                {% if machine_data.entries %}
                <div style="overflow-x: auto; margin-top: 1rem;">
                <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #ddd; text-align: left;">
                            <th style="padding: 0.75rem; width: 60px;">Position</th>
                            <th style="padding: 0.75rem;">Title</th>
                            <th style="padding: 0.75rem;">User</th>
                            <th style="padding: 0.75rem;">Status</th>
                            <th style="padding: 0.75rem;">Duration</th>
                            <th style="padding: 0.75rem;">Submitted</th>
                            <th style="padding: 0.75rem; width: 200px;">Queue Controls</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in machine_data.entries %}
                        <tr style="border-bottom: 1px solid #eee; {% if entry.is_rush_job %}background-color: #fff3cd;{% elif entry.status == 'running' %}background-color: #f0e6ff;{% endif %}">
                            <td style="padding: 0.75rem; text-align: center;">
                                {% if entry.status == 'running' %}
                                    <strong style="font-size: 1.2rem;">0</strong>
                                {% else %}
                                    <strong style="font-size: 1.2rem;">{{ entry.queue_position|default:"—" }}</strong>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem; max-width: 200px;">
                                <strong><span data-tooltip="Description: {{ entry.description }}" style="display: inline-block; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ entry.title|truncatechars:30 }}</span></strong>
                                {% if entry.is_rush_job %}
                                    <span style="background-color: #e67e22; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">RUSH</span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem;">{{ entry.user.username }}</td>
                            <td style="padding: 0.75rem;">
                                <span style="color: {% if entry.status == 'queued' %}#f39c12{% elif entry.status == 'running' %}#9b59b6{% elif entry.status == 'completed' %}#2ecc71{% else %}#95a5a6{% endif %}; font-weight: bold;">
                                    {{ entry.get_status_display }}
                                </span>
                            </td>
                            <td style="padding: 0.75rem;">{{ entry.estimated_duration_hours }} hrs</td>
                            <td style="padding: 0.75rem;">{{ entry.submitted_at|date:"M d" }}</td>
                            <td style="padding: 0.75rem; display: flex; gap: 0.5rem; align-items: stretch;">

                                {% if entry.status == 'queued' and entry.assigned_machine %}
                                    <!-- Left column: main actions (Start / Move to First) -->
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem; flex: 1 1 auto; min-height: 60px;">
                                        {% if entry.queue_position == 1 %}
                                            {% if entry.assigned_machine.id not in machines_with_running_jobs %}
                                            <form method="post" action="{% url 'admin_check_in' entry.id %}" style="display: flex; flex: 1;" onsubmit="saveScrollPosition(); disableCheckInButton(this);">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success btn-sm check-in-btn" style="flex: 1; width: 100%; height: 100%;" title="Start job">Start</button>
                                            </form>
                                            {% else %}
                                            <div style="display: flex; flex: 1;">
                                                <button type="button" class="btn btn-secondary btn-sm" style="flex: 1; width: 100%; height: 100%; cursor: not-allowed; opacity: 0.6;" disabled title="Machine is currently running another job">Waiting</button>
                                            </div>
                                            {% endif %}
                                        {% else %}
                                            <form method="post" action="{% url 'queue_next' entry.id %}" style="display: flex; flex: 1;" onsubmit="saveScrollPosition(); disableAllQueueButtons();">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-warning btn-sm queue-move-btn" style="flex: 1; width: 100%; height: 100%;" title="Move to position 1">Move to First</button>
                                            </form>
                                        {% endif %}
                                    </div>

                                    <!-- Middle column: Up/Down buttons stacked vertically -->
                                    <div style="display: flex; flex-direction: column; justify-content: space-between; gap: 0.25rem; flex: 0 0 36px;">
                                        <!-- Up button -->
                                        <form method="post" action="{% url 'move_queue_up' entry.id %}" style="display: flex; flex: 1;" onsubmit="saveScrollPosition(); disableAllQueueButtons();">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-primary btn-sm queue-move-btn" style="flex: 1;" title="Move up"
                                                {% if entry.queue_position == 1 %}disabled{% endif %}>▲</button>
                                        </form>

                                        <!-- Down button -->
                                        <form method="post" action="{% url 'move_queue_down' entry.id %}" style="display: flex; flex: 1;" onsubmit="saveScrollPosition(); disableAllQueueButtons();">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-primary btn-sm queue-move-btn" style="flex: 1;" title="Move down"
                                                {% if forloop.last %}disabled{% endif %}>▼</button>
                                        </form>
                                    </div>

                                    <!-- Right column: Edit and Delete buttons (stretch to match Start/Move height) -->
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem; flex: 1 1 auto; min-height: 60px;">
                                        <!-- Edit button -->
                                        <a href="{% url 'admin_edit_entry' entry.id %}"
                                        class="btn btn-secondary btn-sm"
                                        style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                        Edit
                                        </a>

                                        <!-- Cancel button -->
                                        <button type="button" class="btn btn-danger btn-sm cancel-entry-btn"
                                            data-entry-id="{{ entry.id }}"
                                            data-entry-title="{{ entry.title }}"
                                            style="flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                                            Cancel
                                        </button>
                                    </div>


                                {% elif entry.status == 'running' %}
                                    <!-- Running entry controls -->
                                    <!-- Left column: Check Out and Undo Check-In buttons -->
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem; flex: 1 1 auto; min-height: 60px;">
                                        <!-- Check Out button -->
                                        <button type="button" class="btn btn-success btn-sm checkout-entry-btn"
                                            data-entry-id="{{ entry.id }}"
                                            data-entry-title="{{ entry.title }}"
                                            style="flex: 1; width: 100%;"
                                            title="Check out and finish measurement">Check Out</button>

                                        <!-- Undo Check-In button -->
                                        <form method="post" action="{% url 'admin_undo_check_in' entry.id %}" style="display: flex; flex: 1;" onsubmit="saveScrollPosition(); disableUndoButton(this);">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-warning btn-sm undo-checkin-btn" style="flex: 1; width: 100%;" title="Undo check-in and move back to position #1">Undo Check-In</button>
                                        </form>
                                    </div>

                                    <!-- Middle column: spacer to match up/down buttons -->
                                    <div style="display: flex; flex-direction: column; justify-content: space-between; gap: 0.25rem; flex: 0 0 36px;">
                                    </div>

                                    <!-- Right column: Edit and Cancel buttons (matches queued layout) -->
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem; flex: 1 1 auto; min-height: 60px;">
                                        <!-- Edit button -->
                                        <a href="{% url 'admin_edit_entry' entry.id %}"
                                        class="btn btn-secondary btn-sm"
                                        style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                        Edit
                                        </a>

                                        <!-- Cancel button -->
                                        <button type="button" class="btn btn-danger btn-sm cancel-entry-btn"
                                            data-entry-id="{{ entry.id }}"
                                            data-entry-title="{{ entry.title }}"
                                            style="flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                                            Cancel
                                        </button>
                                    </div>
                                {% else %}
                                    <span style="color: #7f8c8d;">—</span>
                                {% endif %}

                            </td>


                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
                {% else %}
                <p style="color: #7f8c8d; margin-top: 1rem; text-align: center; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
                    No entries in queue
                </p>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p style="color: #7f8c8d; margin-top: 1rem;">No entries found.</p>
    {% endif %}
</div>


<div style="margin-top: 1rem;">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-secondary">← Back to Dashboard</a>
</div>

<script>
// Current user ID for filtering self-triggered updates
const currentUserId = {{ request.user.id|default:'null' }};

// Toggle collapsible sections
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + '-icon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼';
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.style.display = 'none';
        icon.textContent = '►';
        icon.style.transform = 'rotate(0deg)';
    }
}

// Save scroll position before form submission
function saveScrollPosition() {
    sessionStorage.setItem('adminQueueScrollPosition', window.scrollY);
}

// Disable check-in button to prevent double-clicking
function disableCheckInButton(form) {
    const button = form.querySelector('.check-in-btn');
    if (button) {
        button.disabled = true;
        button.style.opacity = '0.6';
        button.style.cursor = 'not-allowed';
        button.textContent = 'Processing...';
    }
}

// Disable undo check-in button to prevent double-clicking
function disableUndoButton(form) {
    const button = form.querySelector('.undo-checkin-btn');
    if (button) {
        button.disabled = true;
        button.style.opacity = '0.6';
        button.style.cursor = 'not-allowed';
        button.textContent = 'Processing...';
    }
}

// Disable all queue movement buttons to prevent double-clicking
function disableAllQueueButtons() {
    const queueButtons = document.querySelectorAll('.queue-move-btn');
    queueButtons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
        // Change button text to show it's processing
        if (btn.textContent.includes('Move to First')) {
            btn.textContent = 'Moving...';
        } else if (btn.textContent === '▲') {
            btn.textContent = '⏳';
        } else if (btn.textContent === '▼') {
            btn.textContent = '⏳';
        }
    });
}

// Restore scroll position after page load
window.addEventListener('load', function() {
    const savedPosition = sessionStorage.getItem('adminQueueScrollPosition');
    if (savedPosition) {
        window.scrollTo(0, parseInt(savedPosition));
        // Clear the saved position after restoring
        sessionStorage.removeItem('adminQueueScrollPosition');
    }
});

// Thanos modal for cancel confirmation
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('thanosModal');
    const message = document.getElementById('thanosMessage');
    const btnYes = document.getElementById('thanosYes');
    const btnNo = document.getElementById('thanosNo');
    const btnClose = document.getElementById('thanosClose');
    let currentEntryId = null;
    let currentEntryTitle = null;

    // Open modal when cancel button clicked
    document.querySelectorAll('.cancel-entry-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentEntryId = this.getAttribute('data-entry-id');
            currentEntryTitle = this.getAttribute('data-entry-title');
            message.textContent = `Are you sure you want to cancel entry "${currentEntryTitle}"? It will be archived.`;
            modal.style.display = 'flex';
        });
    });

    // Yes button: submit cancel form
    btnYes.addEventListener('click', function() {
        if (currentEntryId) {
            saveScrollPosition();
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/schedule/admin-queue/cancel/${currentEntryId}/`;

            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
    });

    // No button: close modal
    btnNo.addEventListener('click', function() {
        modal.style.display = 'none';
        currentEntryId = null;
        currentEntryTitle = null;
    });

    // Close button: close modal
    btnClose.addEventListener('click', function() {
        modal.style.display = 'none';
        currentEntryId = null;
        currentEntryTitle = null;
    });

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if(e.target === modal) {
            modal.style.display = 'none';
            currentEntryId = null;
            currentEntryTitle = null;
        }
    });
});

// Checkout confirmation modal
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('checkoutModal');
    const message = document.getElementById('checkoutMessage');
    const btnYes = document.getElementById('checkoutYes');
    const btnNo = document.getElementById('checkoutNo');
    const btnClose = document.getElementById('checkoutClose');
    let currentEntryId = null;
    let currentEntryTitle = null;

    // Open modal when checkout button clicked
    document.querySelectorAll('.checkout-entry-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentEntryId = this.getAttribute('data-entry-id');
            currentEntryTitle = this.getAttribute('data-entry-title');
            message.textContent = `Are you sure you want to check out "${currentEntryTitle}"? This will finish the measurement and archive it.`;
            modal.style.display = 'flex';
        });
    });

    // Yes button: submit checkout form
    btnYes.addEventListener('click', function() {
        if (currentEntryId) {
            saveScrollPosition();
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/schedule/admin-queue/check-out/${currentEntryId}/`;

            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
    });

    // No button: close modal
    btnNo.addEventListener('click', function() {
        modal.style.display = 'none';
        currentEntryId = null;
        currentEntryTitle = null;
    });

    // Close button: close modal
    btnClose.addEventListener('click', function() {
        modal.style.display = 'none';
        currentEntryId = null;
        currentEntryTitle = null;
    });

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if(e.target === modal) {
            modal.style.display = 'none';
            currentEntryId = null;
            currentEntryTitle = null;
        }
    });
});

// ========================================
// WebSocket Real-Time Updates
// ========================================

let socket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelays = [1000, 2000, 4000, 8000, 16000];

function connectWebSocket() {
    try {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/queue-updates/`;
        socket = new WebSocket(wsUrl);

        socket.onopen = function(e) {
            console.log('Admin queue WebSocket connected');
            reconnectAttempts = 0;
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Received queue update:', data);

            if (data.message_type === 'queue_update') {
                // Save scroll position and update info before reload
                sessionStorage.setItem('adminQueueScrollPosition', window.scrollY);
                sessionStorage.setItem('queueUpdateInfo', JSON.stringify(data));
                location.reload();
            }
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        socket.onclose = function(e) {
            console.log('WebSocket closed');
            attemptReconnect();
        };

    } catch (error) {
        console.error('Failed to create WebSocket:', error);
        attemptReconnect();
    }
}

function attemptReconnect() {
    if (reconnectAttempts < maxReconnectAttempts) {
        const delay = reconnectDelays[reconnectAttempts];
        console.log(`Reconnecting in ${delay}ms... (attempt ${reconnectAttempts + 1}/${maxReconnectAttempts})`);
        setTimeout(connectWebSocket, delay);
        reconnectAttempts++;
    } else {
        console.log('Max reconnection attempts reached');
    }
}

// Connect on page load
connectWebSocket();

// Show update notification banner if page was just refreshed
function showUpdateBanner() {
    const updateInfo = sessionStorage.getItem('queueUpdateInfo');
    if (updateInfo) {
        sessionStorage.removeItem('queueUpdateInfo');
        const data = JSON.parse(updateInfo);

        // Don't show banner if current user triggered the update
        if (data.triggering_user_id && data.triggering_user_id === currentUserId) {
            return;
        }

        // Create friendly message based on update type
        let message = 'Queue updated';
        switch(data.update_type) {
            case 'started':
                message = 'A measurement was started';
                break;
            case 'completed':
                message = 'A measurement was completed';
                break;
            case 'undo_checkin':
                message = 'A check-in was undone';
                break;
            case 'position_changed':
                message = 'Queue positions changed';
                break;
            case 'moved_to_first':
                message = 'An entry was moved to first position';
                break;
            case 'cancelled':
                message = 'An entry was cancelled';
                break;
            default:
                message = 'Queue updated';
        }

        // Add machine name if available
        if (data.machine_name) {
            message += ` on ${data.machine_name}`;
        }

        const banner = document.createElement('div');
        banner.className = 'message info';
        banner.style.cssText = 'position: fixed; top: 80px; right: 20px; max-width: 400px; z-index: 9999;';
        banner.innerHTML = `
            <span style="flex: 1;">Updated: ${message}</span>
            <button class="message-close" onclick="this.parentElement.remove()" aria-label="Dismiss">×</button>
        `;
        document.body.appendChild(banner);

        // Auto-remove banner after 10 seconds
        setTimeout(() => {
            if (banner.parentNode) {
                banner.remove();
            }
        }, 10000);
    }
}

// Check for update banner on page load
window.addEventListener('load', showUpdateBanner);
</script>

<!-- Thanos Delete Confirmation Modal -->
<div id="thanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:400px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p id="thanosMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-wrap: break-word;"></p>
        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="thanosYes" class="btn btn-danger">Yes, snap it immediately</button>
            <button id="thanosNo" class="btn btn-secondary">No, spare its variables</button>
        </div>
        <span id="thanosClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<!-- Checkout Confirmation Modal -->
<div id="checkoutModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:400px; width:90%; text-align:center; position:relative;">
        <h3 style="margin-top:0; color:#27ae60;">Check Out Measurement</h3>
        <p id="checkoutMessage" style="font-weight:bold; margin-bottom:1.5rem; font-size:1rem;"></p>
        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="checkoutYes" class="btn btn-success">Yes, Check Out</button>
            <button id="checkoutNo" class="btn btn-secondary">No, Continue Running</button>
        </div>
        <span id="checkoutClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

{% endblock %}
