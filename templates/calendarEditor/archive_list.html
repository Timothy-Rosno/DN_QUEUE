{% extends 'base.html' %}
{% load duration_filters %}

{% block title %}Measurement Archive{% endblock %}

{% block content %}
<style>
.table-container {
    overflow-x: auto;
    margin: 1rem 0;
}
.styled-table {
    border-collapse: collapse;
    border: 1px solid #ddd;
    width: 100%;
    max-width: 100%;
}
.styled-table th,
.styled-table td {
    border: 1px solid #ddd;
    padding: 0.75rem;
}
.styled-table thead th {
    background-color: #f8f9fa;
    font-weight: bold;
}
.styled-table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}
.styled-table tbody tr:hover {
    background-color: #e9ecef;
}
</style>

<h2>Measurement Archive</h2>

<!-- <div style="background: #e8f5e9; border-left: 4px solid #2ecc71; padding: 1rem; margin: 1rem 0; border-radius: 5px;">
    <p style="margin: 0; color: #27ae60;">
        <strong>Tip:</strong> You can export your own measurements using the "Export My Measurements" button below.
        {% if not user.is_staff %}
        Contact administrators to request the full archive backup.
        {% endif %}
    </p>
</div> -->

<!-- Hidden CSRF token for JavaScript -->
{% csrf_token %}

<!-- Filters -->
<div class="filter-section">
    <h3>Filter Archives</h3>
    <form method="get" action="{% url 'archive_list' %}" id="filterForm" style="margin-bottom: 2rem;">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <!-- Year Filter -->
            <div style="min-width: 120px;">
                <label for="year">Year:</label>
                <select name="year" id="year" class="form-control" onchange="applyFilters()">
                    <option value="">All Years</option>
                    {% for yr in available_years %}
                        <option value="{{ yr }}" {% if selected_year == yr|stringformat:"s" %}selected{% endif %}>{{ yr }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Month Filter -->
            <div style="min-width: 120px;">
                <label for="month">Month:</label>
                <select name="month" id="month" class="form-control" onchange="applyFilters()">
                    <option value="">All Months</option>
                    <option value="1" {% if selected_month == "1" %}selected{% endif %}>January</option>
                    <option value="2" {% if selected_month == "2" %}selected{% endif %}>February</option>
                    <option value="3" {% if selected_month == "3" %}selected{% endif %}>March</option>
                    <option value="4" {% if selected_month == "4" %}selected{% endif %}>April</option>
                    <option value="5" {% if selected_month == "5" %}selected{% endif %}>May</option>
                    <option value="6" {% if selected_month == "6" %}selected{% endif %}>June</option>
                    <option value="7" {% if selected_month == "7" %}selected{% endif %}>July</option>
                    <option value="8" {% if selected_month == "8" %}selected{% endif %}>August</option>
                    <option value="9" {% if selected_month == "9" %}selected{% endif %}>September</option>
                    <option value="10" {% if selected_month == "10" %}selected{% endif %}>October</option>
                    <option value="11" {% if selected_month == "11" %}selected{% endif %}>November</option>
                    <option value="12" {% if selected_month == "12" %}selected{% endif %}>December</option>
                </select>
            </div>

            <!-- Day Filter -->
            <!-- <div style="min-width: 100px;">
                <label for="day">Day:</label>
                <select name="day" id="day" class="form-control" onchange="applyFilters()">
                    <option value="">All Days</option>
                    {% for d in available_days %}
                        <option value="{{ d }}" {% if selected_day == d|stringformat:"s" %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div> -->

            <!-- Machine Filter -->
            <div style="min-width: 150px;">
                <label for="machine">Machine:</label>
                <select name="machine" id="machine" class="form-control" onchange="applyFilters()">
                    <option value="">All Machines</option>
                    {% for machine in machines %}
                        <option value="{{ machine.id }}" {% if selected_machine == machine.id|stringformat:"s" %}selected{% endif %}>{{ machine.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- User Filter (Admin Only) -->
            {% if users %}
            <div style="min-width: 150px;">
                <label for="user">User:</label>
                <select name="user" id="user" class="form-control" onchange="applyFilters()">
                    <option value="">All Users</option>
                    {% for usr in users %}
                        <option value="{{ usr.id }}" {% if selected_user == usr.id|stringformat:"s" %}selected{% endif %}>{{ usr.username }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Reset Filters Button -->
            <div style="display: flex; align-items: end;">
                <button type="button" onclick="resetFilters()" class="btn btn-secondary">Reset Filters</button>
            </div>

            <!-- Export Buttons -->
            <div style="display: flex; gap: 0.5rem; align-items: end;">
                <a href="{% url 'export_my_measurements' %}" class="btn btn-primary">Export My Measurements</a>
                <a href="{% url 'admin_export_archive' %}?format=csv" class="btn btn-primary">Export All Measurements</a>
            </div>

            <!-- New Archive Entry Button (Staff Only) -->
            {% if user.is_staff and archives %}
            <div style="display: flex; align-items: end;">
                <a href="{% url 'archive_create' %}" class="btn btn-success">New Archive Entry</a>
            </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- Pagination Info and Controls -->
{% if archives %}
<div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div style="display: flex; gap: 1rem; align-items: center;">
        <span style="color: #7f8c8d; font-size: 0.9rem;">
            Showing {{ archives.start_index }}-{{ archives.end_index }} of {{ paginator.count }} entries
        </span>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <label for="perPageSelect" style="color: #7f8c8d; font-size: 0.9rem; margin: 0;">Show:</label>
            <select id="perPageSelect" onchange="changePerPage(this.value)" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
            <span style="color: #7f8c8d; font-size: 0.9rem;">per page</span>
        </div>
    </div>
</div>
{% endif %}

<!-- Archive Table -->
<div class="table-container">
    {% if user.is_staff and archives %}
    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
        <button type="button" onclick="toggleSelectAll()" class="btn btn-secondary">Select All</button>
        <button type="button" id="deleteSelectedBtn" onclick="bulkDelete()" class="btn btn-danger" disabled style="opacity: 0.5; cursor: not-allowed;">Delete Selected</button>
        <span id="selectedCount" style="color: #7f8c8d; font-size: 0.9rem;"></span>
    </div>
    {% endif %}

    {% if archives %}
    <table class="styled-table">
        <thead>
            <tr>
                {% if user.is_staff %}
                <th style="width: 40px; text-align: center;">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                </th>
                {% endif %}
                <th style="width: 110px; text-align: center;">Date</th>
                <th style="width: 90px; text-align: center;">User</th>
                <th style="width: 90px; text-align: center;">Machine</th>
                <th style="width: 80px; text-align: center;">Duration</th>
                <th style="min-width: 150px; text-align: center;">Title</th>
                <th style="width: 110px; text-align: center;">Status</th>
                <th style="min-width: 150px; text-align: center;">Notes</th>
                {% if user.is_staff %}
                    <th style="width: 160px; text-align: center;">Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for archive in archives %}
            <tr>
                {% if user.is_staff %}
                <td style="text-align: center;">
                    <input type="checkbox" class="archive-checkbox" value="{{ archive.id }}" onchange="updateSelectedCount()">
                </td>
                {% endif %}
                <td style="white-space: nowrap; font-size: 0.9rem; text-align: center;">
                    <div>{{ archive.measurement_date|date:"Y-m-d" }}</div>
                    <div style="color: #7f8c8d; font-size: 0.85rem;">{{ archive.measurement_date|date:"H:i" }}</div>
                </td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center;" title="{{ archive.user.username }}">
                    {{ archive.user.username }}
                </td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center;" title="{% if archive.machine %}{{ archive.machine.name }}{% else %}{{ archive.machine_name|default:'Unknown' }}{% endif %}">
                    {% if archive.machine %}
                        {{ archive.machine.name }}
                    {% else %}
                        {{ archive.machine_name|default:"Unknown" }}
                    {% endif %}
                </td>
                <td style="white-space: nowrap; font-size: 0.9rem; text-align: center;">
                    {% if archive.duration_hours is not None and archive.status != 'cancelled' %}
                        {{ archive.duration_hours|format_duration }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td style="max-width: 200px; text-align: center;">
                    <span data-tooltip="{{ archive.title }}" style="display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ archive.title|truncatechars:40 }}</span>
                </td>
                <td style="white-space: nowrap; font-size: 0.9rem; text-align: center;">
                    {% if archive.status == 'completed' %}
                        {% if not archive.machine %}
                            <span data-tooltip="Machine was deleted" style="color: #27ae60; font-weight: bold;">Completed</span>
                        {% else %}
                            <span style="color: #27ae60; font-weight: bold;">Completed</span>
                        {% endif %}
                    {% elif archive.status == 'cancelled' %}
                        {% if not archive.machine %}
                            <span data-tooltip="Machine was deleted" style="color: #e74c3c; font-weight: bold;">Cancelled</span>
                        {% else %}
                            <span style="color: #e74c3c; font-weight: bold;">Cancelled</span>
                        {% endif %}
                    {% elif archive.status == 'orphaned' %}
                        <span data-tooltip="Machine was deleted" style="color: #f39c12; font-weight: bold;">Orphaned</span>
                    {% else %}
                        {{ archive.get_status_display }}
                    {% endif %}
                </td>
                <td style="max-width: 200px; font-size: 0.9rem; text-align: center;">
                    {% if archive.notes %}
                    <span data-tooltip="{{ archive.notes }}" style="display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ archive.notes|truncatechars:40 }}</span>
                    {% else %}
                    —
                    {% endif %}
                </td>
                {% if user.is_staff %}
                    <td style="white-space: nowrap; text-align: center;">
                        <div style="display: inline-flex; gap: 0.5rem;">
                            {% if archive.uploaded_file %}
                                <a href="{% url 'download_archive_file' archive.id %}" class="btn btn-sm btn-primary">Download</a>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-danger delete-archive-btn"
                                    data-archive-id="{{ archive.id }}"
                                    data-archive-title="{{ archive.title }}">Delete</button>
                        </div>
                    </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; padding: 2rem; background: white; border-radius: 8px;">
        No archived measurements found for the selected filters.
    </p>
    {% endif %}
</div>

<!-- Pagination Controls -->
{% if archives and paginator.num_pages > 1 %}
<div style="margin-top: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
    <!-- Previous Button -->
    {% if page_obj.has_previous %}
        <a href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% if selected_day %}day={{ selected_day }}&{% endif %}{% if selected_machine %}machine={{ selected_machine }}&{% endif %}{% if selected_user %}user={{ selected_user }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.previous_page_number }}"
           class="btn btn-secondary" style="padding: 0.5rem 1rem;">← Previous</a>
    {% else %}
        <button class="btn btn-secondary" disabled style="padding: 0.5rem 1rem; opacity: 0.5; cursor: not-allowed;">← Previous</button>
    {% endif %}

    <!-- Page Numbers -->
    <div style="display: flex; gap: 0.25rem;">
        {% if page_obj.number > 3 %}
            <a href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% if selected_day %}day={{ selected_day }}&{% endif %}{% if selected_machine %}machine={{ selected_machine }}&{% endif %}{% if selected_user %}user={{ selected_user }}&{% endif %}per_page={{ per_page }}&page=1"
               style="padding: 0.5rem 0.75rem; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #2c3e50; background: white;">1</a>
            {% if page_obj.number > 4 %}
                <span style="padding: 0.5rem 0.75rem;">...</span>
            {% endif %}
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                {% if num == page_obj.number %}
                    <span style="padding: 0.5rem 0.75rem; border: 1px solid #3498db; border-radius: 4px; background: #3498db; color: white; font-weight: bold;">{{ num }}</span>
                {% else %}
                    <a href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% if selected_day %}day={{ selected_day }}&{% endif %}{% if selected_machine %}machine={{ selected_machine }}&{% endif %}{% if selected_user %}user={{ selected_user }}&{% endif %}per_page={{ per_page }}&page={{ num }}"
                       style="padding: 0.5rem 0.75rem; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #2c3e50; background: white;">{{ num }}</a>
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if page_obj.number < paginator.num_pages|add:'-2' %}
            {% if page_obj.number < paginator.num_pages|add:'-3' %}
                <span style="padding: 0.5rem 0.75rem;">...</span>
            {% endif %}
            <a href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% if selected_day %}day={{ selected_day }}&{% endif %}{% if selected_machine %}machine={{ selected_machine }}&{% endif %}{% if selected_user %}user={{ selected_user }}&{% endif %}per_page={{ per_page }}&page={{ paginator.num_pages }}"
               style="padding: 0.5rem 0.75rem; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #2c3e50; background: white;">{{ paginator.num_pages }}</a>
        {% endif %}
    </div>

    <!-- Next Button -->
    {% if page_obj.has_next %}
        <a href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% if selected_day %}day={{ selected_day }}&{% endif %}{% if selected_machine %}machine={{ selected_machine }}&{% endif %}{% if selected_user %}user={{ selected_user }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.next_page_number }}"
           class="btn btn-secondary" style="padding: 0.5rem 1rem;">Next →</a>
    {% else %}
        <button class="btn btn-secondary" disabled style="padding: 0.5rem 1rem; opacity: 0.5; cursor: not-allowed;">Next →</button>
    {% endif %}
</div>
{% endif %}

<script>
function applyFilters() {
    // Add per_page to the form if not already present
    const form = document.getElementById('filterForm');
    const perPageSelect = document.getElementById('perPageSelect');

    if (perPageSelect && !form.querySelector('input[name="per_page"]')) {
        const perPageInput = document.createElement('input');
        perPageInput.type = 'hidden';
        perPageInput.name = 'per_page';
        perPageInput.value = perPageSelect.value;
        form.appendChild(perPageInput);
    }

    form.submit();
}

function resetFilters() {
    window.location.href = '{% url "archive_list" %}';
}

function changePerPage(perPageValue) {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);

    // Update per_page parameter
    urlParams.set('per_page', perPageValue);

    // Reset to page 1 when changing per_page
    urlParams.set('page', '1');

    // Redirect with new parameters
    window.location.href = '{% url "archive_list" %}?' + urlParams.toString();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.archive-checkbox');

    // Determine if we should check or uncheck: if any checkbox is unchecked, check all; otherwise uncheck all
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const shouldCheck = !allChecked;

    // Update all checkboxes
    checkboxes.forEach(checkbox => {
        checkbox.checked = shouldCheck;
    });

    // Update master checkbox to match
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = shouldCheck;
    }

    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.archive-checkbox:checked');
    const countElement = document.getElementById('selectedCount');
    const deleteBtn = document.getElementById('deleteSelectedBtn');

    if (countElement) {
        countElement.textContent = checkboxes.length > 0 ? `${checkboxes.length} selected` : '';
    }

    // Enable/disable delete button based on selection
    if (deleteBtn) {
        if (checkboxes.length > 0) {
            deleteBtn.disabled = false;
            deleteBtn.style.opacity = '1';
            deleteBtn.style.cursor = 'pointer';
        } else {
            deleteBtn.disabled = true;
            deleteBtn.style.opacity = '0.5';
            deleteBtn.style.cursor = 'not-allowed';
        }
    }
}

function bulkDelete() {
    const checkboxes = document.querySelectorAll('.archive-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one archive entry to delete.');
        return;
    }

    // Open Thanos modal
    const modal = document.getElementById('thanosModal');
    const message = document.getElementById('thanosMessage');
    const btnYesText = document.getElementById('thanosYesText');
    const count = checkboxes.length;

    // Set delete mode to bulk
    window.thanosDeleteState = {
        mode: 'bulk',
        archiveId: null,
        count: count
    };

    message.textContent = `Are you sure you want to delete ${count} archive ${count === 1 ? 'entry' : 'entries'}?`;
    btnYesText.textContent = count === 1 ? 'Yes, snap it away' : 'Yes, snap them away';
    modal.style.display = 'flex';
}

function submitBulkDelete() {
    const checkboxes = document.querySelectorAll('.archive-checkbox:checked');
    const archiveIds = Array.from(checkboxes).map(cb => cb.value);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');

    // Prepare form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', csrfToken.value);
    archiveIds.forEach(id => {
        formData.append('archive_ids', id);
    });

    // Send AJAX request
    fetch('{% url "bulk_delete_archives" %}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success banner
            showBanner(data.message, 'success');
            // Reload page after short delay to show updated list
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showBanner(data.error || 'An error occurred', 'error');
        }
    })
    .catch(error => {
        showBanner('Network error: ' + error.message, 'error');
    });
}

function showBanner(message, type) {
    // Remove existing banner if any
    const existingBanner = document.getElementById('messageBanner');
    if (existingBanner) {
        existingBanner.remove();
    }

    // Create new banner
    const banner = document.createElement('div');
    banner.id = 'messageBanner';
    banner.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 1rem 2rem;
        border-radius: 5px;
        font-weight: bold;
        z-index: 9999;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        animation: slideDown 0.3s ease-out;
        ${type === 'success' ? 'background: #2ecc71; color: white;' : 'background: #e74c3c; color: white;'}
    `;
    banner.textContent = message;

    // Add animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
    `;
    document.head.appendChild(style);

    document.body.appendChild(banner);

    // Auto-remove after 3 seconds
    setTimeout(() => {
        banner.style.animation = 'slideUp 0.3s ease-out';
        banner.style.top = '-100px';
        setTimeout(() => banner.remove(), 300);
    }, 3000);
}
</script>

<!-- Thanos Delete Confirmation Modal -->
{% load static %}
<div id="thanosModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:400px; width:90%; text-align:center; position:relative;">
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto;">
        <p id="thanosMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-wrap: break-word;"></p>
        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="thanosYes" class="btn btn-danger"><span id="thanosYesText">Yes, snap them away</span></button>
            <button id="thanosNo" class="btn btn-secondary">No, spare the archives</button>
        </div>
        <span id="thanosClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<script>
// Global state for Thanos modal
window.thanosDeleteState = {
    mode: null,  // 'bulk' or 'single'
    archiveId: null,
    count: 0
};

// Thanos modal handlers
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('thanosModal');
    const message = document.getElementById('thanosMessage');
    const btnYes = document.getElementById('thanosYes');
    const btnYesText = document.getElementById('thanosYesText');
    const btnNo = document.getElementById('thanosNo');
    const btnClose = document.getElementById('thanosClose');

    // Close modal
    function closeModal() {
        modal.style.display = 'none';
        window.thanosDeleteState = { mode: null, archiveId: null, count: 0 };
    }

    btnNo.addEventListener('click', closeModal);
    btnClose.addEventListener('click', closeModal);

    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Individual delete button handlers
    document.querySelectorAll('.delete-archive-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const archiveId = this.getAttribute('data-archive-id');
            const archiveTitle = this.getAttribute('data-archive-title');

            if (!archiveId) {
                console.error('Archive ID is missing');
                alert('Error: Archive ID is missing');
                return;
            }

            window.thanosDeleteState = {
                mode: 'single',
                archiveId: archiveId,
                count: 1
            };
            message.textContent = `Are you sure you want to delete "${archiveTitle}"?`;
            btnYesText.textContent = 'Yes, snap it away';
            modal.style.display = 'flex';
        });
    });

    // Yes button: Submit appropriate delete
    btnYes.addEventListener('click', function() {
        const state = window.thanosDeleteState;

        // Disable all interactive elements before submission
        if (window.disableAllInteractiveElements) {
            window.disableAllInteractiveElements();
        }

        if (state.mode === 'bulk') {
            closeModal();
            submitBulkDelete();
        } else if (state.mode === 'single' && state.archiveId) {
            const archiveId = state.archiveId;
            closeModal();
            submitSingleDelete(archiveId);
        } else {
            console.error('Invalid delete state:', state);
            alert('Error: Cannot determine what to delete');
            closeModal();
        }
    });
});

function submitSingleDelete(archiveId) {
    if (!archiveId) {
        console.error('Archive ID is null or undefined');
        alert('Error: Archive ID is missing');
        return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('Error: CSRF token not found');
        return;
    }

    // Create and submit form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/schedule/archive/delete/${archiveId}/`;

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken.value;
    form.appendChild(csrfInput);

    document.body.appendChild(form);
    form.submit();
}
</script>

{% endblock %}
