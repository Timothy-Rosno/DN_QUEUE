{% extends 'base.html' %}
{% load duration_filters %}

{% block title %}My Queue - Lab Equipment Queue{% endblock %}

{% block content %}
<style>
    .collapsible-header {
        cursor: pointer;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: background-color 0.2s;
    }

    .collapsible-header:hover {
        background-color: #e9ecef;
    }

    .collapsible-header h2 {
        margin: 0;
        font-size: 1.3rem;
    }

    .collapsible-icon {
        font-size: 1.2rem;
        transition: transform 0.3s;
    }

    .collapsible-icon.open {
        transform: rotate(180deg);
    }

    .collapsible-content {
        display: none;
        margin-bottom: 1.5rem;
    }

    .collapsible-content.open {
        display: block;
    }

    .entry-card {
        border: 1px solid #dee2e6;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-radius: 4px;
        background-color: #fff;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .entry-card-inner {
        min-width: 450px;
    }

    .entry-card-running {
        border: 2px solid #f39c12;
        background-color: #fff9e6;
    }

    .entry-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        gap: 1rem;
    }

    .entry-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
    }

    .entry-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .info-item {
        display: flex;
        gap: 0.5rem;
    }

    .info-label {
        font-weight: 600;
        color: #495057;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-count {
        background-color: #e74c3c;
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
        font-size: 0.75rem;
    }
</style>

<div class="card">
    <div id="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
        <h1 style="margin: 0;">My Queue Entries</h1>
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <a href="{% url 'submit_queue' %}" class="btn">Submit New Request</a>
        </div>
    </div>

    <!-- Consolidated Status Section -->
    {% if ready_to_check_out_count > 0 or ready_to_check_in_count > 0 or on_deck_not_ready_count > 0 %}
    <div style="border: 2px solid #3498db; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 6px; background-color: #ebf5fb;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
            <div style="flex: 1;">
                <h3 style="margin: 0 0 1rem 0; color: #2c3e50;">Status Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    {% if ready_to_check_out_count > 0 %}
                    <div style="padding: 0.75rem; background-color: #eafaf1; border-left: 4px solid #27ae60; border-radius: 4px;">
                        <div style="font-size: 0.85rem; color: #155724; font-weight: 600;">Available to Check Out</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">{{ ready_to_check_out_count }}</div>
                    </div>
                    {% endif %}

                    {% if ready_to_check_in_count > 0 %}
                    <div style="padding: 0.75rem; background-color: #eafaf1; border-left: 4px solid #27ae60; border-radius: 4px;">
                        <div style="font-size: 0.85rem; color: #155724; font-weight: 600;">Ready to Check In</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">{{ ready_to_check_in_count }}</div>
                    </div>
                    {% endif %}

                    {% if on_deck_not_ready_count > 0 %}
                    <div style="padding: 0.75rem; background-color: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px;">
                        <div style="font-size: 0.85rem; color: #856404; font-weight: 600;">On Deck, Not Ready</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">{{ on_deck_not_ready_count }}</div>
                        <div style="font-size: 0.75rem; color: #856404; margin-top: 0.25rem;">Machine is busy</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                <a href="{% url 'check_in_check_out' %}" class="btn" style="background-color: #3498db; padding: 1rem 1.5rem; font-size: 1.1rem;">
                    Go to Check-In/Check-Out Page →
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Running Entries (Collapsible) -->
    <div class="collapsible-header" onclick="toggleSection('running-section')">
        <h2 style="color: #f39c12; display: flex; align-items: center; gap: 0.5rem;">
            Currently Running
            <span style="font-size: 0.9rem; color: #7f8c8d;">({{ running_entries.count }})</span>
        </h2>
        <span class="collapsible-icon" id="running-section-icon">▼</span>
    </div>

    <div class="collapsible-content" id="running-section">
        {% if running_entries %}
            {% for entry in running_entries %}
            <div class="entry-card entry-card-running">
                <div class="entry-card-inner">
                <div class="entry-card-header">
                    <div style="flex: 1;">
                        <h3 class="entry-title"><span data-tooltip="{{ entry.description }}">{{ entry.title }}</span></h3>
                        <div class="entry-info">
                            <div class="info-item">
                                <span class="info-label">Machine:</span>
                                <span>{{ entry.assigned_machine.name }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Started:</span>
                                <span>{{ entry.started_at|date:"M d, g:i A" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Duration:</span>
                                <span>{{ entry.estimated_duration_hours|format_duration }}</span>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background-color: #fff; border-radius: 4px; border-left: 3px solid #f39c12;">
                            <p style="margin: 0; font-size: 0.9rem; color: #856404;">
                                <strong>Go to the <a href="{% url 'check_in_check_out' %}" style="color: #e67e22;">Check In/Out page</a> when you're ready to complete your measurement.</strong>
                            </p>
                        </div>
                    </div>
                    <div>
                        <a href="{% url 'cancel_queue' entry.pk %}?next=my_queue" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Cancel</a>
                    </div>
                </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="padding: 1rem; color: #7f8c8d; text-align: center; background-color: #f8f9fa; border-radius: 4px;">
                No experiments currently running.
            </div>
        {% endif %}
    </div>

    <!-- Queued Entries (Collapsible) -->
    <div class="collapsible-header" onclick="toggleSection('queued-section')">
        <h2 style="color: #3498db; display: flex; align-items: center; gap: 0.5rem;">
            Queued Entries
            <span style="font-size: 0.9rem; color: #7f8c8d;">({{ queued_entries.count }})</span>
        </h2>
        <span class="collapsible-icon" id="queued-section-icon">▼</span>
    </div>

    <div class="collapsible-content" id="queued-section">
        {% if queued_entries %}
            {% for machine_name, entries in queued_by_machine.items %}
            <!-- Machine Group Container with Bounding Rectangle -->
            <div style="border: 2px solid #3498db; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background-color: #f8fcff;">
                <!-- Machine Group Header -->
                <div style="background-color: #e8f4f8; padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; border-radius: 4px; border-left: 4px solid #3498db;">
                    <strong style="color: #2c3e50; font-size: 1rem;">{{ machine_name }}</strong>
                    <span style="color: #7f8c8d; font-size: 0.85rem; margin-left: 0.5rem;">({{ entries|length }} {{ entries|length|pluralize:"entry,entries" }})</span>
                </div>

                <!-- Entries for this machine -->
                {% for entry in entries %}
                <div class="entry-card" style="margin-bottom: 0.5rem;">
                    <div class="entry-card-inner">
                    <div class="entry-card-header">
                        <div style="flex: 1;">
                            <h3 class="entry-title">
                                <span data-tooltip="{{ entry.description }}">{{ entry.title }}</span>
                                {% if entry.queue_position == 1 %}
                                <span style="background-color: #27ae60; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">ON DECK</span>
                                {% endif %}
                            </h3>
                            <div class="entry-info">
                                <div class="info-item">
                                    <span class="info-label">Position:</span>
                                    <span>#{{ entry.queue_position }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Duration:</span>
                                    <span>{{ entry.estimated_duration_hours|format_duration }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Min Temp:</span>
                                    <span>{{ entry.required_min_temp }} K</span>
                                </div>
                                {% if entry.estimated_start_time %}
                                <div class="info-item">
                                    <span class="info-label">Est. Start:</span>
                                    <span>{{ entry.estimated_start_time|date:"M d, g:i A" }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            {% if entry.is_rush_job %}
                                <button type="button" class="btn" disabled
                                        style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #95a5a6; color: #ecf0f1; cursor: not-allowed; opacity: 0.6;"
                                        title="Appeal already submitted - waiting for admin review">
                                    Appeal Pending
                                </button>
                            {% else %}
                                <button type="button" class="btn" onclick="openAppealModal({{ entry.pk }}, '{{ entry.title|escapejs }}')"
                                        style="padding: 0.5rem 1rem; font-size: 0.9rem; background-color: #f39c12;"
                                        title="Notifies admins of a requested change">
                                    Appeal
                                </button>
                            {% endif %}
                            <a href="{% url 'cancel_queue' entry.pk %}?next=my_queue" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Cancel</a>
                        </div>
                    </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        {% else %}
            <div style="padding: 1rem; color: #7f8c8d; text-align: center; background-color: #f8f9fa; border-radius: 4px;">
                No queued entries.
            </div>
        {% endif %}
    </div>

    <!-- Recently Completed (Collapsible) -->
    <div class="collapsible-header" onclick="toggleSection('completed-section')">
        <h2 style="color: #95a5a6; display: flex; align-items: center; gap: 0.5rem;">
            Recently Completed
            <span style="font-size: 0.9rem; color: #7f8c8d;">(Last 10)</span>
        </h2>
        <span class="collapsible-icon" id="completed-section-icon">▼</span>
    </div>

    <div class="collapsible-content" id="completed-section">
        {% if completed_entries %}
            <!-- Single scrollable container for all completed entries -->
            <div style="border: 2px solid #95a5a6; border-radius: 6px; padding: 1rem; background-color: #f5f6f7; overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <div style="min-width: 450px;">
                {% for entry in completed_entries %}
                <div style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 4px; background-color: #ecf0f1; opacity: 0.9;">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                        <div style="flex: 1;">
                            <h3 class="entry-title"><span data-tooltip="{{ entry.description }}">{{ entry.title }}</span></h3>
                            <div class="entry-info">
                                <div class="info-item">
                                    <span class="info-label">Machine:</span>
                                    <span>{{ entry.assigned_machine.name }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Completed:</span>
                                    <span>{{ entry.completed_at|date:"M d, g:i A" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>
            </div>
        {% else %}
            <div style="padding: 1rem; color: #7f8c8d; text-align: center; background-color: #f8f9fa; border-radius: 4px;">
                No completed entries yet.
            </div>
        {% endif %}
    </div>
</div>

<!-- Appeal Modal (Rush Job/Special Request) -->
<div id="appealModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 10% auto; padding: 2rem; border: 1px solid #888; border-radius: 8px; width: 80%; max-width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="margin-top: 0; color: #e74c3c;">Rush Job/Special Request Appeal</h2>
        <p style="color: #7f8c8d; margin-bottom: 0.5rem;">
            Requesting change for: <strong id="appealEntryTitle"></strong>
        </p>
        <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Please explain the situation to Hugh:</p>

        <form method="POST" action="" id="appealForm">
            {% csrf_token %}
            <textarea
                id="appealExplanationInput"
                name="appeal_explanation"
                rows="5"
                maxlength="150"
                style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #bdc3c7; border-radius: 4px; font-family: inherit; resize: vertical;"
                placeholder="Minimum 15 characters required..."
            ></textarea>
            <div id="appealExplanationError" style="color: #e74c3c; margin-top: 0.5rem; display: none; font-weight: bold;"></div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem;">
                <small style="color: #7f8c8d;"><span id="appealCharCount"></span></small>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" id="cancelAppealBtn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" id="saveAppealBtn" class="btn">Send</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>

    // Collapsible section toggle
    function toggleSection(sectionId) {
        const content = document.getElementById(sectionId);
        const icon = document.getElementById(sectionId + '-icon');

        if (content.classList.contains('open')) {
            content.classList.remove('open');
            icon.classList.remove('open');
        } else {
            content.classList.add('open');
            icon.classList.add('open');
        }
    }

    // ===============================
    // Appeal Modal Logic
    // ===============================

    let currentAppealEntryId = null;

    function openAppealModal(entryId, entryTitle) {
        currentAppealEntryId = entryId;
        const modal = document.getElementById('appealModal');
        const form = document.getElementById('appealForm');
        const titleDisplay = document.getElementById('appealEntryTitle');
        const textarea = document.getElementById('appealExplanationInput');
        const errorDiv = document.getElementById('appealExplanationError');

        // Set entry title
        titleDisplay.textContent = entryTitle;

        // Set form action
        form.action = `/schedule/appeal/${entryId}/`;

        // Clear previous input
        textarea.value = '';
        errorDiv.style.display = 'none';

        // Update counter
        updateAppealCounter();

        // Show modal
        modal.style.display = 'block';
        textarea.focus();
    }

    function closeAppealModal() {
        const modal = document.getElementById('appealModal');
        modal.style.display = 'none';
        currentAppealEntryId = null;
    }

    function updateAppealCounter() {
        const textarea = document.getElementById('appealExplanationInput');
        const charCount = document.getElementById('appealCharCount');
        const saveBtn = document.getElementById('saveAppealBtn');
        const MIN = 15;
        const MAX = 150;

        let length = textarea.value.length;

        // Enforce max length
        if (length > MAX) {
            textarea.value = textarea.value.slice(0, MAX);
            length = MAX;
        }

        const remaining = MAX - length;

        // Display counter only when near the limit
        if (remaining <= 25) {
            charCount.textContent = remaining + " characters remaining";
            if (remaining <= 10) {
                charCount.style.color = "#e74c3c"; // danger
            } else {
                charCount.style.color = "#f39c12"; // warning
            }
        } else {
            charCount.textContent = "";
            charCount.style.color = "#7f8c8d"; // normal
        }

        // Enable Save only if minimum length is met
        if (length < MIN) {
            saveBtn.disabled = true;
        } else {
            saveBtn.disabled = false;
        }
    }

    // Initialize appeal modal handlers
    document.addEventListener('DOMContentLoaded', function() {
        const textarea = document.getElementById('appealExplanationInput');
        const cancelBtn = document.getElementById('cancelAppealBtn');
        const modal = document.getElementById('appealModal');

        // Update counter on input
        textarea.addEventListener('input', updateAppealCounter);
        textarea.addEventListener('keyup', updateAppealCounter);

        // Cancel button
        cancelBtn.addEventListener('click', closeAppealModal);

        // Close modal on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeAppealModal();
            }
        });
    });

    // ===============================
    // Smart Update on Queue Updates
    // ===============================

    // OPTIMIZED: Only reload if update affects current user, otherwise just show banner
    // This reduces reloads by 80-90% since most updates are from other users
    window.addEventListener('queueUpdate', function(e) {
        const data = e.detail;

        // Only reload if current user's entries are affected
        if (data.user_id && Number(data.user_id) === Number(globalCurrentUserId)) {
            console.log('My queue: Current user affected, reloading...');
            location.reload();
        } else {
            // Other user's update - banner is shown by base.html, no reload needed
            console.log('My queue: Other user update, no reload');
        }
    });

    // Show update notification banner if page was just refreshed
    function showUpdateBanner() {
        const updateInfo = sessionStorage.getItem('queueUpdateInfo');
        if (updateInfo) {
            sessionStorage.removeItem('queueUpdateInfo');
            const data = JSON.parse(updateInfo);

            // Don't show banner if current user triggered the update
            if (data.triggering_user_id && Number(data.triggering_user_id) === Number(globalCurrentUserId)) {
                return;
            }

            // Create friendly message based on update type
            let message = 'Queue updated';
            switch(data.update_type) {
                case 'submitted':
                    message = 'New queue entry';
                    break;
                case 'started':
                    message = 'A measurement was started';
                    break;
                case 'completed':
                    message = 'A measurement was completed';
                    break;
                case 'undo_checkin':
                    message = 'A check-in was undone';
                    break;
                case 'position_changed':
                    message = 'Queue positions changed';
                    break;
                case 'moved_to_first':
                    message = 'An entry was moved to first position';
                    break;
                case 'cancelled':
                    message = 'An entry was cancelled';
                    break;
                default:
                    message = 'Queue updated';
            }

            // Add machine name if available
            if (data.machine_name) {
                message += ` on ${data.machine_name}`;
            }

            const banner = document.createElement('div');
            banner.className = 'message info';
            banner.style.cssText = 'position: fixed; top: 80px; right: 20px; max-width: 400px; z-index: 9999;';
            banner.innerHTML = `
                <span style="flex: 1;">Update: ${message}</span>
                <button type="button" class="message-close" onclick="this.parentElement.remove()" aria-label="Dismiss">×</button>
            `;
            document.body.appendChild(banner);

            // Auto-remove banner after 10 seconds
            setTimeout(() => {
                if (banner.parentNode) {
                    banner.remove();
                }
            }, 10000);
        }
    }

    // Check for update banner on page load
    window.addEventListener('load', showUpdateBanner);
</script>
{% endblock %}
