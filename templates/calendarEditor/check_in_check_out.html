{% extends 'base.html' %}
{% load duration_filters %}

{% block title %}Check-In / Check-Out{% endblock %}

{% block content %}
<style>
    /* Enable horizontal scrolling for mobile */
    .entry-card {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .entry-card-content {
        min-width: 500px;
        display: flex;
        justify-content: space-between;
        gap: 1rem;
    }
</style>

<div class="card">
    <h1>Check-In / Check-Out</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">Manage your active measurements</p>
    <div style="margin-top: 1rem;">
        <a href="{% url 'my_queue' %}" class="btn btn-secondary">My Queue</a>
    </div>
</div>

{# ================= Ready to Check Out ================= #}
{% if ready_to_check_out %}
<div class="card">
    <h2 style="color: #27ae60;">Ready to Check Out</h2>
    {% for entry in ready_to_check_out %}
    <div class="entry-card" style="border: 2px solid #27ae60; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #eafaf1;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Started:</strong> {{ entry.started_at|date:"M d, Y g:i A" }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours|format_duration }}</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                <form method="post" action="{% url 'check_out_job' entry.id %}" data-protect data-loading-text="Checking out..." data-save-scroll="true">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-lg" style="width: 150px;">Check Out</button>
                </form>
                <form method="post" action="{% url 'undo_check_in' entry.id %}" id="undo-form-{{ entry.id }}">
                    {% csrf_token %}
                    {% if entry.assigned_machine.current_status == 'maintenance' %}
                    <button type="button" class="btn btn-secondary btn-lg" style="width: 150px; cursor: not-allowed;" disabled title="Machine is under maintenance">Undo Check-In</button>
                    {% else %}
                    <button type="button" class="btn btn-warning btn-lg undo-check-in-btn" style="width: 150px;" data-entry-id="{{ entry.id }}" data-entry-title="{{ entry.title }}">Undo Check-In</button>
                    {% endif %}
                </form>
                <a href="{% url 'cancel_queue' entry.id %}?next=check_in_check_out" class="btn btn-danger" style="width: 150px; text-align: center;">Cancel Entry</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= Currently Running ================= #}
{% if currently_running %}
<div class="card">
    <h2 style="color: #9b59b6;">Currently Running</h2>
    {% for entry in currently_running %}
    <div class="entry-card" style="border: 2px solid #9b59b6; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #f4ecf7;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Started:</strong> {{ entry.started_at|date:"M d, Y g:i A" }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours|format_duration }}</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                <form method="post" action="{% url 'check_out_job' entry.id %}" data-protect data-loading-text="Checking out..." data-save-scroll="true">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-lg" style="width: 150px;">Check Out</button>
                </form>
                <form method="post" action="{% url 'undo_check_in' entry.id %}" id="undo-form-{{ entry.id }}">
                    {% csrf_token %}
                    {% if entry.assigned_machine.current_status == 'maintenance' %}
                    <button type="button" class="btn btn-secondary btn-lg" style="width: 150px; cursor: not-allowed;" disabled title="Machine is under maintenance">Undo Check-In</button>
                    {% else %}
                    <button type="button" class="btn btn-warning btn-lg undo-check-in-btn" style="width: 150px;" data-entry-id="{{ entry.id }}" data-entry-title="{{ entry.title }}">Undo Check-In</button>
                    {% endif %}
                </form>
                <a href="{% url 'cancel_queue' entry.id %}?next=check_in_check_out" class="btn btn-danger" style="width: 150px; text-align: center;">Cancel Entry</a>
                <p style="color: #7f8c8d; font-size: 0.9rem; margin: 0;">
                    Still running… check out if ready
                </p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}


{# ================= Ready to Check In ================= #}
{% if ready_to_check_in %}
<div class="card">
    <h2 style="color: #27ae60;">Ready to Check In</h2>
    {% for entry in ready_to_check_in %}
    <div class="entry-card" style="border: 2px solid #27ae60; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #eafaf1;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours|format_duration }}</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                <form method="post" action="{% url 'check_in_job' entry.id %}" data-protect data-loading-text="Checking in..." data-save-scroll="true">
                    {% csrf_token %}
                    {% if not entry.assigned_machine.is_available %}
                    <button type="button" class="btn btn-secondary btn-lg" style="width: 150px; cursor: not-allowed;" disabled title="Machine is unavailable. Please contact an administrator.">Check In Now</button>
                    {% else %}
                    <button type="submit" class="btn btn-success btn-lg" style="width: 150px;">Check In Now</button>
                    {% endif %}
                </form>
                <a href="{% url 'cancel_queue' entry.id %}?next=check_in_check_out" class="btn btn-danger" style="width: 150px; text-align: center;">Cancel Entry</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= On Deck / Waiting for Machine ================= #}
{% if waiting_entries %}
<div class="card">
    <h2 style="color: #f39c12;">On Deck / Waiting for Machine</h2>
    {% for entry in waiting_entries %}
    <div class="entry-card" style="border: 2px solid #f39c12; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #fcf3e4;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Machine Status:</strong>
                    <span style="color: {% if entry.assigned_machine.current_status == 'cooldown' %}#f39c12{% else %}#e74c3c{% endif %}; font-weight: bold;">
                        {{ entry.assigned_machine.get_current_status_display }}
                    </span>
                </p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours|format_duration }}</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                {% if entry.assigned_machine.current_status == 'cooldown' %}
                <p style="color: #f39c12; font-weight: bold; margin: 0;">Machine cooling down...</p>
                <p style="color: #7f8c8d; font-size: 0.9rem; margin: 0;">Check back soon</p>
                {% else %}
                <p style="color: #7f8c8d; font-weight: bold; margin: 0;">Waiting for machine...</p>
                {% endif %}
                <a href="{% url 'cancel_queue' entry.id %}?next=check_in_check_out" class="btn btn-danger" style="width: 150px; text-align: center; margin-top: 0.5rem;">Cancel Entry</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= No Active Entries ================= #}
{% if not ready_to_check_out and not currently_running and not ready_to_check_in and not waiting_entries %}
<div class="card">
    <p style="color: #7f8c8d; text-align: center; padding: 2rem;">
        You have no queue entries ready for check-in or active measurements available for check-out.
    </p>
    <div style="text-align: center; margin-top: 1rem;">
        <a href="{% url 'submit_queue' %}" class="btn">Submit New Request</a>
    </div>
</div>
{% endif %}

<!-- <div style="margin-top: 1rem;">
    <a href="{% url 'my_queue' %}" class="btn btn-secondary">My Queue</a>
</div> -->

<!-- Undo Check-In uses global confirmation modal from base.html -->

{% load static %}
<script>
// ========================================
// Undo Check-In Confirmation using Global Modal
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    // Use global confirmModal for undo check-in confirmations
    document.querySelectorAll('.undo-check-in-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const entryId = this.getAttribute('data-entry-id');
            const entryTitle = this.getAttribute('data-entry-title');

            window.confirmModal.show({
                title: 'Undo Check-In',
                message: `Undo check-in for "${entryTitle}"?\n\nThis will move your entry back to position #1 in the queue and set the machine back to idle.`,
                image: '{% static "images/thanos.jpg" %}',
                confirmText: 'Yes, undo check-in',
                cancelText: 'No, keep running',
                confirmClass: 'btn-danger',
                onConfirm: () => {
                    // Save scroll position
                    sessionStorage.setItem('checkInCheckOutScrollPosition', window.scrollY);

                    // Disable all interactive elements before submission
                    if (window.disableAllInteractiveElements) {
                        window.disableAllInteractiveElements();
                    }

                    // Submit the form
                    const form = document.getElementById(`undo-form-${entryId}`);
                    if (form) {
                        form.submit();
                    }
                }
            });
        });
    });
});

// ========================================
// Smart Update on Queue Updates
// ========================================

// OPTIMIZED: Only reload if update affects current user, otherwise just show banner
// This reduces reloads by 80-90% since most updates are from other users
window.addEventListener('queueUpdate', function(e) {
    const data = e.detail;

    // Only reload if current user's entries are affected
    if (data.user_id && Number(data.user_id) === Number(globalCurrentUserId)) {
        console.log('Check-in/Check-out: Current user affected, reloading...');
        location.reload();
    } else {
        // Other user's update - banner is shown by base.html, no reload needed
        console.log('Check-in/Check-out: Other user update, no reload');
    }
});

// Show update notification banner if page was just refreshed
function showUpdateBanner() {
    const updateInfo = sessionStorage.getItem('queueUpdateInfo');
    if (updateInfo) {
        sessionStorage.removeItem('queueUpdateInfo');
        const data = JSON.parse(updateInfo);

        // Don't show banner if current user triggered the update
        if (data.triggering_user_id && Number(data.triggering_user_id) === Number(globalCurrentUserId)) {
            return;
        }

        // Create friendly message based on update type
        let message = 'Queue updated';
        switch(data.update_type) {
            case 'submitted':
                message = 'New queue entry';
                break;
            case 'started':
                message = 'A measurement was started';
                break;
            case 'completed':
                message = 'A measurement was completed';
                break;
            case 'undo_checkin':
                message = 'A check-in was undone';
                break;
            case 'position_changed':
                message = 'Queue positions changed';
                break;
            case 'moved_to_first':
                message = 'An entry was moved to first position';
                break;
            case 'cancelled':
                message = 'An entry was cancelled';
                break;
            default:
                message = 'Queue updated';
        }

        // Add machine name if available
        if (data.machine_name) {
            message += ` on ${data.machine_name}`;
        }

        const banner = document.createElement('div');
        banner.className = 'message info';
        banner.style.cssText = 'position: fixed; top: 80px; right: 20px; max-width: 400px; z-index: 9999;';
        banner.innerHTML = `
            <span style="flex: 1;">Update: ${message}</span>
            <button type="button" class="message-close" onclick="this.parentElement.remove()" aria-label="Dismiss">×</button>
        `;
        document.body.appendChild(banner);

        // Auto-remove banner after 10 seconds
        setTimeout(() => {
            if (banner.parentNode) {
                banner.remove();
            }
        }, 10000);
    }
}

// Check for update banner on page load
window.addEventListener('load', showUpdateBanner);
</script>
{% endblock %}
