{% extends 'base.html' %}

{% block title %}Check-In / Check-Out{% endblock %}

{% block content %}
<style>
    /* Enable horizontal scrolling for mobile */
    .entry-card {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .entry-card-content {
        min-width: 500px;
        display: flex;
        justify-content: space-between;
        gap: 1rem;
    }
</style>

<div class="card">
    <h1>Check-In / Check-Out</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">Manage your active measurements</p>
    <div style="margin-top: 1rem;">
        <a href="{% url 'my_queue' %}" class="btn btn-secondary">← Back to My Queue</a>
    </div>
</div>

{# ================= Ready to Check Out ================= #}
{% if ready_to_check_out %}
<div class="card">
    <h2 style="color: #27ae60;">Ready to Check Out</h2>
    {% for entry in ready_to_check_out %}
    <div class="entry-card" style="border: 2px solid #27ae60; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #eafaf1;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Started:</strong> {{ entry.started_at|date:"M d, Y g:i A" }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours }} hours</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                <form method="post" action="{% url 'check_out_job' entry.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-lg" style="min-width: 140px;">Check Out</button>
                </form>
                <form method="post" action="{% url 'undo_check_in' entry.id %}" id="undo-form-{{ entry.id }}">
                    {% csrf_token %}
                    {% if entry.assigned_machine.current_status == 'maintenance' %}
                    <button type="button" class="btn btn-secondary btn-lg" style="min-width: 140px; cursor: not-allowed;" disabled title="Machine is under maintenance">Undo Check-In</button>
                    {% else %}
                    <button type="button" class="btn btn-warning btn-lg undo-check-in-btn" style="min-width: 140px;" data-entry-id="{{ entry.id }}" data-entry-title="{{ entry.title }}">Undo Check-In</button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= Currently Running ================= #}
{% if currently_running %}
<div class="card">
    <h2 style="color: #9b59b6;">Currently Running</h2>
    {% for entry in currently_running %}
    <div class="entry-card" style="border: 2px solid #9b59b6; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #f4ecf7;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Started:</strong> {{ entry.started_at|date:"M d, Y g:i A" }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours }} hours</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                <form method="post" action="{% url 'check_out_job' entry.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-lg" style="min-width: 140px;">Check Out</button>
                </form>
                <form method="post" action="{% url 'undo_check_in' entry.id %}" id="undo-form-{{ entry.id }}">
                    {% csrf_token %}
                    {% if entry.assigned_machine.current_status == 'maintenance' %}
                    <button type="button" class="btn btn-secondary btn-lg" style="min-width: 140px; cursor: not-allowed;" disabled title="Machine is under maintenance">Undo Check-In</button>
                    {% else %}
                    <button type="button" class="btn btn-warning btn-lg undo-check-in-btn" style="min-width: 140px;" data-entry-id="{{ entry.id }}" data-entry-title="{{ entry.title }}">Undo Check-In</button>
                    {% endif %}
                </form>
                <p style="color: #7f8c8d; font-size: 0.9rem; margin: 0;">
                    Still running… check out if ready
                </p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}


{# ================= Ready to Check In ================= #}
{% if ready_to_check_in %}
<div class="card">
    <h2 style="color: #27ae60;">Ready to Check In</h2>
    {% for entry in ready_to_check_in %}
    <div class="entry-card" style="border: 2px solid #27ae60; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #eafaf1;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours }} hours</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div>
                <form method="post" action="{% url 'check_in_job' entry.id %}">
                    {% csrf_token %}
                    {% if not entry.assigned_machine.is_available %}
                    <button type="button" class="btn btn-secondary btn-lg" style="cursor: not-allowed;" disabled title="Machine is unavailable. Please contact an administrator.">Check In Now</button>
                    {% else %}
                    <button type="submit" class="btn btn-success btn-lg">Check In Now</button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= On Deck / Waiting for Machine ================= #}
{% if waiting_entries %}
<div class="card">
    <h2 style="color: #f39c12;">On Deck / Waiting for Machine</h2>
    {% for entry in waiting_entries %}
    <div class="entry-card" style="border: 2px solid #f39c12; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #fcf3e4;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Machine Status:</strong>
                    <span style="color: {% if entry.assigned_machine.current_status == 'cooldown' %}#f39c12{% else %}#e74c3c{% endif %}; font-weight: bold;">
                        {{ entry.assigned_machine.get_current_status_display }}
                    </span>
                </p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours }} hours</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div>
                {% if entry.assigned_machine.current_status == 'cooldown' %}
                <p style="color: #f39c12; font-weight: bold;">Machine cooling down...</p>
                <p style="color: #7f8c8d; font-size: 0.9rem;">Check back soon</p>
                {% else %}
                <p style="color: #7f8c8d; font-weight: bold;">Waiting for machine...</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= No Active Entries ================= #}
{% if not ready_to_check_out and not currently_running and not ready_to_check_in and not waiting_entries %}
<div class="card">
    <p style="color: #7f8c8d; text-align: center; padding: 2rem;">
        You have no queue entries ready for check-in or active measurements available for check-out.
    </p>
    <div style="text-align: center; margin-top: 1rem;">
        <a href="{% url 'submit_queue' %}" class="btn">Submit New Request</a>
    </div>
</div>
{% endif %}

<div style="margin-top: 1rem;">
    <a href="{% url 'my_queue' %}" class="btn btn-secondary">← Back to My Queue</a>
</div>

<!-- Undo Check-In Confirmation Modal -->
{% load static %}
<div id="undoConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; text-align:center; position:relative;">
        {% if user.is_staff %}
        <!-- Thanos dialog for staff -->
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto; margin-bottom: 1rem;">
        <p id="undoConfirmMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-wrap: break-word;"></p>
        <p style="color: #7f8c8d; margin-bottom:1rem; font-size:0.95rem;">This will move your entry back to position #1 in the queue and set the machine back to idle.</p>
        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="undoConfirmYes" class="btn btn-danger">Yes, undo check-in</button>
            <button id="undoConfirmNo" class="btn btn-secondary">No, keep running</button>
        </div>
        {% else %}
        <!-- Normal dialog for regular users -->
        <h3 style="margin-top: 0; margin-bottom: 1rem; color: #e67e22;">Undo Check-In?</h3>
        <p id="undoConfirmMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-wrap: break-word;"></p>
        <p style="color: #7f8c8d; margin-bottom:1rem; font-size:0.95rem;">This will move your entry back to position #1 in the queue and set the machine back to idle.</p>
        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="undoConfirmYes" class="btn btn-warning">Yes, undo check-in</button>
            <button id="undoConfirmNo" class="btn btn-secondary">No, keep running</button>
        </div>
        <p style="color: #bdc3c7; font-size: 0.75rem; margin-top: 1rem; font-style: italic;">*Staff see a different dialog here*</p>
        {% endif %}
        <span id="undoConfirmClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<script>
// Save scroll position before form submission
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form[action*="check-in"], form[action*="check-out"], form[action*="undo-check-in"]');

    forms.forEach(function(form) {
        form.addEventListener('submit', function() {
            sessionStorage.setItem('checkInCheckOutScrollPosition', window.scrollY);
        });
    });

    // Restore scroll position after page load
    const savedPosition = sessionStorage.getItem('checkInCheckOutScrollPosition');
    if (savedPosition) {
        window.scrollTo(0, parseInt(savedPosition));
        sessionStorage.removeItem('checkInCheckOutScrollPosition');
    }

    // Undo check-in confirmation modal
    const undoModal = document.getElementById('undoConfirmModal');
    const undoMessage = document.getElementById('undoConfirmMessage');
    const undoYesBtn = document.getElementById('undoConfirmYes');
    const undoNoBtn = document.getElementById('undoConfirmNo');
    const undoCloseBtn = document.getElementById('undoConfirmClose');
    let currentUndoEntryId = null;
    let currentUndoEntryTitle = null;

    // Open modal when undo check-in button clicked
    document.querySelectorAll('.undo-check-in-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentUndoEntryId = this.getAttribute('data-entry-id');
            currentUndoEntryTitle = this.getAttribute('data-entry-title');
            undoMessage.textContent = `Undo check-in for "${currentUndoEntryTitle}"?`;
            undoModal.style.display = 'flex';
        });
    });

    // Yes button: submit the form
    undoYesBtn.addEventListener('click', function() {
        if (currentUndoEntryId) {
            const form = document.getElementById(`undo-form-${currentUndoEntryId}`);
            if (form) {
                form.submit();
            }
        }
    });

    // No button: close modal
    undoNoBtn.addEventListener('click', function() {
        undoModal.style.display = 'none';
        currentUndoEntryId = null;
        currentUndoEntryTitle = null;
    });

    // Close button: close modal
    undoCloseBtn.addEventListener('click', function() {
        undoModal.style.display = 'none';
        currentUndoEntryId = null;
        currentUndoEntryTitle = null;
    });

    // Click outside modal: close modal
    undoModal.addEventListener('click', function(e) {
        if (e.target === undoModal) {
            undoModal.style.display = 'none';
            currentUndoEntryId = null;
            currentUndoEntryTitle = null;
        }
    });
});
</script>
{% endblock %}
