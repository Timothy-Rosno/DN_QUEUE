{% extends 'base.html' %}

{% block title %}Check-In / Check-Out{% endblock %}

{% block content %}
<style>
    /* Enable horizontal scrolling for mobile */
    .entry-card {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .entry-card-content {
        min-width: 500px;
        display: flex;
        justify-content: space-between;
        gap: 1rem;
    }
</style>

<div class="card">
    <h1>Check-In / Check-Out</h1>
    <p style="color: #7f8c8d; margin-top: 0.5rem;">Manage your active measurements</p>
    <div style="margin-top: 1rem;">
        <a href="{% url 'my_queue' %}" class="btn btn-secondary">My Queue</a>
    </div>
</div>

{# ================= Ready to Check Out ================= #}
{% if ready_to_check_out %}
<div class="card">
    <h2 style="color: #27ae60;">Ready to Check Out</h2>
    {% for entry in ready_to_check_out %}
    <div class="entry-card" style="border: 2px solid #27ae60; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #eafaf1;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Started:</strong> {{ entry.started_at|date:"M d, Y g:i A" }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours }} hours</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                <form method="post" action="{% url 'check_out_job' entry.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-lg" style="width: 150px;">Check Out</button>
                </form>
                <form method="post" action="{% url 'undo_check_in' entry.id %}" id="undo-form-{{ entry.id }}">
                    {% csrf_token %}
                    {% if entry.assigned_machine.current_status == 'maintenance' %}
                    <button type="button" class="btn btn-secondary btn-lg" style="width: 150px; cursor: not-allowed;" disabled title="Machine is under maintenance">Undo Check-In</button>
                    {% else %}
                    <button type="button" class="btn btn-warning btn-lg undo-check-in-btn" style="width: 150px;" data-entry-id="{{ entry.id }}" data-entry-title="{{ entry.title }}">Undo Check-In</button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= Currently Running ================= #}
{% if currently_running %}
<div class="card">
    <h2 style="color: #9b59b6;">Currently Running</h2>
    {% for entry in currently_running %}
    <div class="entry-card" style="border: 2px solid #9b59b6; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #f4ecf7;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Started:</strong> {{ entry.started_at|date:"M d, Y g:i A" }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours }} hours</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                <form method="post" action="{% url 'check_out_job' entry.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-lg" style="width: 150px;">Check Out</button>
                </form>
                <form method="post" action="{% url 'undo_check_in' entry.id %}" id="undo-form-{{ entry.id }}">
                    {% csrf_token %}
                    {% if entry.assigned_machine.current_status == 'maintenance' %}
                    <button type="button" class="btn btn-secondary btn-lg" style="width: 150px; cursor: not-allowed;" disabled title="Machine is under maintenance">Undo Check-In</button>
                    {% else %}
                    <button type="button" class="btn btn-warning btn-lg undo-check-in-btn" style="width: 150px;" data-entry-id="{{ entry.id }}" data-entry-title="{{ entry.title }}">Undo Check-In</button>
                    {% endif %}
                </form>
                <p style="color: #7f8c8d; font-size: 0.9rem; margin: 0;">
                    Still running… check out if ready
                </p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}


{# ================= Ready to Check In ================= #}
{% if ready_to_check_in %}
<div class="card">
    <h2 style="color: #27ae60;">Ready to Check In</h2>
    {% for entry in ready_to_check_in %}
    <div class="entry-card" style="border: 2px solid #27ae60; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #eafaf1;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours }} hours</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div>
                <form method="post" action="{% url 'check_in_job' entry.id %}" onsubmit="disableCheckInButton(this);">
                    {% csrf_token %}
                    {% if not entry.assigned_machine.is_available %}
                    <button type="button" class="btn btn-secondary btn-lg" style="cursor: not-allowed;" disabled title="Machine is unavailable. Please contact an administrator.">Check In Now</button>
                    {% else %}
                    <button type="submit" class="btn btn-success btn-lg check-in-btn">Check In Now</button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= On Deck / Waiting for Machine ================= #}
{% if waiting_entries %}
<div class="card">
    <h2 style="color: #f39c12;">On Deck / Waiting for Machine</h2>
    {% for entry in waiting_entries %}
    <div class="entry-card" style="border: 2px solid #f39c12; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem; background-color: #fcf3e4;">
        <div class="entry-card-content">
            <div style="flex: 1; min-width: 0;">
                <h3 style="word-wrap: break-word; overflow-wrap: break-word;">{{ entry.title|truncatechars:80 }}</h3>
                <p><strong>Machine:</strong> {{ entry.assigned_machine.name }}</p>
                <p><strong>Machine Status:</strong>
                    <span style="color: {% if entry.assigned_machine.current_status == 'cooldown' %}#f39c12{% else %}#e74c3c{% endif %}; font-weight: bold;">
                        {{ entry.assigned_machine.get_current_status_display }}
                    </span>
                </p>
                <p><strong>Estimated Duration:</strong> {{ entry.estimated_duration_hours }} hours</p>
                {% if entry.description %}
                <p style="word-wrap: break-word; overflow-wrap: break-word;"><strong>Description:</strong> {{ entry.description|truncatewords:30 }}</p>
                {% endif %}
            </div>
            <div>
                {% if entry.assigned_machine.current_status == 'cooldown' %}
                <p style="color: #f39c12; font-weight: bold;">Machine cooling down...</p>
                <p style="color: #7f8c8d; font-size: 0.9rem;">Check back soon</p>
                {% else %}
                <p style="color: #7f8c8d; font-weight: bold;">Waiting for machine...</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{# ================= No Active Entries ================= #}
{% if not ready_to_check_out and not currently_running and not ready_to_check_in and not waiting_entries %}
<div class="card">
    <p style="color: #7f8c8d; text-align: center; padding: 2rem;">
        You have no queue entries ready for check-in or active measurements available for check-out.
    </p>
    <div style="text-align: center; margin-top: 1rem;">
        <a href="{% url 'submit_queue' %}" class="btn">Submit New Request</a>
    </div>
</div>
{% endif %}

<!-- <div style="margin-top: 1rem;">
    <a href="{% url 'my_queue' %}" class="btn btn-secondary">My Queue</a>
</div> -->

<!-- Undo Check-In Confirmation Modal -->
{% load static %}
<div id="undoConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:10px; max-width:500px; width:90%; text-align:center; position:relative;">
        <!-- Thanos dialog for everyone -->
        <img src="{% static 'images/thanos.jpg' %}" alt="Thanos" style="width:330px; height:auto; margin-bottom: 1rem;">
        <p id="undoConfirmMessage" style="font-weight:bold; margin-bottom:1rem; font-size:1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; word-wrap: break-word;"></p>
        <p style="color: #7f8c8d; margin-bottom:1rem; font-size:0.95rem;">This will move your entry back to position #1 in the queue and set the machine back to idle.</p>
        <div style="display:flex; justify-content:space-around; gap:1rem;">
            <button id="undoConfirmYes" class="btn btn-danger">Yes, undo check-in</button>
            <button id="undoConfirmNo" class="btn btn-secondary">No, keep running</button>
        </div>
        <span id="undoConfirmClose" style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-size:1.2rem;">&times;</span>
    </div>
</div>

<script>
// Current user ID for filtering self-triggered updates
const currentUserId = {{ request.user.id|default:'null' }};

// Save scroll position before form submission
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form[action*="check-in"], form[action*="check-out"], form[action*="undo-check-in"]');

    forms.forEach(function(form) {
        form.addEventListener('submit', function() {
            sessionStorage.setItem('checkInCheckOutScrollPosition', window.scrollY);
        });
    });

    // Restore scroll position after page load
    const savedPosition = sessionStorage.getItem('checkInCheckOutScrollPosition');
    if (savedPosition) {
        window.scrollTo(0, parseInt(savedPosition));
        sessionStorage.removeItem('checkInCheckOutScrollPosition');
    }

    // Undo check-in confirmation modal
    const undoModal = document.getElementById('undoConfirmModal');
    const undoMessage = document.getElementById('undoConfirmMessage');
    const undoYesBtn = document.getElementById('undoConfirmYes');
    const undoNoBtn = document.getElementById('undoConfirmNo');
    const undoCloseBtn = document.getElementById('undoConfirmClose');
    let currentUndoEntryId = null;
    let currentUndoEntryTitle = null;

    // Open modal when undo check-in button clicked
    document.querySelectorAll('.undo-check-in-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentUndoEntryId = this.getAttribute('data-entry-id');
            currentUndoEntryTitle = this.getAttribute('data-entry-title');
            undoMessage.textContent = `Undo check-in for "${currentUndoEntryTitle}"?`;
            undoModal.style.display = 'flex';
        });
    });

    // Disable check-in button to prevent double-clicking
    window.disableCheckInButton = function(form) {
        const button = form.querySelector('.check-in-btn');
        if (button) {
            button.disabled = true;
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';
            button.textContent = 'Processing...';
        }
    };

    // Disable all undo check-in buttons
    function disableAllUndoButtons() {
        // Disable all undo check-in buttons
        document.querySelectorAll('.undo-check-in-btn').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.textContent = 'Processing...';
        });

        // Disable modal buttons
        undoYesBtn.disabled = true;
        undoYesBtn.style.opacity = '0.5';
        undoYesBtn.style.cursor = 'not-allowed';
        undoNoBtn.disabled = true;
        undoNoBtn.style.opacity = '0.5';
        undoNoBtn.style.cursor = 'not-allowed';
    }

    // Yes button: submit the form
    undoYesBtn.addEventListener('click', function() {
        if (currentUndoEntryId) {
            // Disable all buttons immediately
            disableAllUndoButtons();

            const form = document.getElementById(`undo-form-${currentUndoEntryId}`);
            if (form) {
                undoModal.style.display = 'none';
                form.submit();
            }
        }
    });

    // No button: close modal
    undoNoBtn.addEventListener('click', function() {
        undoModal.style.display = 'none';
        currentUndoEntryId = null;
        currentUndoEntryTitle = null;
    });

    // Close button: close modal
    undoCloseBtn.addEventListener('click', function() {
        undoModal.style.display = 'none';
        currentUndoEntryId = null;
        currentUndoEntryTitle = null;
    });

    // Click outside modal: close modal
    undoModal.addEventListener('click', function(e) {
        if (e.target === undoModal) {
            undoModal.style.display = 'none';
            currentUndoEntryId = null;
            currentUndoEntryTitle = null;
        }
    });
});

// ========================================
// WebSocket Real-Time Updates
// ========================================

let socket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/queue-updates/`;

    try {
        socket = new WebSocket(wsUrl);

        socket.onopen = function(e) {
            console.log('Check-in/Check-out WebSocket connected');
            reconnectAttempts = 0;
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Received queue update:', data);

            // Save update info and reload page
            if (data.message_type === 'queue_update') {
                sessionStorage.setItem('queueUpdateInfo', JSON.stringify(data));
                location.reload();
            }
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        socket.onclose = function(e) {
            console.log('WebSocket closed');
            attemptReconnect();
        };

    } catch (error) {
        console.error('Failed to create WebSocket:', error);
        attemptReconnect();
    }
}

function attemptReconnect() {
    if (reconnectAttempts < maxReconnectAttempts) {
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 16000);
        console.log(`Reconnecting in ${delay}ms... (attempt ${reconnectAttempts + 1}/${maxReconnectAttempts})`);
        setTimeout(connectWebSocket, delay);
        reconnectAttempts++;
    } else {
        console.log('Max reconnection attempts reached');
    }
}

// Connect on page load
connectWebSocket();

// Show update notification banner if page was just refreshed
function showUpdateBanner() {
    const updateInfo = sessionStorage.getItem('queueUpdateInfo');
    if (updateInfo) {
        sessionStorage.removeItem('queueUpdateInfo');
        const data = JSON.parse(updateInfo);

        // Don't show banner if current user triggered the update
        if (data.triggering_user_id && Number(data.triggering_user_id) === Number(currentUserId)) {
            return;
        }

        // Create friendly message based on update type
        let message = 'Queue updated';
        switch(data.update_type) {
            case 'submitted':
                message = 'New queue entry';
                break;
            case 'started':
                message = 'A measurement was started';
                break;
            case 'completed':
                message = 'A measurement was completed';
                break;
            case 'undo_checkin':
                message = 'A check-in was undone';
                break;
            case 'position_changed':
                message = 'Queue positions changed';
                break;
            case 'moved_to_first':
                message = 'An entry was moved to first position';
                break;
            case 'cancelled':
                message = 'An entry was cancelled';
                break;
            default:
                message = 'Queue updated';
        }

        // Add machine name if available
        if (data.machine_name) {
            message += ` on ${data.machine_name}`;
        }

        const banner = document.createElement('div');
        banner.className = 'message info';
        banner.style.cssText = 'position: fixed; top: 80px; right: 20px; max-width: 400px; z-index: 9999;';
        banner.innerHTML = `
            <span style="flex: 1;">Update: ${message}</span>
            <button class="message-close" onclick="this.parentElement.remove()" aria-label="Dismiss">×</button>
        `;
        document.body.appendChild(banner);

        // Auto-remove banner after 10 seconds
        setTimeout(() => {
            if (banner.parentNode) {
                banner.remove();
            }
        }, 10000);
    }
}

// Check for update banner on page load
window.addEventListener('load', showUpdateBanner);
</script>
{% endblock %}
