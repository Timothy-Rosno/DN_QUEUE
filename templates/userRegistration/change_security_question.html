{% extends 'base.html' %}

{% block title %}Change Security Question - Scheduler App{% endblock %}

{% block content %}
<div class="card">
    <h1>Change Security Question</h1>

    <p style="color: #7f8c8d; margin-top: 1rem;">
        To change your security question, you must first verify your identity by answering your current security question correctly.
    </p>

    <div style="margin: 1.5rem 0; padding: 1rem; background-color: #fff3cd; border-left: 4px solid #f39c12; border-radius: 4px;">
        <p style="margin: 0;"><strong>Current Security Question:</strong></p>
        <p style="color: #856404; margin: 0.5rem 0 0 0;">
            {% if user.profile.security_question == 'custom' %}
                {{ user.profile.security_question_custom }}
            {% else %}
                {{ user.profile.get_security_question_display }}
            {% endif %}
        </p>
    </div>

    <form method="post" style="margin-top: 2rem;">
        {% csrf_token %}

        <!-- Current Password -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #e8f4fd; border-radius: 4px;">
            <h3 style="margin-top: 0; font-size: 1.1rem;">Step 1: Verify Your Identity</h3>
            <div style="margin-bottom: 1rem;">
                <label for="{{ form.current_password.id_for_label }}" style="font-weight: 600;">{{ form.current_password.label }}</label>
                {{ form.current_password }}
                {% if form.current_password.help_text %}
                    <small style="display: block; color: #7f8c8d; margin-top: 0.25rem;">{{ form.current_password.help_text }}</small>
                {% endif %}
                {% if form.current_password.errors %}
                    <div class="errorlist">
                        {% for error in form.current_password.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- New Security Question -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f0f9ff; border-radius: 4px;">
            <h3 style="margin-top: 0; font-size: 1.1rem;">Step 2: Set New Security Question</h3>

            <div style="margin-bottom: 1rem;">
                <label for="{{ form.new_security_question.id_for_label }}" style="font-weight: 600;">{{ form.new_security_question.label }}</label>
                {{ form.new_security_question }}
                {% if form.new_security_question.errors %}
                    <div class="errorlist">
                        {% for error in form.new_security_question.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div style="margin-bottom: 1rem;" id="custom_question_field">
                <label for="{{ form.new_security_question_custom.id_for_label }}" style="font-weight: 600;">{{ form.new_security_question_custom.label }}</label>
                {{ form.new_security_question_custom }}
                {% if form.new_security_question_custom.help_text %}
                    <small style="display: block; color: #7f8c8d; margin-top: 0.25rem;">{{ form.new_security_question_custom.help_text }}</small>
                {% endif %}
                {% if form.new_security_question_custom.errors %}
                    <div class="errorlist">
                        {% for error in form.new_security_question_custom.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="{{ form.new_security_answer.id_for_label }}" style="font-weight: 600;">{{ form.new_security_answer.label }}</label>
                {{ form.new_security_answer }}
                {% if form.new_security_answer.help_text %}
                    <small style="display: block; color: #7f8c8d; margin-top: 0.25rem;">{{ form.new_security_answer.help_text }}</small>
                {% endif %}
                {% if form.new_security_answer.errors %}
                    <div class="errorlist">
                        {% for error in form.new_security_answer.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div style="margin-bottom: 0;">
                <label for="{{ form.new_security_answer_confirm.id_for_label }}" style="font-weight: 600;">{{ form.new_security_answer_confirm.label }}</label>
                {{ form.new_security_answer_confirm }}
                {% if form.new_security_answer_confirm.errors %}
                    <div class="errorlist">
                        {% for error in form.new_security_answer_confirm.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
            <button type="submit" class="btn">Update Security Question</button>
            <a href="{% url 'profile' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// Show/hide custom question field based on selection
document.addEventListener('DOMContentLoaded', function() {
    const questionSelect = document.getElementById('{{ form.new_security_question.id_for_label }}');
    const customField = document.getElementById('custom_question_field');

    function toggleCustomField() {
        if (questionSelect.value === 'custom') {
            customField.style.display = 'block';
        } else {
            customField.style.display = 'none';
        }
    }

    questionSelect.addEventListener('change', toggleCustomField);
    toggleCustomField(); // Initialize on page load
});
</script>
{% endblock %}
