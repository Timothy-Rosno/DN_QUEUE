{% extends 'base.html' %}

{% block title %}Register - Scheduler App{% endblock %}

{% block content %}
<style>
    /* Submit button tooltip container */
    .submit-btn-wrapper {
        position: relative;
        display: inline-block;
    }

    /* Validation tooltip */
    .validation-tooltip {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 0;
        background-color: #2c3e50;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        font-size: 0.85rem;
        max-width: 300px;
        width: max-content;
        z-index: 1000;
        margin-bottom: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .validation-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 20px;
        border-width: 6px;
        border-style: solid;
        border-color: #2c3e50 transparent transparent transparent;
    }

    .validation-tooltip ul {
        margin: 0;
        padding: 0 0 0 1rem;
        list-style: disc;
    }

    .validation-tooltip li {
        margin: 0.25rem 0;
        word-wrap: break-word;
    }

    /* Only show tooltip when hovering AND button is disabled */
    .submit-btn-wrapper:hover .btn:disabled + .validation-tooltip {
        display: block;
    }
</style>

<div class="card">
    <h1>Create Your Account</h1>
    <p style="margin: 1rem 0;">Please fill out the form below to register. Fields are required unless otherwise stated.</p>

    <form method="post">
        {% csrf_token %}

        <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Account Information</h3>
        {{ user_form.as_p }}

        <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Profile Information</h3>

        <!-- Phone Number Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ profile_form.phone_number.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.phone_number.label }}
            </label>
            <!-- {% if profile_form.phone_number.help_text %}
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">{{ profile_form.phone_number.help_text }}</small>
            {% endif %} -->
            {{ profile_form.phone_number }}
            {% if profile_form.phone_number.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.phone_number.errors }}</div>
            {% endif %}
        </div>

        <!-- Organization Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ profile_form.organization.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.organization.label }}
            </label>
            {{ profile_form.organization }}
            {% if profile_form.organization.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.organization.errors }}</div>
            {% endif %}
        </div>

        <!-- Organization Other Field (shown when "Other" is selected) -->
        <div id="organization-other-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ profile_form.organization_other.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.organization_other.label }}
            </label>
            {{ profile_form.organization_other }}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="organizationOtherError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="organizationOtherCharCount"></span></small>
            </div>
            {% if profile_form.organization_other.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.organization_other.errors }}</div>
            {% endif %}
        </div>

        <!-- Department Field (shown when University of Arkansas is selected) -->
        <div id="department-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ profile_form.department.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.department.label }}
            </label>
            {{ profile_form.department }}
            {% if profile_form.department.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.department.errors }}</div>
            {% endif %}
        </div>

        <!-- Department Other Field (shown when "Other" department is selected) -->
        <div id="department-other-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ profile_form.department_other.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.department_other.label }}
            </label>
            {{ profile_form.department_other }}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="departmentOtherError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="departmentOtherCharCount"></span></small>
            </div>
            {% if profile_form.department_other.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.department_other.errors }}</div>
            {% endif %}
        </div>

        <!-- Notes Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ profile_form.notes.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.notes.label }}
            </label>
            {{ profile_form.notes }}
            {% if profile_form.notes.help_text %}
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">{{ profile_form.notes.help_text }}</small>
            {% endif %}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="notesError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="notesCharCount"></span></small>
            </div>
            {% if profile_form.notes.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.notes.errors }}</div>
            {% endif %}
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 0.5rem;">Password Recovery</h3>
        <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.95rem;">Create a custom security question to recover your password if you forget it.</p>

        <!-- Hidden field for security_question (always set to 'custom' for new registrations) -->
        {{ profile_form.security_question }}

        <div style="margin-bottom: 1.5rem;">
            {{ profile_form.security_question_custom.label_tag }}
            {{ profile_form.security_question_custom }}
            {% if profile_form.security_question_custom.errors %}
                <small style="color: #e74c3c; display: block; margin-top: 0.5rem;">{{ profile_form.security_question_custom.errors.0 }}</small>
            {% endif %}
        </div>

        <div style="margin-bottom: 1.5rem;">
            {{ profile_form.security_answer.label_tag }}
            {{ profile_form.security_answer }}
            <!-- {% if profile_form.security_answer.help_text %}
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">{{ profile_form.security_answer.help_text }}</small>
            {% endif %} -->
        </div>

        <script>
        // ===============================
        // Prevent Non-Numeric Input for Phone Number
        // ===============================
        (function() {
            const phoneNumberInput = document.getElementById('{{ profile_form.phone_number.id_for_label }}');

            function preventNonNumeric(e) {
                // Allow: backspace, delete, tab, escape, enter, decimal (but will be removed on paste)
                if ([46, 8, 9, 27, 13, 110].indexOf(e.keyCode) !== -1 ||
                    // Allow: Ctrl+A/C/V/X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    // Allow: home, end, left, right
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    return;
                }
                // Prevent if not a number
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            }

            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('keydown', preventNonNumeric);
                // Strip non-numeric on paste
                phoneNumberInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        this.value = this.value.replace(/[^0-9]/g, '');
                    }, 0);
                });
            }
        })();

        // Initialize character counters and conditional field displays on page load
        document.addEventListener('DOMContentLoaded', function() {
            const organizationSelect = document.getElementById('{{ profile_form.organization.id_for_label }}');
            const organizationOtherField = document.getElementById('organization-other-field');
            const departmentField = document.getElementById('department-field');
            const departmentSelect = document.getElementById('{{ profile_form.department.id_for_label }}');
            const departmentOtherField = document.getElementById('department-other-field');
            const registerButton = document.getElementById('registerButton');

            // Handle organization selection changes
            function toggleOrganizationFields() {
                const orgValue = organizationSelect.value;

                // Show/hide organization_other field
                if (orgValue === 'other') {
                    organizationOtherField.style.display = 'block';
                } else {
                    organizationOtherField.style.display = 'none';
                }

                // Show/hide department field (for schools: uark, montana, vtech)
                if (orgValue === 'uark' || orgValue === 'montana' || orgValue === 'vtech') {
                    departmentField.style.display = 'block';
                } else {
                    departmentField.style.display = 'none';
                    // Reset department selection when hiding
                    departmentSelect.value = '';
                    departmentOtherField.style.display = 'none';
                }

                // Revalidate form after changing fields
                updateRegisterButton();
            }

            // Handle department selection changes
            function toggleDepartmentOtherField() {
                const deptValue = departmentSelect.value;

                // Show/hide department_other field
                if (deptValue === 'other') {
                    departmentOtherField.style.display = 'block';
                } else {
                    departmentOtherField.style.display = 'none';
                }

                // Revalidate form after changing fields
                updateRegisterButton();
            }

            // Form validation function - returns array of error messages
            function validateForm() {
                const errors = [];

                // Get all required fields
                const username = document.getElementById('id_username');
                const firstName = document.getElementById('id_first_name');
                const email = document.getElementById('id_email');
                const password1 = document.getElementById('id_password1');
                const password2 = document.getElementById('id_password2');
                const phoneNumber = document.getElementById('{{ profile_form.phone_number.id_for_label }}');
                const organization = document.getElementById('{{ profile_form.organization.id_for_label }}');
                const organizationOther = document.getElementById('{{ profile_form.organization_other.id_for_label }}');
                const department = document.getElementById('{{ profile_form.department.id_for_label }}');
                const departmentOther = document.getElementById('{{ profile_form.department_other.id_for_label }}');
                const securityQuestionCustom = document.getElementById('{{ profile_form.security_question_custom.id_for_label }}');
                const securityAnswer = document.getElementById('{{ profile_form.security_answer.id_for_label }}');

                // Check user form fields
                if (!username || !username.value.trim()) {
                    errors.push('Enter a username');
                }
                if (!firstName || !firstName.value.trim()) {
                    errors.push('Enter your first name');
                }
                if (!email || !email.value.trim()) {
                    errors.push('Enter your email address');
                }
                if (!password1 || !password1.value.trim()) {
                    errors.push('Enter a password');
                }
                if (!password2 || !password2.value.trim()) {
                    errors.push('Confirm your password');
                }

                // Check profile form fields
                if (!phoneNumber || !phoneNumber.value.trim()) {
                    errors.push('Enter your phone number');
                }
                if (!organization || !organization.value.trim()) {
                    errors.push('Select your organization');
                }

                // Check conditional fields based on organization selection
                const orgValue = organization ? organization.value : '';
                if (orgValue === 'other') {
                    if (!organizationOther || !organizationOther.value.trim()) {
                        errors.push('Enter your organization name');
                    }
                }

                // Require department for schools (uark, montana, vtech) but not for 'other'
                if (orgValue === 'uark' || orgValue === 'montana' || orgValue === 'vtech') {
                    if (!department || !department.value.trim()) {
                        errors.push('Select your department');
                    } else {
                        // Check if department is 'other' and requires department_other
                        const deptValue = department ? department.value : '';
                        if (deptValue === 'other') {
                            if (!departmentOther || !departmentOther.value.trim()) {
                                errors.push('Enter your department name');
                            }
                        }
                    }
                }

                // Check security question fields
                if (!securityQuestionCustom || !securityQuestionCustom.value.trim()) {
                    errors.push('Enter a security question');
                }
                if (!securityAnswer || !securityAnswer.value.trim()) {
                    errors.push('Enter a security answer');
                }

                return errors;
            }

            // Update register button and tooltip
            function updateRegisterButton() {
                const tooltip = document.getElementById('validationTooltip');
                const errors = validateForm();
                const isValid = errors.length === 0;

                // Update button state
                registerButton.disabled = !isValid;

                // Update tooltip
                if (errors.length > 0) {
                    const tooltipContent = '<ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                    tooltip.innerHTML = tooltipContent;
                    tooltip.style.display = '';  // Reset to default (CSS will control visibility)
                } else {
                    tooltip.innerHTML = '';
                    tooltip.style.display = 'none';  // Explicitly hide when valid
                }
            }

            // Add event listeners for validation
            organizationSelect.addEventListener('change', toggleOrganizationFields);
            departmentSelect.addEventListener('change', toggleDepartmentOtherField);

            // Add validation event listeners to all form inputs
            const formInputs = document.querySelectorAll('input, select, textarea');
            formInputs.forEach(function(input) {
                input.addEventListener('input', updateRegisterButton);
                input.addEventListener('change', updateRegisterButton);
            });

            // Initialize on page load
            toggleOrganizationFields();
            toggleDepartmentOtherField();
            updateRegisterButton();

            // Prevent double submission by disabling button on submit
            const registerForm = document.querySelector('form');
            registerForm.addEventListener('submit', function(e) {
                // Disable button and change text
                registerButton.disabled = true;
                registerButton.textContent = 'Registering...';
            });

            // Character counter functionality for profile fields
            setupCharacterCounter('{{ profile_form.organization_other.id_for_label }}', 'organizationOtherCharCount', 'organizationOtherError', 100);
            setupCharacterCounter('{{ profile_form.department_other.id_for_label }}', 'departmentOtherCharCount', 'departmentOtherError', 100);
            setupCharacterCounter('{{ profile_form.notes.id_for_label }}', 'notesCharCount', 'notesError', 500);
        });

        // Character counter setup function
        function setupCharacterCounter(fieldId, counterId, errorId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(counterId);
            const errorDiv = document.getElementById(errorId);

            if (!field || !counter || !errorDiv) return;

            function updateCounter() {
                let length = field.value.length;

                // Enforce max length
                if (length > maxLength) {
                    field.value = field.value.slice(0, maxLength);
                    length = maxLength;
                }

                const remaining = maxLength - length;

                // Display counter only when near the limit (25 or fewer characters remaining)
                if (remaining <= 25) {
                    counter.textContent = remaining + " characters remaining";
                    if (remaining <= 10) {
                        counter.style.color = "#e74c3c"; // danger red
                    } else {
                        counter.style.color = "#f39c12"; // warning orange
                    }
                } else {
                    counter.textContent = "";
                    counter.style.color = "#7f8c8d"; // normal gray
                }

                // Clear any error messages (no minimum required for these fields)
                errorDiv.style.display = "none";
            }

            // Initialize counter on page load
            updateCounter();

            // Update on input
            field.addEventListener("input", updateCounter);
            field.addEventListener("keyup", updateCounter);
        }
        </script>

        <div style="margin-top: 1.5rem;">
            <span class="submit-btn-wrapper">
                <button type="submit" class="btn" id="registerButton" disabled>Register</button>
                <div class="validation-tooltip" id="validationTooltip"></div>
            </span>
            <a href="{% url 'home' %}" class="btn btn-secondary" style="margin-left: 1rem;">Cancel</a>
        </div>
    </form>

    <p style="margin-top: 1.5rem;">
        Already have an account? <a href="{% url 'login' %}">Login here</a>
    </p>
</div>
{% endblock %}
