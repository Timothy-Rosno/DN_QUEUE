{% extends 'base.html' %}

{% block title %}Register - Scheduler App{% endblock %}

{% block content %}
<div class="card">
    <h1>Create Your Account</h1>
    <p style="margin: 1rem 0;">Please fill out the form below to register.</p>

    <form method="post">
        {% csrf_token %}

        <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Account Information</h3>
        {{ user_form.as_p }}

        <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Profile Information</h3>

        <!-- Phone Number Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ profile_form.phone_number.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.phone_number.label }}
            </label>
            {{ profile_form.phone_number }}
            {% if profile_form.phone_number.help_text %}
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">{{ profile_form.phone_number.help_text }}</small>
            {% endif %}
            {% if profile_form.phone_number.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.phone_number.errors }}</div>
            {% endif %}
        </div>

        <!-- Organization Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ profile_form.organization.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.organization.label }}
            </label>
            {{ profile_form.organization }}
            {% if profile_form.organization.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.organization.errors }}</div>
            {% endif %}
        </div>

        <!-- Organization Other Field (shown when "Other" is selected) -->
        <div id="organization-other-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ profile_form.organization_other.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.organization_other.label }}
            </label>
            {{ profile_form.organization_other }}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="organizationOtherError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="organizationOtherCharCount"></span></small>
            </div>
            {% if profile_form.organization_other.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.organization_other.errors }}</div>
            {% endif %}
        </div>

        <!-- Department Field (shown when University of Arkansas is selected) -->
        <div id="department-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ profile_form.department.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.department.label }}
            </label>
            {{ profile_form.department }}
            {% if profile_form.department.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.department.errors }}</div>
            {% endif %}
        </div>

        <!-- Department Other Field (shown when "Other" department is selected) -->
        <div id="department-other-field" style="margin-bottom: 1.5rem; display: none;">
            <label for="{{ profile_form.department_other.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.department_other.label }}
            </label>
            {{ profile_form.department_other }}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="departmentOtherError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="departmentOtherCharCount"></span></small>
            </div>
            {% if profile_form.department_other.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.department_other.errors }}</div>
            {% endif %}
        </div>

        <!-- Notes Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ profile_form.notes.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ profile_form.notes.label }}
            </label>
            {{ profile_form.notes }}
            {% if profile_form.notes.help_text %}
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">{{ profile_form.notes.help_text }}</small>
            {% endif %}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="notesError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="notesCharCount"></span></small>
            </div>
            {% if profile_form.notes.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ profile_form.notes.errors }}</div>
            {% endif %}
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 0.5rem;">Password Recovery</h3>
        <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.95rem;">Create a custom security question to recover your password if you forget it.</p>

        <!-- Hidden field for security_question (always set to 'custom' for new registrations) -->
        {{ profile_form.security_question }}

        <div style="margin-bottom: 1.5rem;">
            {{ profile_form.security_question_custom.label_tag }}
            {{ profile_form.security_question_custom }}
            {% if profile_form.security_question_custom.errors %}
                <small style="color: #e74c3c; display: block; margin-top: 0.5rem;">{{ profile_form.security_question_custom.errors.0 }}</small>
            {% endif %}
        </div>

        <div style="margin-bottom: 1.5rem;">
            {{ profile_form.security_answer.label_tag }}
            {{ profile_form.security_answer }}
            {% if profile_form.security_answer.help_text %}
                <small style="color: #7f8c8d; display: block; margin-top: 0.5rem;">{{ profile_form.security_answer.help_text }}</small>
            {% endif %}
        </div>

        <script>
        // Initialize character counters and conditional field displays on page load
        document.addEventListener('DOMContentLoaded', function() {
            const organizationSelect = document.getElementById('{{ profile_form.organization.id_for_label }}');
            const organizationOtherField = document.getElementById('organization-other-field');
            const departmentField = document.getElementById('department-field');
            const departmentSelect = document.getElementById('{{ profile_form.department.id_for_label }}');
            const departmentOtherField = document.getElementById('department-other-field');

            // Handle organization selection changes
            function toggleOrganizationFields() {
                const orgValue = organizationSelect.value;

                // Show/hide organization_other field
                if (orgValue === 'other') {
                    organizationOtherField.style.display = 'block';
                } else {
                    organizationOtherField.style.display = 'none';
                }

                // Show/hide department field (only for UArk)
                if (orgValue === 'uark') {
                    departmentField.style.display = 'block';
                } else {
                    departmentField.style.display = 'none';
                    // Reset department selection when hiding
                    departmentSelect.value = '';
                    departmentOtherField.style.display = 'none';
                }
            }

            // Handle department selection changes
            function toggleDepartmentOtherField() {
                const deptValue = departmentSelect.value;

                // Show/hide department_other field
                if (deptValue === 'other') {
                    departmentOtherField.style.display = 'block';
                } else {
                    departmentOtherField.style.display = 'none';
                }
            }

            // Add event listeners
            organizationSelect.addEventListener('change', toggleOrganizationFields);
            departmentSelect.addEventListener('change', toggleDepartmentOtherField);

            // Initialize on page load
            toggleOrganizationFields();
            toggleDepartmentOtherField();

            // Character counter functionality for profile fields
            setupCharacterCounter('{{ profile_form.organization_other.id_for_label }}', 'organizationOtherCharCount', 'organizationOtherError', 100);
            setupCharacterCounter('{{ profile_form.department_other.id_for_label }}', 'departmentOtherCharCount', 'departmentOtherError', 100);
            setupCharacterCounter('{{ profile_form.notes.id_for_label }}', 'notesCharCount', 'notesError', 500);
        });

        // Character counter setup function
        function setupCharacterCounter(fieldId, counterId, errorId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(counterId);
            const errorDiv = document.getElementById(errorId);

            if (!field || !counter || !errorDiv) return;

            function updateCounter() {
                let length = field.value.length;

                // Enforce max length
                if (length > maxLength) {
                    field.value = field.value.slice(0, maxLength);
                    length = maxLength;
                }

                const remaining = maxLength - length;

                // Display counter only when near the limit (25 or fewer characters remaining)
                if (remaining <= 25) {
                    counter.textContent = remaining + " characters remaining";
                    if (remaining <= 10) {
                        counter.style.color = "#e74c3c"; // danger red
                    } else {
                        counter.style.color = "#f39c12"; // warning orange
                    }
                } else {
                    counter.textContent = "";
                    counter.style.color = "#7f8c8d"; // normal gray
                }

                // Clear any error messages (no minimum required for these fields)
                errorDiv.style.display = "none";
            }

            // Initialize counter on page load
            updateCounter();

            // Update on input
            field.addEventListener("input", updateCounter);
            field.addEventListener("keyup", updateCounter);
        }
        </script>

        <div style="margin-top: 1.5rem;">
            <button type="submit" class="btn">Register</button>
            <a href="{% url 'home' %}" class="btn btn-secondary" style="margin-left: 1rem;">Cancel</a>
        </div>
    </form>

    <p style="margin-top: 1.5rem;">
        Already have an account? <a href="{% url 'login' %}">Login here</a>
    </p>
</div>
{% endblock %}
