{% extends 'base.html' %}

{% block title %}Profile - Scheduler App{% endblock %}

{% block content %}
<div class="card">
    <h1>Your Profile</h1>

    <div style="margin: 1.5rem 0; padding: 1rem; background-color: #ecf0f1; border-radius: 4px;">
        <p><strong>Username:</strong> {{ user.username }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        <p><strong>Name:</strong> {{ user.first_name }} {{ user.last_name }}</p>
    </div>

    <h2 style="margin-top: 2rem;">Update Profile Information</h2>
    <form method="post" style="margin-top: 1rem;" id="profileForm">
        {% csrf_token %}

        <!-- Phone Number Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.phone_number.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.phone_number.label }}
            </label>
            {{ form.phone_number }}
            {% if form.phone_number.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.phone_number.errors }}</div>
            {% endif %}
        </div>

        <!-- Department Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.department.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.department.label }}
            </label>
            {{ form.department }}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="departmentError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="departmentCharCount"></span></small>
            </div>
            {% if form.department.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.department.errors }}</div>
            {% endif %}
        </div>

        <!-- Notes Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.notes.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                {{ form.notes.label }}
            </label>
            {{ form.notes }}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <div id="notesError" style="color: #e74c3c; font-size: 0.9rem; display: none; font-weight: bold;"></div>
                <small style="color: #7f8c8d;"><span id="notesCharCount"></span></small>
            </div>
            {% if form.notes.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.notes.errors }}</div>
            {% endif %}
        </div>

        <!-- Slack Member ID Field -->
        <div style="margin-bottom: 1.5rem;">
            <label for="{{ form.slack_member_id.id_for_label }}" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">
                Slack Member ID
            </label>
            {{ form.slack_member_id }}
            <small style="display: block; color: #7f8c8d; margin-top: 0.25rem;">
                Optional - Leave blank to automatically lookup your Slack account by email/name.
                Get your Member ID: Right-click your message ‚Üí Copy link ‚Üí ID after /team/
            </small>
            {% if form.slack_member_id.errors %}
                <div style="color: #e74c3c; margin-top: 0.25rem;">{{ form.slack_member_id.errors }}</div>
            {% endif %}
        </div>

        <div style="margin-top: 1.5rem;">
            <button type="submit" name="submit_profile" class="btn">Update Profile</button>
            <a href="{% url 'schedule' %}" class="btn btn-secondary" style="margin-left: 1rem;">Back to Schedule</a>
        </div>
    </form>
</div>



{% if user.profile.security_question %}
<div class="card" style="margin-top: 2rem;">
    <h1>Security Question</h1>
    <div style="margin: 1.5rem 0; padding: 1rem; background-color: #ecf0f1; border-radius: 4px;">
        <p><strong>Your Security Question:</strong></p>
        <p style="color: #7f8c8d; margin-top: 0.5rem;">
            {% if user.profile.security_question == 'custom' %}
                {{ user.profile.security_question_custom }}
            {% else %}
                {{ user.profile.get_security_question_display }}
            {% endif %}
        </p>
    </div>
    <p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 1rem;">
        Your security question is used for account recovery.
        <a href="{% url 'change_security_question' %}" style="color: #3498db;">Change Security Question</a>
    </p>
</div>
{% endif %}

<div class="card" id="notification-preferences" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
        <div>
            <h1 style="margin: 0;">Notification Preferences</h1>

        </div>
        <button type="button" onclick="showResetModal()" class="btn" style="background-color: #e67e22;">
            Reset to Defaults
        </button>
    </div>
    <p style="color: #7f8c8d; margin-bottom: 2rem;">
        Control which notifications you receive about presets, queue changes, and job status updates.
        <strong>Note:</strong> Critical notifications (ON DECK, Ready for Check-In, Time for Check-Out) are required and cannot be disabled.
    </p>

    <!-- Success message container -->
    <div id="unfollowSuccessMessage" style="display: none; background-color: #d4edda; color: #155724; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; border-left: 4px solid #28a745;">
        <strong>Success!</strong> <span id="unfollowSuccessText"></span>
    </div>

    <form method="post" style="max-width: 800px;" onsubmit="sessionStorage.setItem('profileScrollPosition', window.scrollY);">
        {% csrf_token %}

        {% if notification_form.errors %}
        <div style="background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; border-left: 4px solid #e74c3c;">
            <strong>Please correct the following errors:</strong>
            <ul style="margin: 0.5rem 0 0 1.5rem;">
                {% for field, errors in notification_form.errors.items %}
                    {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Queue Notifications Section -->
        <h2 style="margin-top: 2rem; margin-bottom: 1rem; color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem;">
            Queue Notifications
        </h2>
        <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin-bottom: 1.5rem;">
            {% for field in notification_form %}
                {% if field.name in 'notify_queue_position_change,notify_on_deck,notify_ready_for_check_in,notify_checkout_reminder' %}
                    <div style="margin-bottom: {% if not forloop.last %}1.5rem{% else %}0{% endif %}; padding: 1rem; background-color: white; border-radius: 4px; border-left: 4px solid {% if field.name == 'notify_on_deck' or field.name == 'notify_ready_for_check_in' or field.name == 'notify_checkout_reminder' %}#e74c3c{% else %}#3498db{% endif %};">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="padding-top: 0.25rem;">
                                {{ field }}
                            </div>
                            <div style="flex: 1;">
                                <label for="{{ field.id_for_label }}" style="font-weight: bold; color: #2c3e50; margin-bottom: 0.25rem; display: block;">
                                    {{ field.label }}
                                </label>
                                {% if field.help_text %}
                                <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">{{ field.help_text }}</p>
                                {% endif %}
                                {% if field.errors %}
                                <p style="color: #e74c3c; margin-top: 0.5rem;">{{ field.errors }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Preset Notifications Section -->
        <h2 style="margin-top: 2rem; margin-bottom: 1rem; color: #9b59b6; border-bottom: 2px solid #9b59b6; padding-bottom: 0.5rem;">
            Preset Notifications
        </h2>
        
        <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin-bottom: 1.5rem;">
            {% for field in notification_form %}
                {% if field.name in 'notify_public_preset_created,notify_public_preset_edited,notify_public_preset_deleted,notify_private_preset_edited,notify_followed_preset_edited,notify_followed_preset_deleted' %}
                    <div style="margin-bottom: {% if followed_presets or not forloop.last %}1.5rem{% else %}0{% endif %}; padding: 1rem; background-color: white; border-radius: 4px; border-left: 4px solid #9b59b6;">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="padding-top: 0.25rem;">
                                {{ field }}
                            </div>
                            <div style="flex: 1;">
                                <label for="{{ field.id_for_label }}" style="font-weight: bold; color: #2c3e50; margin-bottom: 0.25rem; display: block;">
                                    {{ field.label }}
                                </label>
                                {% if field.help_text %}
                                <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">{{ field.help_text }}</p>
                                {% endif %}
                                {% if field.errors %}
                                <p style="color: #e74c3c; margin-top: 0.5rem;">{{ field.errors }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}

            {% if followed_presets %}
                <div style="margin-top: 1.5rem; padding: 1rem; background-color: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px;">
                    <h4 style="margin-top: 0; margin-bottom: 0.75rem; font-size: 1rem; color: #2c3e50;">Your Followed Presets ({{ followed_presets|length }})</h4>
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        {% for preset in followed_presets %}
                            <li style="margin-bottom: 0.5rem;">
                                <a href="{% url 'submit_queue' %}?preset={{ preset.id }}" style="color: #3498db; text-decoration: none;">{{ preset.display_name }}</a>
                                <button type="button" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 0.85rem; text-decoration: underline; margin-left: 0.5rem;" onclick="unfollowPreset({{ preset.id }}, '{{ preset.display_name|escapejs }}')">Unfollow</button>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <p style="color: #7f8c8d; font-size: 0.9rem; font-style: italic; margin-top: 1rem;">You're not following any presets yet. Use the "Follow This Preset" button when viewing a public preset to get notified of changes.</p>
            {% endif %}
        </div>

        <!-- Machine Queue Notifications Section -->
        <h2 style="margin-top: 2rem; margin-bottom: 1rem; color: #16a085; border-bottom: 2px solid #16a085; padding-bottom: 0.5rem;">
            Machine Queue Notifications
        </h2>
        <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin-bottom: 1.5rem;">
            {% for field in notification_form %}
                {% if field.name == 'notify_machine_queue_changes' %}
                    <div style="margin-bottom: 0; padding: 1rem; background-color: white; border-radius: 4px; border-left: 4px solid #16a085;">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="padding-top: 0.25rem;">
                                {{ field }}
                            </div>
                            <div style="flex: 1;">
                                <label for="{{ field.id_for_label }}" style="font-weight: bold; color: #2c3e50; margin-bottom: 0.25rem; display: block;">
                                    {{ field.label }}
                                </label>
                                {% if field.help_text %}
                                <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">{{ field.help_text }}</p>
                                {% endif %}
                                {% if field.errors %}
                                <p style="color: #e74c3c; margin-top: 0.5rem;">{{ field.errors }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Delivery Preferences Section -->
        <h2 style="margin-top: 2rem; margin-bottom: 1rem; color: #e67e22; border-bottom: 2px solid #e67e22; padding-bottom: 0.5rem;">
            Delivery Preferences
        </h2>
        <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin-bottom: 1.5rem;">
            {% for field in notification_form %}
                {% if field.name in 'email_notifications,in_app_notifications' %}
                    <div style="margin-bottom: {% if not forloop.last %}1.5rem{% else %}0{% endif %}; padding: 1rem; background-color: white; border-radius: 4px; border-left: 4px solid #e67e22;">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="padding-top: 0.25rem;">
                                {{ field }}
                            </div>
                            <div style="flex: 1;">
                                <label for="{{ field.id_for_label }}" style="font-weight: bold; color: #2c3e50; margin-bottom: 0.25rem; display: block;">
                                    {{ field.label }}
                                </label>
                                {% if field.help_text %}
                                <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">{{ field.help_text }}</p>
                                {% endif %}
                                {% if field.errors %}
                                <p style="color: #e74c3c; margin-top: 0.5rem;">{{ field.errors }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        {% if user.is_staff or user.is_superuser %}
        <!-- Admin Settings Section -->
        <h2 style="margin-top: 2rem; margin-bottom: 1rem; color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 0.5rem;">
            üëëüëëüëë Admin Settings üëëüëëüëë
        </h2>
        <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 4px; margin-bottom: 1.5rem;">
            <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.9rem;">Administrative notifications for staff and superusers</p>

            {% for field in notification_form %}
                {% if field.name in 'notify_admin_new_user,notify_admin_rush_job' %}
                    <div style="margin-bottom: {% if not forloop.last %}1.5rem{% else %}0{% endif %}; padding: 1rem; background-color: white; border-radius: 4px; border-left: 4px solid #e74c3c;">
                        <div style="display: flex; align-items: start; gap: 1rem;">
                            <div style="padding-top: 0.25rem;">
                                {{ field }}
                            </div>
                            <div style="flex: 1;">
                                <label for="{{ field.id_for_label }}" style="font-weight: bold; color: #2c3e50; margin-bottom: 0.25rem; display: block;">
                                    {{ field.label }}
                                </label>
                                {% if field.help_text %}
                                <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">{{ field.help_text }}</p>
                                {% endif %}
                                {% if field.errors %}
                                <p style="color: #e74c3c; margin-top: 0.5rem;">{{ field.errors }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Submit Button -->
        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #ecf0f1;">
            <button type="submit" name="submit_notifications" class="btn" style="background-color: #27ae60; padding: 0.75rem 2rem; font-size: 1.1rem;">
                Save Notification Preferences
            </button>
        </div>
    </form>

    <div style="margin-top: 2rem; padding: 1rem; background-color: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #2c3e50;">Important Notes</h3>
        <ul style="margin-bottom: 0; color: #34495e;">
            <li><strong>Critical notifications are required</strong> and cannot be disabled: ON DECK, Ready for Check-In, and Time for Check-Out.</li>
            <li>Disabling in-app notifications will hide all notification popups in the web interface.</li>
            <li>Email notifications are not yet implemented but will use these preferences when enabled.</li>
            <li>Changes take effect immediately after saving.</li>
        </ul>
    </div>
</div>

<div style="margin-top: 1rem;">
    <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Back to Home</a>
</div>

<!-- Reset Confirmation Modal -->
<div id="resetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0; color: #e67e22;">Reset Notification Preferences?</h2>
        <p style="color: #555;">
            This will reset all your notification preferences to the default values based on your user role.
            This action cannot be undone, but you can adjust the settings again after resetting.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button type="button" onclick="hideResetModal()" class="btn" style="background-color: #95a5a6;">
                Cancel
            </button>
            <button type="button" onclick="confirmReset()" class="btn" style="background-color: #e67e22;">
                Reset to Defaults
            </button>
        </div>
    </div>
</div>

<!-- Unfollow Confirmation Modal -->
<div id="unfollowModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0; color: #e74c3c;">Unfollow Preset?</h2>
        <p style="color: #555;" id="unfollowModalText">
            Are you sure you want to unfollow this preset? You will no longer receive notifications about changes to it.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button type="button" onclick="hideUnfollowModal()" class="btn" style="background-color: #95a5a6;">
                Cancel
            </button>
            <button type="button" onclick="confirmUnfollow()" class="btn" style="background-color: #e74c3c;">
                Unfollow
            </button>
        </div>
    </div>
</div>

<script>
function showResetModal() {
    document.getElementById('resetModal').style.display = 'flex';
}

function hideResetModal() {
    document.getElementById('resetModal').style.display = 'none';
}

function confirmReset() {
    fetch("{% url 'reset_notification_preferences' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideResetModal();
            // Save scroll position before reload
            sessionStorage.setItem('profileScrollPosition', window.scrollY);
            location.reload();
        } else {
            alert('Error resetting preferences: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error resetting preferences. Please try again.');
    });
}

let pendingUnfollowId = null;
let pendingUnfollowName = null;

function unfollowPreset(presetId, presetName) {
    pendingUnfollowId = presetId;
    pendingUnfollowName = presetName;
    document.getElementById('unfollowModalText').textContent =
        'Are you sure you want to unfollow "' + presetName + '"? You will no longer receive notifications about changes to it.';
    document.getElementById('unfollowModal').style.display = 'flex';
}

function hideUnfollowModal() {
    document.getElementById('unfollowModal').style.display = 'none';
    pendingUnfollowId = null;
    pendingUnfollowName = null;
}

function confirmUnfollow() {
    if (!pendingUnfollowId) return;

    fetch('/schedule/preset/' + pendingUnfollowId + '/unfollow/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            // Store success message in sessionStorage
            sessionStorage.setItem('unfollowSuccess', pendingUnfollowName);
            window.location.reload();
        } else {
            alert('Error unfollowing preset. Please try again.');
            hideUnfollowModal();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error unfollowing preset. Please try again.');
        hideUnfollowModal();
    });
}

// Close modals when clicking outside
document.getElementById('resetModal').addEventListener('click', function(event) {
    if (event.target === this) {
        hideResetModal();
    }
});

document.getElementById('unfollowModal').addEventListener('click', function(event) {
    if (event.target === this) {
        hideUnfollowModal();
    }
});

// Check for unfollow success message on page load
document.addEventListener('DOMContentLoaded', function() {
    const unfollowSuccess = sessionStorage.getItem('unfollowSuccess');
    if (unfollowSuccess) {
        sessionStorage.removeItem('unfollowSuccess');
        const messageDiv = document.getElementById('unfollowSuccessMessage');
        const messageText = document.getElementById('unfollowSuccessText');
        messageText.textContent = 'You have unfollowed "' + unfollowSuccess + '".';
        messageDiv.style.display = 'block';

        // Auto-hide after 5 seconds
        setTimeout(function() {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    // Check if we should scroll to notification preferences (from Settings button)
    const scrollToNotifications = sessionStorage.getItem('scrollToNotificationPreferences');
    if (scrollToNotifications) {
        sessionStorage.removeItem('scrollToNotificationPreferences');
        const notificationSection = document.getElementById('notification-preferences');
        if (notificationSection) {
            setTimeout(function() {
                notificationSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    } else {
        // Restore scroll position after reset/save (only if not navigating from Settings button)
        const scrollPosition = sessionStorage.getItem('profileScrollPosition');
        if (scrollPosition) {
            sessionStorage.removeItem('profileScrollPosition');
            window.scrollTo(0, parseInt(scrollPosition));
        }
    }

    // Character counter functionality for profile fields
    setupCharacterCounter('{{ form.department.id_for_label }}', 'departmentCharCount', 'departmentError', 100);
    setupCharacterCounter('{{ form.notes.id_for_label }}', 'notesCharCount', 'notesError', 500);
});

// Character counter setup function
function setupCharacterCounter(fieldId, counterId, errorId, maxLength) {
    const field = document.getElementById(fieldId);
    const counter = document.getElementById(counterId);
    const errorDiv = document.getElementById(errorId);

    if (!field || !counter || !errorDiv) return;

    function updateCounter() {
        let length = field.value.length;

        // Enforce max length
        if (length > maxLength) {
            field.value = field.value.slice(0, maxLength);
            length = maxLength;
        }

        const remaining = maxLength - length;

        // Display counter only when near the limit (25 or fewer characters remaining)
        if (remaining <= 25) {
            counter.textContent = remaining + " characters remaining";
            if (remaining <= 10) {
                counter.style.color = "#e74c3c"; // danger red
            } else {
                counter.style.color = "#f39c12"; // warning orange
            }
        } else {
            counter.textContent = "";
            counter.style.color = "#7f8c8d"; // normal gray
        }

        // Clear any error messages (no minimum required for these fields)
        errorDiv.style.display = "none";
    }

    // Initialize counter on page load
    updateCounter();

    // Update on input
    field.addEventListener("input", updateCounter);
    field.addEventListener("keyup", updateCounter);
}
</script>
{% endblock %}
