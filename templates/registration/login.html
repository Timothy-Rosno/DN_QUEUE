{% extends 'base.html' %}

{% block title %}Login - Scheduler App{% endblock %}

{% block content %}
<div class="card">
    <h1>Login</h1>
    <p style="margin: 1rem 0;">Please enter your credentials to login.</p>

    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}

        <div style="margin-top: 1rem; margin-bottom: 1rem;">
            <label for="remember_me" id="remember-label" style="display: inline-flex; align-items: center; cursor: pointer; padding: 8px; margin: -8px;">
                <input type="checkbox" name="remember_me" id="remember_me" style="margin-right: 0.5rem; width: auto; cursor: pointer;">
                <span style="font-weight: bold;">Remember Me...</span>
            </label>
                <div id="remember-tooltip"
                    style="
                        display: none;
                        position: absolute;
                        background-color: #2c3e50;
                        color: white;
                        padding: 0.5rem;
                        border-radius: 4px;
                        font-size: 0.85rem;
                        white-space: normal;
                        max-width: 360px;
                        line-height: 1.4;
                        z-index: 1000;
                        pointer-events: none;
                    ">
                    though I have to say goodbye<br>
                    Remember me, don't let it make you cry<br>
                    For even if I'm far away, I hold you in my heart<br>
                    I sing a secret song to you each night we are apart.<br>
                    Remember me, though I have to travel far<br>
                    Remember me each time you hear a sad guitar<br>
                    Know that I'm with you the only way that I can be<br>
                    Until you're in my arms again, remember me<br>
                    <br>
                    Stay logged in on this device (Leave unchecked if shared)
                </div>
        </div>

        <div style="margin-top: 1.5rem;">
            <button type="submit" class="btn">Login</button>
            <a href="{% url 'home' %}" class="btn btn-secondary" style="margin-left: 1rem;">Cancel</a>
        </div>
    </form>

    <p style="margin-top: 1.5rem;">
        <a href="{% url 'forgot_password' %}">Forgot your password?</a> |
        <a href="{% url 'recover_username' %}">Forgot your username?</a>
    </p>

    <p style="margin-top: 0.5rem;">
        Don't have an account? <a href="{% url 'register' %}">Register here</a>
    </p>
</div>

<style>
    /* Make checkbox cursor pointer */
    input[type="checkbox"] {
        cursor: pointer !important;
    }
    label:has(input[type="checkbox"]) {
        cursor: pointer !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const label = document.getElementById('remember-label');
    const tooltip = document.getElementById('remember-tooltip');
    const card = document.querySelector('.card');
    const form = document.querySelector('form');
    const loginButton = form.querySelector('button[type="submit"]');
    let showTimeout = null;
    let mouseX = 0;
    let mouseY = 0;

    // Remember Me tooltip
    label.addEventListener('mouseenter', function(e) {
        mouseX = e.clientX;
        mouseY = e.clientY;
        showTimeout = setTimeout(function() {
            positionTooltip();
            tooltip.style.display = 'block';
        }, 100);
    });

    label.addEventListener('mousemove', function(e) {
        mouseX = e.clientX;
        mouseY = e.clientY;
        if (tooltip.style.display === 'block') {
            positionTooltip();
        }
    });

    label.addEventListener('mouseleave', function() {
        if (showTimeout) {
            clearTimeout(showTimeout);
            showTimeout = null;
        }
        tooltip.style.display = 'none';
    });

    function positionTooltip() {
        const cardRect = card.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();

        // Position tooltip near cursor with offset
        let left = mouseX + 10;
        let top = mouseY + 15;

        // Keep within container horizontally
        if (left + tooltipRect.width > cardRect.right) {
            left = cardRect.right - tooltipRect.width - 5;
        }
        if (left < cardRect.left) {
            left = cardRect.left + 5;
        }

        // Keep within container vertically
        if (top + tooltipRect.height > cardRect.bottom) {
            top = mouseY - tooltipRect.height - 10;
        }
        if (top < cardRect.top) {
            top = cardRect.top + 5;
        }

        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
    }

    // Login form validation
    const usernameInput = form.querySelector('input[name="username"]');
    const passwordInput = form.querySelector('input[name="password"]');

    // Create validation tooltip
    const validationTooltip = document.createElement('div');
    validationTooltip.id = 'login-validation-tooltip';
    validationTooltip.style.cssText = 'display: none; position: fixed; background-color: #e74c3c; color: white; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; z-index: 10000; max-width: 300px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);';
    document.body.appendChild(validationTooltip);

    function checkFormValidity() {
        const usernameEmpty = !usernameInput || !usernameInput.value.trim();
        const passwordEmpty = !passwordInput || !passwordInput.value.trim();

        if (usernameEmpty && passwordEmpty) {
            return 'Please enter both username and password';
        } else if (usernameEmpty) {
            return 'Please enter your username';
        } else if (passwordEmpty) {
            return 'Please enter your password';
        }
        return null; // Valid
    }

    function showValidationTooltip(message) {
        validationTooltip.textContent = message;

        // Position below the login button
        const buttonRect = loginButton.getBoundingClientRect();
        validationTooltip.style.left = buttonRect.left + 'px';
        validationTooltip.style.top = (buttonRect.bottom + 10) + 'px';
        validationTooltip.style.display = 'block';
    }

    function hideValidationTooltip() {
        validationTooltip.style.display = 'none';
    }

    // Check on input to hide tooltip when both fields are filled
    if (usernameInput) {
        usernameInput.addEventListener('input', function() {
            if (!checkFormValidity()) {
                hideValidationTooltip();
            }
        });
    }
    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            if (!checkFormValidity()) {
                hideValidationTooltip();
            }
        });
    }

    // Validate on form submit
    form.addEventListener('submit', function(e) {
        const error = checkFormValidity();
        if (error) {
            e.preventDefault();
            showValidationTooltip(error);
            return false;
        }
        hideValidationTooltip();
    });
});
</script>
{% endblock %}
