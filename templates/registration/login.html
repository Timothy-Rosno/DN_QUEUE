{% extends 'base.html' %}

{% block title %}Login - Scheduler App{% endblock %}

{% block content %}
<div class="card">
    <h1>Login</h1>
    <p style="margin: 1rem 0;">Please enter your credentials to login.</p>

    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}

        <div style="margin-top: 1rem; margin-bottom: 1rem;">
            <label for="remember_me" id="remember-label" style="display: inline-flex; align-items: center; cursor: pointer; padding: 8px; margin: -8px;">
                <input type="checkbox" name="remember_me" id="remember_me" style="margin-right: 0.5rem; width: auto; cursor: pointer;">
                <span style="font-weight: bold;">Remember Me...</span>
            </label>
                <div id="remember-tooltip"
                    style="
                        display: none;
                        position: absolute;
                        background-color: #2c3e50;
                        color: white;
                        padding: 0.5rem;
                        border-radius: 4px;
                        font-size: 0.85rem;
                        white-space: normal;
                        max-width: 360px;
                        line-height: 1.4;
                        z-index: 1000;
                        pointer-events: none;
                    ">
                    though I have to say goodbye<br>
                    Remember me, don't let it make you cry<br>
                    For even if I'm far away, I hold you in my heart<br>
                    I sing a secret song to you each night we are apart.<br>
                    Remember me, though I have to travel far<br>
                    Remember me each time you hear a sad guitar<br>
                    Know that I'm with you the only way that I can be<br>
                    Until you're in my arms again, remember me<br>
                    <br>
                    Stay logged in on this device (Leave unchecked if shared)
                </div>
        </div>

        <div style="margin-top: 1.5rem;">
            <span class="submit-btn-wrapper">
                <button type="submit" class="btn" id="loginBtn" disabled>Login</button>
                <div class="validation-tooltip" id="loginValidationTooltip"></div>
            </span>
            <a href="{% url 'home' %}" class="btn btn-secondary" style="margin-left: 1rem;">Cancel</a>
        </div>
    </form>

    <p style="margin-top: 1.5rem;">
        <a href="{% url 'forgot_password' %}">Forgot your password?</a> |
        <a href="{% url 'recover_username' %}">Forgot your username?</a>
    </p>

    <p style="margin-top: 0.5rem;">
        Don't have an account? <a href="{% url 'register' %}">Register here</a>
    </p>
</div>

<style>
    /* Make checkbox cursor pointer */
    input[type="checkbox"] {
        cursor: pointer !important;
    }
    label:has(input[type="checkbox"]) {
        cursor: pointer !important;
    }

    /* Disabled submit button styles - grayed out blue */
    .btn:disabled, .btn.btn-disabled {
        background-color: #7fb3d3 !important;
        cursor: not-allowed !important;
        opacity: 0.8;
    }

    /* Submit button tooltip container */
    .submit-btn-wrapper {
        position: relative;
        display: inline-block;
    }

    /* Validation tooltip */
    .validation-tooltip {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 0;
        background-color: #2c3e50;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        font-size: 0.85rem;
        max-width: 300px;
        width: max-content;
        z-index: 1000;
        margin-bottom: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .validation-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 20px;
        border-width: 6px;
        border-style: solid;
        border-color: #2c3e50 transparent transparent transparent;
    }

    .validation-tooltip ul {
        margin: 0;
        padding: 0 0 0 1rem;
        list-style: disc;
    }

    .validation-tooltip li {
        margin: 0.25rem 0;
        word-wrap: break-word;
    }

    /* Only show tooltip when hovering AND button is disabled */
    .submit-btn-wrapper:hover .btn:disabled + .validation-tooltip {
        display: block;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const label = document.getElementById('remember-label');
    const tooltip = document.getElementById('remember-tooltip');
    const card = document.querySelector('.card');
    const form = document.querySelector('form');
    let showTimeout = null;
    let mouseX = 0;
    let mouseY = 0;

    // Remember Me tooltip
    label.addEventListener('mouseenter', function(e) {
        mouseX = e.clientX;
        mouseY = e.clientY;
        showTimeout = setTimeout(function() {
            positionTooltip();
            tooltip.style.display = 'block';
        }, 100);
    });

    label.addEventListener('mousemove', function(e) {
        mouseX = e.clientX;
        mouseY = e.clientY;
        if (tooltip.style.display === 'block') {
            positionTooltip();
        }
    });

    label.addEventListener('mouseleave', function() {
        if (showTimeout) {
            clearTimeout(showTimeout);
            showTimeout = null;
        }
        tooltip.style.display = 'none';
    });

    function positionTooltip() {
        const cardRect = card.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();

        // Position tooltip near cursor with offset
        let left = mouseX + 10;
        let top = mouseY + 15;

        // Keep within container horizontally
        if (left + tooltipRect.width > cardRect.right) {
            left = cardRect.right - tooltipRect.width - 5;
        }
        if (left < cardRect.left) {
            left = cardRect.left + 5;
        }

        // Keep within container vertically
        if (top + tooltipRect.height > cardRect.bottom) {
            top = mouseY - tooltipRect.height - 10;
        }
        if (top < cardRect.top) {
            top = cardRect.top + 5;
        }

        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
    }

    // ===============================
    // Login Form Validation (Same structure as /submit)
    // ===============================
    (function() {
        const usernameInput = form.querySelector('input[name="username"]');
        const passwordInput = form.querySelector('input[name="password"]');
        const loginBtn = document.getElementById('loginBtn');
        const validationTooltip = document.getElementById('loginValidationTooltip');

        function validateForm() {
            const errors = [];

            // Username validation
            const usernameValue = usernameInput ? usernameInput.value.trim() : '';
            if (!usernameValue) {
                errors.push('Enter a username');
            }

            // Password validation
            const passwordValue = passwordInput ? passwordInput.value.trim() : '';
            if (!passwordValue) {
                errors.push('Enter a password');
            }

            return errors;
        }

        function updateSubmitButton() {
            const errors = validateForm();
            const isValid = errors.length === 0;

            // Update button state
            loginBtn.disabled = !isValid;

            // Update tooltip
            if (errors.length > 0) {
                const tooltipContent = '<ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                validationTooltip.innerHTML = tooltipContent;
                validationTooltip.style.display = '';  // Reset to default (CSS will control visibility)
            } else {
                validationTooltip.innerHTML = '';
                validationTooltip.style.display = 'none';  // Explicitly hide when valid
            }
        }

        // Add event listeners for real-time validation
        if (usernameInput) {
            usernameInput.addEventListener('input', updateSubmitButton);
            usernameInput.addEventListener('blur', updateSubmitButton);
        }
        if (passwordInput) {
            passwordInput.addEventListener('input', updateSubmitButton);
            passwordInput.addEventListener('blur', updateSubmitButton);
        }

        // Initial validation on page load
        updateSubmitButton();
    })();
});
</script>
{% endblock %}
